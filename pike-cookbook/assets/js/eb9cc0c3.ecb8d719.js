"use strict";(self.webpackChunkpike_cookbook=self.webpackChunkpike_cookbook||[]).push([[149],{2209(e,n,t){t.r(n),t.d(n,{assets:()=>l,contentTitle:()=>o,default:()=>p,frontMatter:()=>s,metadata:()=>r,toc:()=>c});const r=JSON.parse('{"id":"network/web-automation","title":"Web Automation","description":"Introduction","source":"@site/docs/network/web-automation.md","sourceDirName":"network","slug":"/network/web-automation","permalink":"/pike-cookbook/docs/network/web-automation","draft":false,"unlisted":false,"editUrl":"https://github.com/smuks/pike-cookbook/tree/main/docs/network/web-automation.md","tags":[],"version":"current","frontMatter":{"id":"web-automation","title":"Web Automation","sidebar_label":"Web Automation"},"sidebar":"tutorialSidebar","previous":{"title":"Sockets","permalink":"/pike-cookbook/docs/network/sockets"},"next":{"title":"Internet Services","permalink":"/pike-cookbook/docs/network/internet-services"}}');var a=t(4848),i=t(8453);const s={id:"web-automation",title:"Web Automation",sidebar_label:"Web Automation"},o="20. Web Automation",l={},c=[{value:"Introduction",id:"introduction",level:2},{value:"Fetching a URL",id:"fetching-a-url",level:2},{value:"Automating Form Submission",id:"automating-form-submission",level:2},{value:"Extracting URLs",id:"extracting-urls",level:2},{value:"HTML Parsing with Standards.XML",id:"html-parsing-with-standardsxml",level:2},{value:"Converting ASCII to HTML",id:"converting-ascii-to-html",level:2},{value:"Converting HTML to ASCII",id:"converting-html-to-ascii",level:2},{value:"Session Management and Cookies",id:"session-management-and-cookies",level:2},{value:"Authentication",id:"authentication",level:2},{value:"REST API Client",id:"rest-api-client",level:2},{value:"Webhook Handler",id:"webhook-handler",level:2},{value:"Rate Limiting",id:"rate-limiting",level:2},{value:"Creating a Web Crawler",id:"creating-a-web-crawler",level:2},{value:"Handling JavaScript-Heavy Sites",id:"handling-javascript-heavy-sites",level:2},{value:"Program: Web Scraper",id:"program-web-scraper",level:2}];function d(e){const n={code:"code",h1:"h1",h2:"h2",header:"header",p:"p",pre:"pre",...(0,i.R)(),...e.components};return(0,a.jsxs)(a.Fragment,{children:[(0,a.jsx)(n.header,{children:(0,a.jsx)(n.h1,{id:"20-web-automation",children:"20. Web Automation"})}),"\n",(0,a.jsx)(n.h2,{id:"introduction",children:"Introduction"}),"\n",(0,a.jsx)(n.p,{children:"Web automation in Pike 8 involves HTTP requests, HTML parsing, form submission, session management, and building web crawlers. This chapter covers practical recipes for automating web interactions using modern Pike features."}),"\n",(0,a.jsx)(n.p,{children:"Key modules used:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:"// Web automation modules in Pike 8\nProtocols.HTTP      // HTTP client and server\nStandards.XML        // XML/HTML parsing\nStandards.JSON       // JSON encoding/decoding\nConcurrent.Future    // Async operations\nProtocols.HTTP.Query // HTTP query object\nMIME.encode_base64    // Base64 encoding\nCrypto.SHA256        // Cryptographic functions\n"})}),"\n",(0,a.jsx)(n.h2,{id:"fetching-a-url",children:"Fetching a URL"}),"\n",(0,a.jsx)(n.p,{children:"Simple GET request with Protocols.HTTP:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Basic HTTP GET request\nProtocols.HTTP.Query q = Protocols.HTTP.get_url("https://example.com");\n\nif (q->status == 200) {\n    write("Success: %d bytes\\n", sizeof(q->data()));\n    write("Content-Type: %s\\n", q->headers["content-type"]);\n    write(q->data());  // Page content\n} else {\n    werror("HTTP Error: %d %s\\n", q->status, q->status_desc);\n}\n\n// With custom headers\nmapping headers = ([\n    "User-Agent": "PikeBot/1.0",\n    "Accept": "application/json"\n]);\n\nq = Protocols.HTTP.get_url("https://api.example.com/data", headers);\n'})}),"\n",(0,a.jsx)(n.p,{children:"Async HTTP requests with Future/Promise:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Async HTTP GET with callback\nProtocols.HTTP.Query q = Protocols.HTTP.Query();\nq->set_callbacks(\n    lambda() { werror("Connection failed\\n"); },\n    lambda(Protocols.HTTP.Query r) {\n        write("Got %d bytes\\n", sizeof(r->data()));\n    }\n);\nq->async_request("https://example.com", "GET", ([]));\n\n// Using Concurrent.Future\nConcurrent.Promise p = Concurrent.Promise();\nq->set_callbacks(\n    lambda() { p->fail("Failed"); },\n    lambda(Protocols.HTTP.Query r) {\n        p->success(r->data());\n    }\n);\n'})}),"\n",(0,a.jsx)(n.h2,{id:"automating-form-submission",children:"Automating Form Submission"}),"\n",(0,a.jsx)(n.p,{children:"POST form data:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// GET form submission\nmapping form_data = ([\n    "name": "John Doe",\n    "email": "john@example.com",\n    "category": "general"\n]);\n\n// Build query string\narray(string) params = map(indices(form_data), lambda(string key) {\n    return Protocols.HTTP.uri_encode(key) + "=" +\n           Protocols.HTTP.uri_encode(form_data[key]);\n});\nstring query_string = params * "&";\nstring url = "https://example.com/search?" + query_string;\n\n// POST form submission\nProtocols.HTTP.Query q = Protocols.HTTP.post_url(\n    "https://example.com/submit",\n    form_data,\n    ([\n        "Content-Type": "application/x-www-form-urlencoded",\n        "User-Agent": "Pike FormBot/1.0"\n    ])\n);\n'})}),"\n",(0,a.jsx)(n.p,{children:"Submit JSON data:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Submit JSON via POST\nmapping data = ([\n    "user": (mapping)[\n        "name": "Jane Doe",\n        "email": "jane@example.com"\n    ],\n    "action": "update"\n]);\n\nstring json_body = Standards.JSON.encode(data);\n\nmapping(string:string) headers = ([\n    "Content-Type": "application/json",\n    "Accept": "application/json"\n]);\n\nProtocols.HTTP.Query q = Protocols.HTTP.do_method(\n    "POST",\n    "https://api.example.com/endpoint",\n    ([]),  // query variables\n    headers,\n    0,     // follow redirects\n    json_body\n);\n\nif (q->status >= 200 && q->status < 300) {\n    mapping response = Standards.JSON.decode(q->data());\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"extracting-urls",children:"Extracting URLs"}),"\n",(0,a.jsx)(n.p,{children:"Extract links from HTML:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Fetch HTML and extract links\nProtocols.HTTP.Query q = Protocols.HTTP.get_url("https://example.com");\nstring html = q->data();\n\n// Extract all href attributes\nobject re = Regexp.PCRE.Simple("<a\\\\s+href=\\"([^\\"]+)\\"[^>]*>([^<]*)</a>");\n\narray(string) links = ({});\nint pos = 0;\n\nwhile (pos < sizeof(html)) {\n    array(string) match = re->match(html, pos);\n    if (!match) break;\n\n    string url = match[1];\n    string text = match[2];\n\n    links += (([ "url": url, "text": text ]));\n\n    pos = html->search(match[0], pos) + sizeof(match[0]);\n}\n\nforeach(links, mapping link) {\n    write("%s -> %s\\n", link->text, link->url);\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"html-parsing-with-standardsxml",children:"HTML Parsing with Standards.XML"}),"\n",(0,a.jsx)(n.p,{children:"Parse well-formed HTML/XML:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Parse XHTML/well-formed HTML\nStandards.XML.Node root = Standards.XML.parse(html);\n\n// Extract title\narray(Standards.XML.Node) titles = root->get_elements("title");\nif (sizeof(titles)) {\n    write("Title: %s\\n", titles[0]->get_text());\n}\n\n// Extract all paragraphs\narray(Standards.XML.Node) paragraphs = root->get_elements("p");\nforeach(paragraphs, Standards.XML.Node p) {\n    mapping attrs = p->get_attributes();\n    string id = attrs && attrs->id ? attrs->id : "no-id";\n    write("[%s]: %s\\n", id, p->get_text());\n}\n\n// Extract list items\narray(Standards.XML.Node) lists = root->get_elements("ul");\nif (sizeof(lists)) {\n    array(Standards.XML.Node) items = lists[0]->get_elements("li");\n    foreach(items, Standards.XML.Node item) {\n        write("- %s\\n", item->get_text());\n    }\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"converting-ascii-to-html",children:"Converting ASCII to HTML"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Escape special characters for HTML\nstring html_escape(string text) {\n    text = replace(text, "&", "&amp;");\n    text = replace(text, "<", "&lt;");\n    text = replace(text, ">", "&gt;");\n    text = replace(text, "\\"", "&quot;");\n    text = replace(text, "\'", "&#39;");\n    return text;\n}\n\nwrite(html_escape("<script>alert(\'XSS\')<\/script>"));\n// Output: &lt;script&gt;alert(&#39;XSS&#39;)&lt;/script&gt;\n'})}),"\n",(0,a.jsx)(n.h2,{id:"converting-html-to-ascii",children:"Converting HTML to ASCII"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Strip HTML tags\nstring strip_html(string html) {\n    // Remove all tags\n    string text = Regexp.PCRE.Simple("<[^>]+>")->replace(html, "");\n\n    // Decode common entities\n    text = replace(text, "&amp;", "&");\n    text = replace(text, "&lt;", "<");\n    text = replace(text, "&gt;", ">");\n    text = replace(text, "&quot;", "\\"");\n    text = replace(text, "&nbsp;", " ");\n\n    return text;\n}\n\nstring html = "<p>Hello <b>world</b>!</p>";\nwrite(strip_html(html));\n// Output: Hello world!\n'})}),"\n",(0,a.jsx)(n.h2,{id:"session-management-and-cookies",children:"Session Management and Cookies"}),"\n",(0,a.jsx)(n.p,{children:"Handle cookies and maintain sessions:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Parse Set-Cookie header\nclass CookieJar {\n    private mapping(string:mapping) cookies = ([]);\n\n    void set_cookie(string cookie_str, string|void domain) {\n        // Parse: name=value; Expires=date; Path=/; Domain=.example.com\n        array(string) parts = cookie_str / ";";\n\n        string name;\n        string value;\n\n        foreach(parts, string part) {\n            part = String.trim_whitespace(part);\n            array(string) nv = part / "=";\n\n            if (sizeof(nv) == 2) {\n                if (!name) {\n                    name = nv[0];\n                    value = nv[1];\n                }\n            }\n        }\n\n        if (name && domain) {\n            cookies[name] = ([ "value": value, "domain": domain ]);\n        }\n    }\n\n    string cookie_header(string url) {\n        array(string) pairs = map(indices(cookies), lambda(string name) {\n            return name + "=" + cookies[name]->value;\n        });\n        return pairs * "; ";\n    }\n}\n\n// Use with HTTP requests\nCookieJar jar = CookieJar();\n\n// Receive cookie\nProtocols.HTTP.Query q = Protocols.HTTP.get_url("https://example.com/login");\njar->set_cookie(q->headers["set-cookie"], "example.com");\n\n// Send cookie with subsequent request\nmapping headers = (["Cookie": jar->cookie_header("https://example.com")]);\nq = Protocols.HTTP.get_url("https://example.com/profile", headers);\n'})}),"\n",(0,a.jsx)(n.h2,{id:"authentication",children:"Authentication"}),"\n",(0,a.jsx)(n.p,{children:"HTTP Basic Authentication:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Basic Auth header\nstring credentials = "user:pass";\nstring encoded = MIME.encode_base64(credentials);\n\nmapping(string:string) headers = ([\n    "Authorization": "Basic " + encoded\n]);\n\nProtocols.HTTP.Query q = Protocols.HTTP.get_url(\n    "https://api.example.com/protected",\n    headers\n);\n'})}),"\n",(0,a.jsx)(n.p,{children:"Bearer token (OAuth2/JWT):"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Bearer token authentication\nstring access_token = "your_token_here";\n\nmapping(string:string) headers = ([\n    "Authorization": "Bearer " + access_token,\n    "Content-Type": "application/json"\n]);\n\nProtocols.HTTP.Query q = Protocols.HTTP.get_url(\n    "https://api.example.com/resource",\n    headers\n);\n'})}),"\n",(0,a.jsx)(n.h2,{id:"rest-api-client",children:"REST API Client"}),"\n",(0,a.jsx)(n.p,{children:"Full REST API client with error handling:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// High-level REST client\nclass RESTClient {\n    private string base_url;\n    private string|void auth_token;\n\n    void create(string url, string|void token) {\n        base_url = url;\n        auth_token = token;\n    }\n\n    mapping get(string endpoint, mapping|void params) {\n        mapping(string:string) headers = ([\n            "Accept": "application/json"\n        ]);\n\n        if (auth_token) {\n            headers["Authorization"] = "Bearer " + auth_token;\n        }\n\n        Protocols.HTTP.Query q = Protocols.HTTP.get_url(\n            base_url + endpoint,\n            headers\n        );\n\n        if (q->status >= 200 && q->status < 300) {\n            return ([\n                "success": 1,\n                "status": q->status,\n                "data": Standards.JSON.decode(q->data())\n            ]);\n        } else {\n            return ([\n                "success": 0,\n                "status": q->status,\n                "error": q->status_desc\n            ]);\n        }\n    }\n\n    mapping post(string endpoint, mapping data) {\n        mapping(string:string) headers = ([\n            "Content-Type": "application/json",\n            "Accept": "application/json"\n        ]);\n\n        if (auth_token) {\n            headers["Authorization"] = "Bearer " + auth_token;\n        }\n\n        string body = Standards.JSON.encode(data);\n        Protocols.HTTP.Query q = Protocols.HTTP.do_method(\n            "POST", base_url + endpoint, ([]), headers, 0, body\n        );\n\n        // Similar error handling as GET...\n    }\n}\n\n// Usage\nRESTClient api = RESTClient("https://api.example.com");\nmapping result = api->get("/users/1");\n\nif (result->success) {\n    mapping user = result->data;\n    write("User: %s\\n", user->name);\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"webhook-handler",children:"Webhook Handler"}),"\n",(0,a.jsx)(n.p,{children:"Simple webhook server:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Webhook server using Protocols.HTTP.Server\nclass WebhookHandler {\n    void handle(Protocols.HTTP.Server.Request req) {\n        method m = req->request_type;\n\n        if (m == "POST") {\n            string body = req->body_raw || "";\n\n            // Parse JSON payload\n            mapping data = Standards.JSON.decode(body);\n\n            werror("Received webhook: %s\\n", data->event || "unknown");\n\n            // Send response\n            string resp = Standards.JSON.encode(([\n                "status": "received"\n            ]));\n\n            req->response_and_finish(sprintf(\n                "HTTP/1.1 200 OK\\r\\nContent-Type: application/json\\r\\n\\r\\n%s",\n                resp\n            ));\n        }\n    }\n}\n\n// Start server\nProtocols.HTTP.Server.Port port = Protocols.HTTP.Server.Port();\nport->bind(8080, WebhookHandler()->handle);\n'})}),"\n",(0,a.jsx)(n.h2,{id:"rate-limiting",children:"Rate Limiting"}),"\n",(0,a.jsx)(n.p,{children:"Polite crawler with rate limiting:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Rate limiter\nclass RateLimiter {\n    private float min_interval;\n    private int last_request = 0;\n\n    void create(int requests_per_second) {\n        min_interval = 1.0 / requests_per_second;\n    }\n\n    void throttle() {\n        int current = time();\n        float elapsed = current - last_request;\n\n        if (elapsed < min_interval) {\n            float sleep_time = min_interval - elapsed;\n            sleep((int)(sleep_time * 1000000) / 1000);\n        }\n\n        last_request = time();\n    }\n}\n\n// Usage\nRateLimiter limiter = RateLimiter(2);  // 2 requests per second\n\nfor (int i = 1; i <= 10; i++) {\n    limiter->throttle();\n    Protocols.HTTP.get_url(sprintf("https://example.com/page/%d", i));\n    write("Fetched page %d\\n", i);\n}\n'})}),"\n",(0,a.jsx)(n.h2,{id:"creating-a-web-crawler",children:"Creating a Web Crawler"}),"\n",(0,a.jsx)(n.p,{children:"Basic web crawler:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Simple web crawler\nclass WebCrawler {\n    private string start_url;\n    private int max_depth;\n    private set(string) visited = (<>);\n    private array(string) queue = ({});\n    private RateLimiter limiter;\n\n    void create(string url, int|void depth, int|void rps) {\n        start_url = url;\n        max_depth = depth || 3;\n        limiter = RateLimiter(rps || 2);\n        queue += ({url});\n    }\n\n    array(string) extract_links(string html) {\n        array(string) links = ({});\n        object re = Regexp.PCRE.Simple("<a\\\\s+href=[\'\\"]([^\'\\"]+)[\'\\"]");\n\n        int pos = 0;\n        while (pos < sizeof(html)) {\n            array(string) match = re->match(html, pos);\n            if (!match) break;\n            links += ({match[1]});\n            pos = html->search(match[0], pos) + sizeof(match[0]);\n        }\n        return links;\n    }\n\n    void crawl() {\n        while (sizeof(queue)) {\n            string url = queue[0];\n            queue = queue[1..];\n\n            if (visited[url]) continue;\n            visited[url] = 1;\n\n            limiter->throttle();\n            Protocols.HTTP.Query q = Protocols.HTTP.get_url(url);\n\n            if (q && q->status == 200) {\n                write("Crawled: %s (%d bytes)\\n", url, sizeof(q->data()));\n\n                array(string) links = extract_links(q->data());\n                queue += links;\n            }\n        }\n    }\n}\n\n// Usage\nWebCrawler crawler = WebCrawler("https://example.com", 2, 1);\ncrawler->crawl();\n'})}),"\n",(0,a.jsx)(n.h2,{id:"handling-javascript-heavy-sites",children:"Handling JavaScript-Heavy Sites"}),"\n",(0,a.jsx)(n.p,{children:"Pike cannot execute JavaScript directly. For JS-heavy sites:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'// Strategy 1: Discover hidden API endpoints\nstring html = Protocols.HTTP.get_url("https://example.com")->data();\n\n// Look for API calls in JavaScript\narray(string) patterns = ({\n    "fetch\\\\([\'\\"]([^\'\\"]+)[\'\\"]",\n    "\\\\.get\\\\([\'\\"]([^\'\\"]+)[\'\\"]",\n    "[\\"\']url[\\"\']:\\\\s*[\\"\']([^\'\\"]+)[\\"\']"\n});\n\nforeach(patterns, string pattern) {\n    object re = Regexp.PCRE.Simple(pattern);\n    array(string) matches = re->split(html);\n    if (sizeof(matches) > 1) {\n        write("Found API endpoint: %s\\n", matches[1]);\n    }\n}\n\n// Strategy 2: Use headless browser (via external tool)\n// Call Node.js script with Puppeteer from Pike\nobject proc = Process.popen("node render.js https://example.com", "r");\nstring rendered_html = proc->read();\nproc->close();\n\n// Now parse the rendered HTML\n'})}),"\n",(0,a.jsx)(n.h2,{id:"program-web-scraper",children:"Program: Web Scraper"}),"\n",(0,a.jsx)(n.p,{children:"Complete web scraper example:"}),"\n",(0,a.jsx)(n.pre,{children:(0,a.jsx)(n.code,{className:"language-pike",children:'#!/usr/bin/env pike\n#pragma strict_types\n\nint main(int argc, array(string) argv) {\n    if (argc < 2) {\n        werror("Usage: %s <url>\\n", argv[0]);\n        return 1;\n    }\n\n    string url = argv[1];\n\n    // Fetch page\n    Protocols.HTTP.Query q = Protocols.HTTP.get_url(url);\n\n    if (q->status != 200) {\n        werror("HTTP Error: %d\\n", q->status);\n        return 1;\n    }\n\n    string html = q->data();\n\n    // Extract title\n    object re = Regexp.PCRE.Simple("<title>([^<]*)</title>");\n    array(string) title_match = re->split(html);\n    if (sizeof(title_match) > 1) {\n        write("Title: %s\\n", title_match[1]);\n    }\n\n    // Extract all links\n    re = Regexp.PCRE.Simple("<a\\\\s+href=\\"([^\\"]+)\\"[^>]*>([^<]*)</a>");\n    array(string) links = ({});\n    int pos = 0;\n\n    while (pos < sizeof(html)) {\n        array(string) match = re->match(html, pos);\n        if (!match) break;\n\n        write("  %s -> %s\\n", match[2], match[1]);\n        pos = html->search(match[0], pos) + sizeof(match[0]);\n    }\n\n    return 0;\n}\n'})})]})}function p(e={}){const{wrapper:n}={...(0,i.R)(),...e.components};return n?(0,a.jsx)(n,{...e,children:(0,a.jsx)(d,{...e})}):d(e)}},8453(e,n,t){t.d(n,{R:()=>s,x:()=>o});var r=t(6540);const a={},i=r.createContext(a);function s(e){const n=r.useContext(i);return r.useMemo(function(){return"function"==typeof e?e(n):{...n,...e}},[n,e])}function o(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(a):e.components||a:s(e.components),r.createElement(i.Provider,{value:n},e.children)}}}]);