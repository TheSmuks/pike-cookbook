"use strict";(self.webpackChunkpike_cookbook=self.webpackChunkpike_cookbook||[]).push([[526],{8453(e,i,n){n.d(i,{R:()=>a,x:()=>r});var t=n(6540);const l={},o=t.createContext(l);function a(e){const i=t.useContext(o);return t.useMemo(function(){return"function"==typeof e?e(i):{...i,...e}},[i,e])}function r(e){let i;return i=e.disableParentContext?"function"==typeof e.components?e.components(l):e.components||l:a(e.components),t.createElement(o.Provider,{value:i},e.children)}},9154(e,i,n){n.r(i),n.d(i,{assets:()=>s,contentTitle:()=>r,default:()=>f,frontMatter:()=>a,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"files/file-access","title":"File Access","description":"7. File Access","source":"@site/docs/files/file-access.md","sourceDirName":"files","slug":"/files/file-access","permalink":"/pike-cookbook/docs/files/file-access","draft":false,"unlisted":false,"editUrl":"https://github.com/smuks/pike-cookbook/tree/main/docs/files/file-access.md","tags":[],"version":"current","frontMatter":{"id":"file-access","title":"File Access","sidebar_label":"File Access"},"sidebar":"tutorialSidebar","previous":{"title":"Subroutines","permalink":"/pike-cookbook/docs/basics/subroutines"},"next":{"title":"File Contents","permalink":"/pike-cookbook/docs/files/file-contents"}}');var l=n(4848),o=n(8453);const a={id:"file-access",title:"File Access",sidebar_label:"File Access"},r=void 0,s={},d=[{value:"7. File Access",id:"7-file-access",level:2},{value:"Introduction",id:"introduction",level:3},{value:"Opening a File",id:"opening-a-file",level:3},{value:"Opening Files with Unusual Filenames",id:"opening-files-with-unusual-filenames",level:3},{value:"Expanding Tildes in Filenames",id:"expanding-tildes-in-filenames",level:3},{value:"Making Perl Report Filenames in Errors",id:"making-perl-report-filenames-in-errors",level:3},{value:"Creating Temporary Files",id:"creating-temporary-files",level:3},{value:"Storing Files Inside Your Program Text",id:"storing-files-inside-your-program-text",level:3},{value:"Writing a Filter",id:"writing-a-filter",level:3},{value:"Modifying a File in Place with Temporary File",id:"modifying-a-file-in-place-with-temporary-file",level:3},{value:"Modifying a File in Place with -i Switch",id:"modifying-a-file-in-place-with--i-switch",level:3},{value:"Modifying a File in Place Without a Temporary File",id:"modifying-a-file-in-place-without-a-temporary-file",level:3},{value:"Locking a File",id:"locking-a-file",level:3},{value:"Flushing Output",id:"flushing-output",level:3},{value:"Reading from Many Filehandles Without Blocking",id:"reading-from-many-filehandles-without-blocking",level:3},{value:"Doing Non-Blocking I/O",id:"doing-non-blocking-io",level:3},{value:"Determining the Number of Bytes to Read",id:"determining-the-number-of-bytes-to-read",level:3},{value:"Storing Filehandles in Variables",id:"storing-filehandles-in-variables",level:3},{value:"Caching Open Output Filehandles",id:"caching-open-output-filehandles",level:3},{value:"Printing to Many Filehandles Simultaneously",id:"printing-to-many-filehandles-simultaneously",level:3},{value:"Opening and Closing File Descriptors by Number",id:"opening-and-closing-file-descriptors-by-number",level:3},{value:"Copying Filehandles",id:"copying-filehandles",level:3},{value:"Program: netlock",id:"program-netlock",level:3},{value:"Program: lockarea",id:"program-lockarea",level:3}];function c(e){const i={code:"code",h2:"h2",h3:"h3",pre:"pre",...(0,o.R)(),...e.components};return(0,l.jsxs)(l.Fragment,{children:[(0,l.jsx)(i.h2,{id:"7-file-access",children:"7. File Access"}),"\n",(0,l.jsx)(i.h3,{id:"introduction",children:"Introduction"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-pike",children:'// if you are going to read the whole file, the most common way is to use\n// Stdio.read_file()\n\nstring INPUT = Stdio.read_file("/usr/local/widgets/data");\nif(!INPUT)\n{\n  werror("Couldn\'t open /usr/local/widgets/data for reading\\n");\n  exit(1);\n}\n\nforeach(INPUT/"\\n";; string line)\n{\n  if(search(line, "blue")!=-1)\n    write(line+"\\n");\n}\n\n// if you need more control over the process you can get a filehandle with\n// Stdio.File()\n\nStdio.File INPUT = Stdio.File("/usr/local/widgets/data", "r");\nif(!INPUT)\n{\n  werror("Couldn\'t open /usr/local/widgets/data for reading\\n");\n  exit(1);\n}\n\nforeach(INPUT->line_iterator();; string line)\n{\n  if(search(line, "blue")!=-1)\n    write(line+"\\n");\n}\nINPUT->close();\n\n//---------------------------------------------------------\n\nforeach(Stdio.stdin;; string line)            // reads from STDIN\n{\n  if(!sizeof(array_sscanf(line, "%*s%d")))\n    werror("No digit found.\\n");              // writes to STDERR\n  write("Read: %s\\n", line);                  // writes ot STDOUT\n}\nStdio.stdout->close() || werror("couldn\'t close STDOUT\\n") && exit(1);\n\n// just as with Stdio.read_file(), there are convenience functions for writing:\n// Stdio.write_file() and Stdio.append_file()\n\nStdio.File logfile = Stdio.File("/tmp/log", "w");\n\n// access modes are "r" for reading, "w" for writing and "a" for append\n// default mode is "rw"\n\n// to read a line you may use Stdio.File()->gets() or get a line_iterator() and\n// read lines from it.\n\nobject LOGFILE = logfile->line_iterator();\ndo\n{\n  string line=LOGFILE->value();\n}\nwhile(LOGFILE->next())\nlogfile->close();\n\n// or use foreach as shown above.\n\n// write() is actually a shortcut for Stdio.stdout->write()\n// you could get yourself a different shortcut by assigning that to a variable:\n\nfunction write = logfile->write;     //  switch to LOGFILE for write();\nwrite("Countdown initiated ...\\n");\nwrite = Stdio.stdout->write;         //  return to stdout\nwrite("You have 30 seconds to reach minimum safety distance.\\n");\n\n// Stdio.File is unbuffered. a buffered version is provided by Stdio.FILE\n'})}),"\n",(0,l.jsx)(i.h3,{id:"opening-a-file",children:"Opening a File"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-pike",children:'// use Stdio.read_file(), Stdio.write_file() and Stdio.append_file() for\n// convenience, or Stdio.File for precision and to get a filehandle.\n\nstring path;\n\n// open file for reading\nstring file = Stdio.read_file(path);\nStdio.File file = Stdio.File(path, "r");\n\n// open file for writing, create new file if needed, or else truncate old file\nStdio.write_file(path, "content");\nStdio.File file = Stdio.File(path, "wc");\n\n// same with setting access permissions\nStdio.write_file(path, "content", 0600);\nStdio.File file = Stdio.File(path, "wc", 0600);\n\n// open file for writing, create new file, file must not exist\nif(!file_stat(path))\n  Stdio.write_file(path, "content");\nStdio.File file = Stdio.File(path, "wcx");\n\nif(!file_stat(path))\n  Stdio.write_file(path, "content", 0600);\nStdio.File file = Stdio.File(path, "wcx", 0600);\n\n// open file for appending, create if necessary\nStdio.append_file(path, "content");\nStdio.File file = Stdio.File(path, "wac");\n\nStdio.append_file(path, "content", 0600);\nStdio.File file = Stdio.File(path, "wac", 0600);\n\n// open file for appending, file must exist\nStdio.File file = Stdio.File(path, "wacx");\n\n// open file for update, file must exist\nstring file = Stdio.read_file(path);\nstring updated = file+"foo"  // update contents of file\nStdio.write_file(path, updated);\n\nStdio.File file = Stdio.File(path);          // this is the default operation\n\n// open file for update, file must not exist\nStdio.File file = Stdio.File(path, "rwcx");\n\n'})}),"\n",(0,l.jsx)(i.h3,{id:"opening-files-with-unusual-filenames",children:"Opening Files with Unusual Filenames"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-pike",children:"// since the filename is contained in a string, this problem does not apply\n"})}),"\n",(0,l.jsx)(i.h3,{id:"expanding-tildes-in-filenames",children:"Expanding Tildes in Filenames"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-pike",children:'string filename;\n\nif(filename[0] == "~")\n{\n  string user, path, home;\n  [ user, path ] = array_sscanf(filename, "~%[^/]%s");\n  if(user == "")\n    home = getenv("HOME") || getenv("LOGDIR") || getpwuid(geteuid())[5];\n  else\n    home = getpwnam(user)[5];\n  filename = home+path;\n}\n'})}),"\n",(0,l.jsx)(i.h3,{id:"making-perl-report-filenames-in-errors",children:"Making Perl Report Filenames in Errors"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-pike",children:'string path = "/tmp/fooo";\nmixed error = catch\n{\n  Stdio.File file = Stdio.File(path, "r");\n};\n\nif(error)\n{\n  werror("Couldn\'t open %s for reading:\\n", path);\n  werror(error[0]);\n}\n// Couldn\'t open /tmp/fooo for reading:\n// Failed to open "/tmp/fooo" mode "r" : No such file or directory\n'})}),"\n",(0,l.jsx)(i.h3,{id:"creating-temporary-files",children:"Creating Temporary Files"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-pike",children:'Stdio.File fh;\nstring name;\ndo\n{\n  name = "/tmp/"+MIME.encode_base64(random_string(10));\n  fh = Stdio.File(name, "rwcx");\n}\nwhile(!fh)\n\natexit(lambda(){ fh->close(); rm(name); });\n\n\n// if you don\'t really need the file to be on disk (or if /tmp is a ramdisk)\n// but you need an object that behaves like a file, then use Stdio.FakeFile\n\nfh = Stdio.FakeFile();\n\n// and use fh like any other filehandle.\n\n'})}),"\n",(0,l.jsx)(i.h3,{id:"storing-files-inside-your-program-text",children:"Storing Files Inside Your Program Text"}),"\n",(0,l.jsx)(i.pre,{children:(0,l.jsx)(i.code,{className:"language-pike",children:'// since the usual way to handle files is to read them into a string, then just\n// assign your data to a string and work from there:\n\nstring data = "your data goes here";\n\n\n// or for convenient multiline data:\n\nstring data = #"your data goes here\nand here\nand ends here";\n\n\n// or use Stdio.FakeFile for a Stdio.File compatible interface\n// see 7.5\n\n//-----------------------------------------------------------------\n\nobject stat = file_stat(__FILE__);\nint raw_time = stat->ctime;\nint size     = stat->size;\nint kilosize = size/1024;\n\nwrite("<P>Script size is %dk\\n", kilosize);\nwrite("<P>Last script update: %s\\n", Calendar.Second(raw_time)->format_nicez());\n\n'})}),"\n",(0,l.jsx)(i.h3,{id:"writing-a-filter",children:"Writing a Filter"}),"\n",(0,l.jsx)(i.h3,{id:"modifying-a-file-in-place-with-temporary-file",children:"Modifying a File in Place with Temporary File"}),"\n",(0,l.jsx)(i.h3,{id:"modifying-a-file-in-place-with--i-switch",children:"Modifying a File in Place with -i Switch"}),"\n",(0,l.jsx)(i.h3,{id:"modifying-a-file-in-place-without-a-temporary-file",children:"Modifying a File in Place Without a Temporary File"}),"\n",(0,l.jsx)(i.h3,{id:"locking-a-file",children:"Locking a File"}),"\n",(0,l.jsx)(i.h3,{id:"flushing-output",children:"Flushing Output"}),"\n",(0,l.jsx)(i.h3,{id:"reading-from-many-filehandles-without-blocking",children:"Reading from Many Filehandles Without Blocking"}),"\n",(0,l.jsx)(i.h3,{id:"doing-non-blocking-io",children:"Doing Non-Blocking I/O"}),"\n",(0,l.jsx)(i.h3,{id:"determining-the-number-of-bytes-to-read",children:"Determining the Number of Bytes to Read"}),"\n",(0,l.jsx)(i.h3,{id:"storing-filehandles-in-variables",children:"Storing Filehandles in Variables"}),"\n",(0,l.jsx)(i.h3,{id:"caching-open-output-filehandles",children:"Caching Open Output Filehandles"}),"\n",(0,l.jsx)(i.h3,{id:"printing-to-many-filehandles-simultaneously",children:"Printing to Many Filehandles Simultaneously"}),"\n",(0,l.jsx)(i.h3,{id:"opening-and-closing-file-descriptors-by-number",children:"Opening and Closing File Descriptors by Number"}),"\n",(0,l.jsx)(i.h3,{id:"copying-filehandles",children:"Copying Filehandles"}),"\n",(0,l.jsx)(i.h3,{id:"program-netlock",children:"Program: netlock"}),"\n",(0,l.jsx)(i.h3,{id:"program-lockarea",children:"Program: lockarea"})]})}function f(e={}){const{wrapper:i}={...(0,o.R)(),...e.components};return i?(0,l.jsx)(i,{...e,children:(0,l.jsx)(c,{...e})}):c(e)}}}]);