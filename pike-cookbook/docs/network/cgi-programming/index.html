<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-network/cgi-programming" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">CGI Programming | Pike Cookbook</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://TheSmuks.github.io/pike-cookbook/img/docusaurus-social-card.jpg"><meta data-rh="true" name="twitter:image" content="https://TheSmuks.github.io/pike-cookbook/img/docusaurus-social-card.jpg"><meta data-rh="true" property="og:url" content="https://TheSmuks.github.io/pike-cookbook/docs/network/cgi-programming"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="CGI Programming | Pike Cookbook"><meta data-rh="true" name="description" content="19. CGI Programming"><meta data-rh="true" property="og:description" content="19. CGI Programming"><link data-rh="true" rel="icon" href="/pike-cookbook/img/favicon.ico"><link data-rh="true" rel="canonical" href="https://TheSmuks.github.io/pike-cookbook/docs/network/cgi-programming"><link data-rh="true" rel="alternate" href="https://TheSmuks.github.io/pike-cookbook/docs/network/cgi-programming" hreflang="en"><link data-rh="true" rel="alternate" href="https://TheSmuks.github.io/pike-cookbook/docs/network/cgi-programming" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"CGI Programming","item":"https://TheSmuks.github.io/pike-cookbook/docs/network/cgi-programming"}]}</script><link rel="stylesheet" href="/pike-cookbook/assets/css/styles.7a9da498.css">
<script src="/pike-cookbook/assets/js/runtime~main.640ae0d4.js" defer="defer"></script>
<script src="/pike-cookbook/assets/js/main.c3b68af9.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>!function(){var t=function(){try{return new URLSearchParams(window.location.search).get("docusaurus-theme")}catch(t){}}()||function(){try{return window.localStorage.getItem("theme")}catch(t){}}();document.documentElement.setAttribute("data-theme",t||"light"),document.documentElement.setAttribute("data-theme-choice",t||"light")}(),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/pike-cookbook/"><div class="navbar__logo"><img src="/pike-cookbook/img/logo.svg" alt="Pike Logo" class="themedComponent_mlkZ themedComponent--light_NVdE"><img src="/pike-cookbook/img/logo.svg" alt="Pike Logo" class="themedComponent_mlkZ themedComponent--dark_xIcU"></div><b class="navbar__title text--truncate">Pike Cookbook</b></a><a aria-current="page" class="navbar__item navbar__link navbar__link--active" href="/pike-cookbook/docs/intro">Cookbook</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><a href="https://github.com/smuks/pike-cookbook" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a><div class="toggle_vylO colorModeToggle_DEke"><button class="clean-btn toggleButton_gllP toggleButtonDisabled_aARS" type="button" disabled="" title="system mode" aria-label="Switch between dark and light mode (currently system mode)"><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP lightToggleIcon_pyhR"><path fill="currentColor" d="M12,9c1.65,0,3,1.35,3,3s-1.35,3-3,3s-3-1.35-3-3S10.35,9,12,9 M12,7c-2.76,0-5,2.24-5,5s2.24,5,5,5s5-2.24,5-5 S14.76,7,12,7L12,7z M2,13l2,0c0.55,0,1-0.45,1-1s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S1.45,13,2,13z M20,13l2,0c0.55,0,1-0.45,1-1 s-0.45-1-1-1l-2,0c-0.55,0-1,0.45-1,1S19.45,13,20,13z M11,2v2c0,0.55,0.45,1,1,1s1-0.45,1-1V2c0-0.55-0.45-1-1-1S11,1.45,11,2z M11,20v2c0,0.55,0.45,1,1,1s1-0.45,1-1v-2c0-0.55-0.45-1-1-1C11.45,19,11,19.45,11,20z M5.99,4.58c-0.39-0.39-1.03-0.39-1.41,0 c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0s0.39-1.03,0-1.41L5.99,4.58z M18.36,16.95 c-0.39-0.39-1.03-0.39-1.41,0c-0.39,0.39-0.39,1.03,0,1.41l1.06,1.06c0.39,0.39,1.03,0.39,1.41,0c0.39-0.39,0.39-1.03,0-1.41 L18.36,16.95z M19.42,5.99c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06c-0.39,0.39-0.39,1.03,0,1.41 s1.03,0.39,1.41,0L19.42,5.99z M7.05,18.36c0.39-0.39,0.39-1.03,0-1.41c-0.39-0.39-1.03-0.39-1.41,0l-1.06,1.06 c-0.39,0.39-0.39,1.03,0,1.41s1.03,0.39,1.41,0L7.05,18.36z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP darkToggleIcon_wfgR"><path fill="currentColor" d="M9.37,5.51C9.19,6.15,9.1,6.82,9.1,7.5c0,4.08,3.32,7.4,7.4,7.4c0.68,0,1.35-0.09,1.99-0.27C17.45,17.19,14.93,19,12,19 c-3.86,0-7-3.14-7-7C5,9.07,6.81,6.55,9.37,5.51z M12,3c-4.97,0-9,4.03-9,9s4.03,9,9,9s9-4.03,9-9c0-0.46-0.04-0.92-0.1-1.36 c-0.98,1.37-2.58,2.26-4.4,2.26c-2.98,0-5.4-2.42-5.4-5.4c0-1.81,0.89-3.42,2.26-4.4C12.92,3.04,12.46,3,12,3L12,3z"></path></svg><svg viewBox="0 0 24 24" width="24" height="24" aria-hidden="true" class="toggleIcon_g3eP systemToggleIcon_QzmC"><path fill="currentColor" d="m12 21c4.971 0 9-4.029 9-9s-4.029-9-9-9-9 4.029-9 9 4.029 9 9 9zm4.95-13.95c1.313 1.313 2.05 3.093 2.05 4.95s-0.738 3.637-2.05 4.95c-1.313 1.313-3.093 2.05-4.95 2.05v-14c1.857 0 3.637 0.737 4.95 2.05z"></path></svg></button></div><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/pike-cookbook/docs/intro"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/pike-cookbook/docs/basics/strings"><span title="Basic Recipes" class="categoryLinkLabel_W154">Basic Recipes</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/basics/strings"><span title="Strings" class="linkLabel_WmDU">Strings</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/basics/numbers"><span title="Numbers" class="linkLabel_WmDU">Numbers</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/basics/arrays"><span title="Arrays" class="linkLabel_WmDU">Arrays</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/basics/hashes"><span title="Hashes" class="linkLabel_WmDU">Hashes</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/basics/dates"><span title="Dates and Times" class="linkLabel_WmDU">Dates and Times</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/basics/pattern-matching"><span title="Pattern Matching" class="linkLabel_WmDU">Pattern Matching</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/basics/subroutines"><span title="Subroutines" class="linkLabel_WmDU">Subroutines</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/pike-cookbook/docs/files/file-access"><span title="File Operations" class="categoryLinkLabel_W154">File Operations</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/files/file-access"><span title="File Access" class="linkLabel_WmDU">File Access</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/files/file-contents"><span title="File Contents" class="linkLabel_WmDU">File Contents</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/files/directories"><span title="Directories" class="linkLabel_WmDU">Directories</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/files/database-access"><span title="Database Access" class="linkLabel_WmDU">Database Access</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/pike-cookbook/docs/network/cgi-programming"><span title="Network &amp; Web" class="categoryLinkLabel_W154">Network &amp; Web</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/pike-cookbook/docs/network/cgi-programming"><span title="CGI Programming" class="linkLabel_WmDU">CGI Programming</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/network/sockets"><span title="Sockets" class="linkLabel_WmDU">Sockets</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/network/web-automation"><span title="Web Automation" class="linkLabel_WmDU">Web Automation</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/network/internet-services"><span title="Internet Services" class="linkLabel_WmDU">Internet Services</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="true" href="/pike-cookbook/docs/advanced/classes"><span title="Advanced Topics" class="categoryLinkLabel_W154">Advanced Topics</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/advanced/classes"><span title="Classes and Objects" class="linkLabel_WmDU">Classes and Objects</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/advanced/references"><span title="References and Records" class="linkLabel_WmDU">References and Records</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/advanced/modules"><span title="Modules and Packages" class="linkLabel_WmDU">Modules and Packages</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/advanced/processes"><span title="Process Management" class="linkLabel_WmDU">Process Management</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/pike-cookbook/docs/advanced/user-interfaces"><span title="User Interfaces" class="linkLabel_WmDU">User Interfaces</span></a></li></ul></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/pike-cookbook/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Network &amp; Web</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">CGI Programming</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>CGI Programming</h1></header><h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="19-cgi-programming">19. CGI Programming<a href="#19-cgi-programming" class="hash-link" aria-label="Direct link to 19. CGI Programming" title="Direct link to 19. CGI Programming" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="introduction-to-cgi-programming">Introduction to CGI Programming<a href="#introduction-to-cgi-programming" class="hash-link" aria-label="Direct link to Introduction to CGI Programming" title="Direct link to Introduction to CGI Programming" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">CGI (Common Gateway Interface) allows web servers to execute programs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">and display their output. Pike provides built-in CGI support through</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">various modules including Protocols.HTTP and CGI.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Environment variables available in CGI:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">REQUEST_METHOD, QUERY_STRING, CONTENT_TYPE, CONTENT_LENGTH</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">SCRIPT_NAME, PATH_INFO, PATH_TRANSLATED, SERVER_NAME, SERVER_PORT</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP_USER_AGENT, HTTP_REFERER, HTTP_COOKIE, REMOTE_ADDR, etc.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">import Standards.JSON;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Display all CGI environment variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void show_env_vars() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;CGI Environment\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;CGI Environment Variables\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(getenv(); string key; string value) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;%s%s\n&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">key, value);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Simple JSON endpoint</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void json_endpoint() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) data = ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;method&quot;: getenv(&quot;REQUEST_METHOD&quot;) || &quot;UNKNOWN&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;query&quot;: getenv(&quot;QUERY_STRING&quot;) || &quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;user_agent&quot;: getenv(&quot;HTTP_USER_AGENT&quot;) || &quot;Unknown&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;remote_addr&quot;: getenv(&quot;REMOTE_ADDR&quot;) || &quot;Unknown&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string json = Standards.JSON.encode(data);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: application/json\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Access-Control-Allow-Origin: *\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(json);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Main entry point - determine response type based on Accept header</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string accept = getenv(&quot;HTTP_ACCEPT&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (has_prefix(accept, &quot;application/json&quot;)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">json_endpoint();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">show_env_vars();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="writing-a-cgi-script">Writing a CGI Script<a href="#writing-a-cgi-script" class="hash-link" aria-label="Direct link to Writing a CGI Script" title="Direct link to Writing a CGI Script" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">A complete CGI script that handles GET and POST requests</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">import Protocols.HTTP;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">URL decoding function</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string url_decode(string s) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return replace(replace(replace(s, &quot;+&quot;, &quot; &quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;%20&quot;, &quot; &quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;\\\\&quot;, &quot;\&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">URL encoding function</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string url_encode(string s) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return Protocols.HTTP.http_encode_url(s);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Parse query string or POST data into a mapping</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) parse_form_data() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string data;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string method = getenv(&quot;REQUEST_METHOD&quot;) || &quot;GET&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (method == &quot;GET&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data = getenv(&quot;QUERY_STRING&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else if (method == &quot;POST&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int length = (int)(getenv(&quot;CONTENT_LENGTH&quot;) || &quot;0&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (length &gt; 0 &amp;&amp; length &quot;, &quot;&gt;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;\&quot;&quot;, &quot;&quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Send HTTP headers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void send_headers(string|void content_type, int|void status) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!content_type) content_type = &quot;text/html&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!status) status = 200;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string status_text = ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">200: &quot;OK&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">301: &quot;Moved Permanently&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">302: &quot;Found&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">400: &quot;Bad Request&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">404: &quot;Not Found&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">500: &quot;Internal Server Error&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">])[status] || &quot;OK&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: %d %s\r\n&quot;, status, status_text);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: %s; charset=utf-8\r\n&quot;, content_type);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Generate HTML form</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string generate_form(mapping(string:string) values) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string name = html_escape(values-&gt;name || &quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string email = html_escape(values-&gt;email || &quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string message = html_escape(values-&gt;message || &quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Contact Form</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body { font-family: Arial, sans-serif; margin: 40px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">input, textarea { display: block; margin: 10px 0; padding: 8px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">button { padding: 10px 20px; cursor: pointer; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Contact Form</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Name:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Email:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Message:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Submit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;, name, email, message);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Process form submission</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string process_form(mapping(string:string) form) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Validate required fields</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!form-&gt;name || !String.trim_all(form-&gt;name)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;ErrorName is required.&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!form-&gt;email || !has_suffix(form-&gt;email, &quot;@&quot;)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;ErrorValid email is required.&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// In production, save to database or send email</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string name = html_escape(form-&gt;name);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string email = html_escape(form-&gt;email);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string message = html_escape(form-&gt;message || &quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Thank You</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Thank You!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Your message has been received:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Name: %s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Email: %s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Message: %s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;, name, email, message);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Main entry point</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form = parse_form_data();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string output;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (getenv(&quot;REQUEST_METHOD&quot;) == &quot;POST&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output = process_form(form);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output = generate_form(form);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">send_headers();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(output);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="redirecting-error-messages">Redirecting Error Messages<a href="#redirecting-error-messages" class="hash-link" aria-label="Direct link to Redirecting Error Messages" title="Direct link to Redirecting Error Messages" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Capture and redirect error messages to browser instead of server log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">constant ERROR_LOG_FILE = &quot;/tmp/cgi_errors.log&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Custom error handler that captures errors</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) error_data = ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;has_error&quot;: &quot;0&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;error_message&quot;: &quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;backtrace&quot;: &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Install error handler at the start of your CGI script</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void install_error_handler() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">master()-&gt;set_inhibit_compile_errors(lambda(mixed err) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">error_data[&quot;has_error&quot;] = &quot;1&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">error_data[&quot;error_message&quot;] = sprintf(&quot;%O&quot;, err);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Redirect stderr to a file</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Stdio.File(ERROR_LOG_FILE, &quot;wac&quot;)-&gt;dup2(stderr);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Send error page to browser</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void send_error_page(string title, string message, string|void backtrace) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: 500 Internal Server Error\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string safe_title = replace(replace(replace(title, &quot;&quot;, &quot;&gt;&quot;), &quot;\&quot;&quot;, &quot;&quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string safe_message = replace(replace(replace(message, &quot;\n&quot;, &quot;\n&quot;), &quot;&quot;, &quot;&gt;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string safe_backtrace = backtrace ? replace(replace(backtrace, &quot;\n&quot;, &quot;\n&quot;), &quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Error</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body { font-family: Arial, sans-serif; margin: 40px; background: #f0f0f0; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.error-box { background: #fff; border-left: 4px solid #d32f2f; padding: 20px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.error-title { color: #d32f2f; margin-top: 0; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.error-message { white-space: pre-wrap; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.backtrace { background: #f5f5f5; padding: 15px; margin-top: 20px;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">font-family: monospace; font-size: 12px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%s&quot;, safe_title, safe_message);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (safe_backtrace != &quot;&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;        Backtrace:%s\n&quot;, safe_backtrace));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    \n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Log error to file with timestamp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void log_error(string message) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string timestamp = Calendar.now()-&gt;format_time();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string remote = getenv(&quot;REMOTE_ADDR&quot;) || &quot;unknown&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string uri = getenv(&quot;REQUEST_URI&quot;) || &quot;unknown&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string log_entry = sprintf(&quot;[%s] %s %s: %s\n&quot;, timestamp, remote, uri, message);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Stdio.File f = Stdio.File();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (f-&gt;open(ERROR_LOG_FILE, &quot;wac&quot;)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">f-&gt;write(log_entry);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">f-&gt;close();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Wrapper function for safe execution</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mixed safe_execute(function():mixed cb) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">install_error_handler();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mixed result = catch {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return cb();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (result) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Error was caught</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string err_msg = describe_error(result);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">log_error(err_msg);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">send_error_page(&quot;Application Error&quot;, err_msg, backtrace());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (error_data[&quot;has_error&quot;] == &quot;1&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">log_error(error_data[&quot;error_message&quot;]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">send_error_page(&quot;Compilation Error&quot;, error_data[&quot;error_message&quot;]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return UNDEFINED;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Example usage</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mixed err = safe_execute(lambda() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Your CGI code here</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Hello World!\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (err) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Error was already handled by safe_execute</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="fixing-a-500-server-error">Fixing a 500 Server Error<a href="#fixing-a-500-server-error" class="hash-link" aria-label="Direct link to Fixing a 500 Server Error" title="Direct link to Fixing a 500 Server Error" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Common causes of 500 errors and how to debug them</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. Check file permissions (must be executable)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">$ chmod +x yourscript.pike</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">2. Check shebang line at top of file</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#!/usr/bin/pike8</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. Ensure proper HTTP headers are sent FIRST</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void debug_cgi() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string debug = getenv(&quot;DEBUG_CGI&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (debug == &quot;1&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Enable verbose error output for debugging</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">master()-&gt;set_inhibit_compile_errors(0);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">add_constant(&quot;verbose_errors&quot;, 1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Common 500 error causes checklist</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) check_environment() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) issues = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check if we have required CGI environment variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!getenv(&quot;REQUEST_METHOD&quot;)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">issues[&quot;no_cgi_env&quot;] = &quot;Not running in CGI environment&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check if we can write to stdout</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Stdio.File stdout_file = Stdio.File(stdout);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!stdout_file || stdout_file-&gt;is_open()) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">issues[&quot;stdout_closed&quot;] = &quot;Cannot write to stdout&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return issues;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Send proper error response</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void error_response(int code, string message) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string title = ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">400: &quot;Bad Request&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">404: &quot;Not Found&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">500: &quot;Internal Server Error&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">503: &quot;Service Unavailable&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">])[code] || &quot;Error&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: %d %s\r\n&quot;, code, title);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%d %s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body{font-family:Arial,sans-serif;margin:40px;text-align:center;}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%d %s%s&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">code, title, code, title, message));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Validate CGI script syntax before execution</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int validate_script(string script_path) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string content;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Stdio.File f = Stdio.File();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!f-&gt;open(script_path, &quot;r&quot;)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;  // Cannot open file</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">content = f-&gt;read();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">f-&gt;close();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check for shebang</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!has_prefix(content, &quot;#!&quot;)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;  // Missing shebang</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check for main() function</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!has_value(content, &quot;void main()&quot;) &amp;&amp;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">!has_value(content, &quot;int main()&quot;)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;  // Missing main() function</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Debug helper - outputs diagnostic information</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void show_diagnostics() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/plain\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;CGI Diagnostics\n===============\n\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Environment Variables:\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach (getenv(); string k; string v) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  %s: %s\n&quot;, k, v);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;\nPike Version: %s\n&quot;, __VERSION__));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;Current Working Directory: %s\n&quot;, getcwd()));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Example CGI script with proper error handling</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Enable debugging if requested</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">debug_cgi();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check environment</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) issues = check_environment();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (sizeof(issues)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (getenv(&quot;DEBUG_CGI&quot;) == &quot;1&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">show_diagnostics();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">error_response(500, &quot;CGI environment error&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Your CGI code here - ALWAYS send headers first</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mixed err = catch {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Success\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;CGI Script Working!\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">};</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (err) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">error_response(500, sprintf(&quot;%O&quot;, err));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="writing-a-safe-cgi-program">Writing a Safe CGI Program<a href="#writing-a-safe-cgi-program" class="hash-link" aria-label="Direct link to Writing a Safe CGI Program" title="Direct link to Writing a Safe CGI Program" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Security-focused CGI programming with input validation and XSS prevention</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">import Protocols.HTTP;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Configuration constants</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">constant MAX_POST_SIZE = 1048576;         // 1MB limit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">constant MAX_FIELD_LENGTH = 1000;          // Per-field limit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">constant ALLOWED_TAGS = ([&quot;b&quot;:1, &quot;i&quot;:1, &quot;em&quot;:1, &quot;strong&quot;:1, &quot;p&quot;:1, &quot;br&quot;:1]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTML escape to prevent XSS attacks</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string html_escape(string s) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return replace(replace(replace(replace(s, &quot;&amp;&quot;, &quot;&amp;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;&quot;, &quot;&gt;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;\&quot;&quot;, &quot;&quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Strip dangerous HTML tags (basic XSS prevention)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sanitize_html(string html) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Remove script tags and content</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string result = replace(html, &quot; max_length) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Trim whitespace</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string result = String.trim_all(input);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check for null bytes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (has_value(result, &quot;\0&quot;)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Remove HTML unless explicitly allowed</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!allow_html) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result = html_escape(result);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result = sanitize_html(result);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return result;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Validate email format</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int is_valid_email(string email) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!email || sizeof(email)  254) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Basic email validation using Regexp</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return Regexp.simple(email, &quot;^[\\w._%+-]+@[\\w.-]+\\.[a-zA-Z]{2,}$&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Validate URL format</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int is_valid_url(string url) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!url) return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check for allowed protocols only</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) allowed = ({&quot;http://&quot;, &quot;https://&quot;, &quot;ftp://&quot;});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(allowed; string proto) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (has_prefix(url, proto)) return 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Rate limiting using simple file-based storage</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:int) rate_limits = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int rate_limit_window = 60;  // seconds</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int max_requests_per_window = 10;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int check_rate_limit(string identifier) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int now = time();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!rate_limits[identifier]) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">rate_limits[identifier] = now;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int last_request = rate_limits[identifier];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int elapsed = now - last_request;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (elapsed &gt;= rate_limit_window) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">rate_limits[identifier] = now;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;  // Rate limited</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CSRF token generation and validation</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string generate_csrf_token(string session_id) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string secret = getenv(&quot;CSRF_SECRET&quot;) || &quot;default-secret-change-me&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string timestamp = (string)time();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string data = session_id + timestamp + secret;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return String.hash2(data, &quot;SHA256&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Parse and validate form data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) parse_and_validate() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string data;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string method = getenv(&quot;REQUEST_METHOD&quot;) || &quot;GET&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (method == &quot;POST&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string content_length = getenv(&quot;CONTENT_LENGTH&quot;) || &quot;0&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int len = (int)content_length;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Enforce size limit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (len &gt; MAX_POST_SIZE) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: 413 Payload Too Large\r\n\r\nRequest too large.&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (len &gt; 0) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data = Stdio.File(stdin).read(len);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data = getenv(&quot;QUERY_STRING&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (data) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(data / &quot;&amp;&quot;; string pair) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) parts = pair / &quot;=&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (sizeof(parts) == 2) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|zero val = validate_string(</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Protocols.HTTP.http_decode_url(parts[1])</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (val) form[parts[0]] = val;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return form;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Send secure headers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void send_secure_headers() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;X-Content-Type-Options: nosniff\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;X-Frame-Options: SAMEORIGIN\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;X-XSS-Protection: 1; mode=block\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Example safe CGI handler</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check rate limit by IP</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string ip = getenv(&quot;REMOTE_ADDR&quot;) || &quot;unknown&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!check_rate_limit(ip)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: 429 Too Many Requests\r\n\r\nRate limit exceeded.&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form = parse_and_validate();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Validate email if provided</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (form-&gt;email &amp;&amp; !is_valid_email(form-&gt;email)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">send_secure_headers();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Invalid email address\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Safe output with all input escaped</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">send_secure_headers();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Safe CGI\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Safe Form Submission\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (form-&gt;name) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;Hello, %s!\n&quot;, form-&gt;name));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="making-cgi-scripts-efficient">Making CGI Scripts Efficient<a href="#making-cgi-scripts-efficient" class="hash-link" aria-label="Direct link to Making CGI Scripts Efficient" title="Direct link to Making CGI Scripts Efficient" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Efficiency techniques for CGI scripts in Pike</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">1. Use persistent connection for database access</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">constant DB_CACHE_FILE = &quot;/tmp/cgi_db_cache.pike&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Simple in-memory cache (process-specific)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:mixed) cache = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:int) cache_times = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int cache_ttl = 300;  // 5 minutes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Get value from cache if available and fresh</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mixed|zero cache_get(string key) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (cache[key] &amp;&amp; cache_times[key]) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (time() - cache_times[key] </span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string footer_template #</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">© 2024 My App</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Efficient string builder for large output</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class StringBuilder {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) parts = ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int total_size = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void append(string|mixed s) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string str = (string)s;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">parts += ({ str });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">total_size += sizeof(str);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void appendf(string fmt, mixed... args) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string str = sprintf(fmt, @args);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">parts += ({ str });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">total_size += sizeof(str);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string get() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return parts * &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int length() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return total_size;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">3. Lazy loading of expensive resources</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class LazyLoader {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mixed value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">function(:mixed) loader;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int loaded = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void create(function(:mixed) f) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">loader = f;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mixed get() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!loaded) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">value = loader();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">loaded = 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">4. Batched database queries (simulated)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(mapping) fetch_users_batch(array(int) user_ids) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// In production, use a single IN query instead of N queries</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// SELECT * FROM users WHERE id IN (1,2,3,...)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return ({});  // Simulated</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">5. Output buffering - send headers once, then body</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class BufferedOutput {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">StringBuilder buffer = StringBuilder();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int headers_sent = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) headers = ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;Content-Type&quot;: &quot;text/html; charset=utf-8&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void set_header(string name, string value) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">headers[name] = value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void write(string|mixed s) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">buffer-&gt;append(s);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void flush() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!headers_sent) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(headers; string name; string value) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;%s: %s\r\n&quot;, name, value));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">headers_sent = 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (buffer-&gt;length()) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(buffer-&gt;get());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">buffer = StringBuilder();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">6. Connection pooling helper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class ConnectionPool {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int max_connections;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(object) pool;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int created = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void create(int max) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">max_connections = max;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pool = ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">object|zero acquire() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (sizeof(pool)) return pop(pool);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (created set_header(&quot;X-Cache&quot;, &quot;HIT&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">out-&gt;write(cached);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">out-&gt;flush();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Build response efficiently</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">out-&gt;set_header(&quot;X-Cache&quot;, &quot;MISS&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">StringBuilder sb = StringBuilder();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sb-&gt;append(header_template);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sb-&gt;appendf(&quot;Efficient CGI Page&quot;, &quot;Efficient CGI Page&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Add dynamic content</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sb-&gt;append(&quot;Page generated at: &quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sb-&gt;append(ctime(time()));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sb-&gt;append(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sb-&gt;append(footer_template);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string response = sb-&gt;get();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Cache the response for GET requests</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (getenv(&quot;REQUEST_METHOD&quot;) == &quot;GET&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cache_set(cache_key, response);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">out-&gt;write(response);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">out-&gt;flush();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="executing-commands-without-shell-escapes">Executing Commands Without Shell Escapes<a href="#executing-commands-without-shell-escapes" class="hash-link" aria-label="Direct link to Executing Commands Without Shell Escapes" title="Direct link to Executing Commands Without Shell Escapes" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Safely execute external commands without shell interpolation</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">NEVER use system() or popen() with user input - always use Process.spawn()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">import Process;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">WRONG - DANGEROUS - allows shell injection</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// string input = getenv(&quot;QUERY_STRING&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// system(&quot;ls &quot; + input);  // DON&#x27;T DO THIS!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">RIGHT - SAFE - direct execution without shell</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string safe_exec(string... args) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Process.Process p = Process.spawn(args, ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;stdout&quot;: Process.PIPE,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;stderr&quot;: Process.PIPE,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;stdin&quot;: Process.PIPE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string output = p-&gt;stdout()-&gt;read();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string errors = p-&gt;stderr()-&gt;read();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int status = p-&gt;wait();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (status != 0) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;Error: &quot; + errors;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return output;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Validate filename to prevent path traversal</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int is_safe_filename(string name) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Reject empty names</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!name || sizeof(name) == 0) return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Reject path separators</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (has_value(name, &quot;/&quot;) || has_value(name, &quot;\\&quot;)) return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Reject path traversal attempts</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (has_value(name, &quot;..&quot;)) return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Only allow alphanumeric, underscore, dash, and dot</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int safe_chars = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for (int i = 0; i = &quot;a&quot; &amp;&amp; c = &quot;A&quot; &amp;&amp; c = &quot;0&quot; &amp;&amp; c stdout()-&gt;read();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string stderr = p-&gt;stderr()-&gt;read();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int exit_code = p-&gt;wait();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;stdout&quot;: stdout,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;stderr&quot;: stderr,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;exit_code&quot;: (string)exit_code,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;status&quot;: exit_code == 0 ? &quot;success&quot; : &quot;error&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Wrapper for handling file operations safely</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string safe_file_info(string filename) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!is_safe_filename(filename)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;Error: Invalid filename&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Use Process.spawn instead of system()</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return safe_exec(&quot;/usr/bin/file&quot;, &quot;/safe/uploads/&quot; + filename);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Example CGI handler for safe command execution</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/plain; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Example: Safe directory listing</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) args = ({ &quot;/bin/ls&quot;, &quot;-la&quot;, &quot;/safe&quot; });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) result = safe_command(args[0], args[1..]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Command Result:\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: &quot; + result[&quot;status&quot;] + &quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Exit code: &quot; + result[&quot;exit_code&quot;] + &quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\nOutput:\n&quot; + result[&quot;stdout&quot;]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (result[&quot;stderr&quot;]) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\nErrors:\n&quot; + result[&quot;stderr&quot;]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Also available: Process.popen() for reading command output</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">But always validate arguments before passing!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string safe_popen(string program, array(string) args) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string output = &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Process.Process p = Process.spawn(args, ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;stdout&quot;: Process.PIPE</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output = p-&gt;stdout()-&gt;read();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">p-&gt;wait();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return output;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="formatting-lists-and-tables-with-html-shortcuts">Formatting Lists and Tables with HTML Shortcuts<a href="#formatting-lists-and-tables-with-html-shortcuts" class="hash-link" aria-label="Direct link to Formatting Lists and Tables with HTML Shortcuts" title="Direct link to Formatting Lists and Tables with HTML Shortcuts" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTML helper functions for generating common UI elements</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTML tag builder helper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string tag(string name, string|void content, mapping(string:string)|void attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string attr_str = &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(attrs; string k; string v) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">attr_str += &quot; &quot; + k + &quot;=\&quot;&quot; + v + &quot;\&quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (content) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(&quot;%s&quot;, name, attr_str, content, name);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(&quot;&quot;, name, attr_str);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTML escape function</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string h(string s) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return replace(replace(replace(replace(s, &quot;&amp;&quot;, &quot;&amp;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;&quot;, &quot;&gt;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;\&quot;&quot;, &quot;&quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Unordered list generator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string ul(array(string) items, mapping(string:string)|void attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) lis = ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(items; string item) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">lis += ({ &quot;  &quot; + h(item) + &quot;&quot; });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;\n&quot; +</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">lis * &quot;\n&quot; + &quot;\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Ordered list generator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string ol(array(string) items, int|void start) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) lis = ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(items; string item) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">lis += ({ &quot;  &quot; + h(item) + &quot;&quot; });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string start_attr = start ? sprintf(&quot; start=\&quot;%d\&quot;&quot;, start) : &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;\n&quot; + (lis * &quot;\n&quot;) + &quot;\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Definition list generator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string dl(mapping(string:string) items) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) pairs = ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(items; string term; string definition) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pairs += ({ &quot;  &quot; + h(term) + &quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;  &quot; + h(definition) + &quot;&quot; });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;\n&quot; + (pairs * &quot;\n&quot;) + &quot;\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Table generator from array of arrays</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string table(array(array(string)) rows,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string)|void headers,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string)|void attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string attr_str = &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(attrs; string k; string v) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">attr_str += &quot; &quot; + k + &quot;=\&quot;&quot; + v + &quot;\&quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string html = &quot;\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Add header row if provided</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (headers) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;  \n    \n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(headers; string h) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += sprintf(&quot;      %s\n&quot;, h(h));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;    \n  \n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Add data rows</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;  \n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(rows; array(string) row; int row_idx) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += sprintf(&quot;    \n&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">row_idx % 2 ? &quot;odd&quot; : &quot;even&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(row; string cell) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += sprintf(&quot;      %s\n&quot;, h(cell));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;    \n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;  \n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return html;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Table from mapping (key-value pairs)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string kv_table(mapping(string:string) data,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void key_header,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void value_header) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(array(string)) rows = ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(data; string k; string v) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">rows += ({ ({ k, v }) });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) headers = ((key_header &amp;&amp; value_header) ? ({key_header, value_header}) : UNDEFINED);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return table(rows, headers);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Form generator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string form(string action,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void method,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void content,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string)|void attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!method) method = &quot;POST&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(&quot;%s&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">action, method,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">attrs ? &quot; enctype=\&quot;multipart/form-data\&quot;&quot; : &quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">content || &quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Select dropdown generator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string select(string name,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) options,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void selected) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string html = sprintf(&quot;\n&quot;, name);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(options; string opt) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sel = (opt == selected) ? &quot; selected&quot; : &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += sprintf(&quot;  %s\n&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">h(opt), sel, h(opt));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return html;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Checkbox generator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string checkbox(string name, string value, int|void checked) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string chk = checked ? &quot; checked&quot; : &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(&quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">name, h(value), chk);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Pagination links generator</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string pagination(int current, int total, int per_page) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int pages = (total + per_page - 1) / per_page;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string html = &quot;\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (current &gt; 1) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += sprintf(&quot;  Prev\n&quot;, current - 1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">for (int i = 1; i %d\n&quot;, i, cls, i);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (current Next\n&quot;, current + 1);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return html;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Example usage in CGI</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Sample data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) fruits = ({&quot;Apple&quot;, &quot;Banana&quot;, &quot;Cherry&quot;, &quot;Date&quot;});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(array(string)) users = ({</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">({&quot;Alice&quot;, &quot;alice@example.com&quot;, &quot;Admin&quot;}),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">({&quot;Bob&quot;, &quot;bob@example.com&quot;, &quot;User&quot;}),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">({&quot;Carol&quot;, &quot;carol@example.com&quot;, &quot;User&quot;})</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) headers = ({&quot;Name&quot;, &quot;Email&quot;, &quot;Role&quot;});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTML Helpers Demo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body { font-family: Arial, sans-serif; margin: 40px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">table { border-collapse: collapse; width: 100%; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">th { background: #4CAF50; color: white; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.even { background: #f2f2f2; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">ul, ol { margin: 20px 0; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTML Helpers Demo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Unordered List&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(ul(fruits));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Ordered List&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(ol(fruits, 5));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Definition List&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(dl(([&quot;Pike&quot;: &quot;A dynamic programming language&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;CGI&quot;: &quot;Common Gateway Interface&quot;])));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Data Table&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(table(users, headers, ([&quot;class&quot;: &quot;data-table&quot;])));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Pagination&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(pagination(2, 45, 10));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="redirecting-to-a-different-location">Redirecting to a Different Location<a href="#redirecting-to-a-different-location" class="hash-link" aria-label="Direct link to Redirecting to a Different Location" title="Direct link to Redirecting to a Different Location" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP redirects for CGI applications</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Simple 301 Moved Permanently redirect</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void redirect_permanent(string url) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: 301 Moved Permanently\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;Location: %s\r\n&quot;, url));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Moved</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">301 Moved Permanently</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">This resource has moved to %s.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;, url, url));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Temporary 302 Found redirect (common for POST-Redirect-GET pattern)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void redirect_temporary(string url) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: 302 Found\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;Location: %s\r\n&quot;, url));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Redirect</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">302 Found</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Redirecting to %s...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">window.location=&quot;%s&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;, url, url, url));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">303 See Other redirect (after POST to prevent resubmission)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void redirect_after_post(string url) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: 303 See Other\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;Location: %s\r\n&quot;, url));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">307 Temporary Redirect (preserves method)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void redirect_temp_preserve(string url) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Status: 307 Temporary Redirect\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;Location: %s\r\n&quot;, url));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Safe redirect with validation (prevent open redirect attacks)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int is_safe_url(string url) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Reject empty URLs</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!url) return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Allow relative URLs starting with /</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (has_prefix(url, &quot;/&quot;)) return 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Allow absolute URLs only from whitelist</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string host = getenv(&quot;HTTP_HOST&quot;) || &quot;localhost&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) allowed_hosts = ({ host, &quot;www.&quot; + host });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(allowed_hosts; string allowed) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (has_prefix(url, &quot;http://&quot; + allowed) ||</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">has_prefix(url, &quot;https://&quot; + allowed)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void safe_redirect(string|void url) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Default to home if URL is invalid</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!url || !is_safe_url(url)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">url = &quot;/&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redirect_temporary(url);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Build URL with query string</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string build_url(string base, mapping(string:string) params) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) pairs = ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(params; string key; string value) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string encoded_key = Protocols.HTTP.http_encode_url(key);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string encoded_value = Protocols.HTTP.http_encode_url(value);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pairs += ({ encoded_key + &quot;=&quot; + encoded_value });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string separator = has_value(base, &quot;?&quot;) ? &quot;&amp;&quot; : &quot;?&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return base + separator + pairs * &quot;&amp;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Refresh meta redirect (client-side fallback)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void meta_redirect(string url, int|void delay) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!delay) delay = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Redirecting...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body{font-family:Arial,sans-serif;text-align:center;margin-top:100px;}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Redirecting...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Please wait while we redirect you to %s.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">setTimeout(function(){window.location=&quot;%s&quot;;},%d*1000);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;, delay, url, url,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">delay == 0 ? &quot; style=\&quot;display:none\&quot;&quot; : &quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">url, url, delay));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Example: POST-Redirect-GET pattern to prevent form resubmission</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void handle_form_post() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Process the form data...</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Store success message in session or cookie</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set_cookie(&quot;flash_message&quot;, &quot;Form submitted successfully!&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Redirect to GET page</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">redirect_after_post(&quot;/thank-you&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Simple cookie setting helper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void set_cookie(string name, string value,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int|void lifetime,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void path,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void domain) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!path) path = &quot;/&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!lifetime) lifetime = 3600;  // 1 hour default</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int expiry = time() + lifetime;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string date = Calendar.Second(expiry)-&gt;format_http();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string cookie = sprintf(&quot;%s=%s; Expires=%s; Path=%s&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">name, value, date, path);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (domain) cookie += &quot;; Domain=&quot; + domain;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Set cookie via Set-Cookie header</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;Set-Cookie: %s\r\n&quot;, cookie));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Example usage</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string redirect_target = getenv(&quot;QUERY_STRING&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (redirect_target) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Parse the target parameter</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) params = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(redirect_target / &quot;&amp;&quot;; string pair) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) parts = pair / &quot;=&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (sizeof(parts) == 2) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">params[parts[0]] = Protocols.HTTP.http_decode_url(parts[1]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Safely redirect to target (prevents open redirect attacks)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">safe_redirect(params-&gt;url);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Show a page with redirect examples</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Redirect Examples</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP Redirect Examples</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Temporary redirect (302)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Safe redirect</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Default redirect</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="debugging-the-raw-http-exchange">Debugging the Raw HTTP Exchange<a href="#debugging-the-raw-http-exchange" class="hash-link" aria-label="Direct link to Debugging the Raw HTTP Exchange" title="Direct link to Debugging the Raw HTTP Exchange" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP debugging tools for CGI applications</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">import Protocols.HTTP;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Log file for HTTP debugging</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">constant DEBUG_LOG = &quot;/tmp/http_debug.log&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Write debug information to log file</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void debug_log(string message) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string timestamp = Calendar.now()-&gt;format_time();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Stdio.File f = Stdio.File();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (f-&gt;open(DEBUG_LOG, &quot;wac&quot;)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">f-&gt;write(sprintf(&quot;[%s] %s\n&quot;, timestamp, message));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">f-&gt;close();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Dump all HTTP headers received</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string dump_request_headers() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string output = &quot;=== HTTP Request Headers ===\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Standard CGI environment variables that represent headers</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) http_vars = ({</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;HTTP_ACCEPT&quot;, &quot;HTTP_ACCEPT_CHARSET&quot;, &quot;HTTP_ACCEPT_ENCODING&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;HTTP_ACCEPT_LANGUAGE&quot;, &quot;HTTP_AUTHORIZATION&quot;, &quot;HTTP_CONNECTION&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;HTTP_COOKIE&quot;, &quot;HTTP_HOST&quot;, &quot;HTTP_REFERER&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;HTTP_USER_AGENT&quot;, &quot;HTTP_X_FORWARDED_FOR&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(http_vars; string var) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string value = getenv(var);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (value) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Convert HTTP_XXX to readable header name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string header_name = replace(var-&gt;substring(5), &quot;_&quot;, &quot;-&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += sprintf(&quot;%s: %s\n&quot;, header_name, value);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return output;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Dump all CGI environment variables</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string dump_cgi_environment() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string output = &quot;=== CGI Environment ===\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) cgi_vars = ({</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;REQUEST_METHOD&quot;, &quot;REQUEST_URI&quot;, &quot;QUERY_STRING&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;CONTENT_TYPE&quot;, &quot;CONTENT_LENGTH&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;SCRIPT_NAME&quot;, &quot;PATH_INFO&quot;, &quot;PATH_TRANSLATED&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;SERVER_NAME&quot;, &quot;SERVER_PORT&quot;, &quot;SERVER_PROTOCOL&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;REMOTE_ADDR&quot;, &quot;REMOTE_HOST&quot;, &quot;REMOTE_USER&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;AUTH_TYPE&quot;, &quot;DOCUMENT_ROOT&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(cgi_vars; string var) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string value = getenv(var);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += sprintf(&quot;%s: %s\n&quot;, var, value || &quot;(not set)&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return output;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Read and dump raw POST data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string dump_post_data() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string output = &quot;=== POST Data ===\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string method = getenv(&quot;REQUEST_METHOD&quot;) || &quot;GET&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string content_type = getenv(&quot;CONTENT_TYPE&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += sprintf(&quot;Method: %s\n&quot;, method);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += sprintf(&quot;Content-Type: %s\n&quot;, content_type);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (method == &quot;POST&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string length = getenv(&quot;CONTENT_LENGTH&quot;) || &quot;0&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += sprintf(&quot;Content-Length: %s\n&quot;, length);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int len = (int)length;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (len &gt; 0 &amp;&amp; len = 2) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += sprintf(&quot;%s: %s\n&quot;, parts[0], parts[1] * &quot;=&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return output;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Generate full HTTP request dump</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string dump_full_request() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string output = &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += dump_cgi_environment();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += &quot;\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += dump_request_headers();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += &quot;\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += dump_cookies();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += &quot;\n&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output += dump_post_data();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return output;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Save request info to debug log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void log_request() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string remote = getenv(&quot;REMOTE_ADDR&quot;) || &quot;unknown&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string method = getenv(&quot;REQUEST_METHOD&quot;) || &quot;UNKNOWN&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string uri = getenv(&quot;REQUEST_URI&quot;) || &quot;/&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">debug_log(sprintf(&quot;%s %s from %s&quot;, method, uri, remote));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Pretty HTML output for debugging</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string html_debug_output() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string output = dump_full_request();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Escape HTML and wrap in  tags</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output = replace(replace(replace(output, &quot;&quot;, &quot;&gt;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;\n&quot;, &quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP Debug Info</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body { font-family: monospace; margin: 20px; background: #1e1e1e; color: #d4d4d4; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">h1 { color: #4ec9b0; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.section { color: #569cd6; font-weight: bold; margin-top: 20px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">pre { background: #252526; padding: 15px; border-radius: 5px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP Request Debug Information</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Timestamp: %s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output, ctime(time()));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Main debug CGI handler</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Always log requests</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">log_request();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check if debugging is enabled</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string debug = getenv(&quot;DEBUG_HTTP&quot;) || getenv(&quot;QUERY_STRING&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (debug == &quot;1&quot; || debug == &quot;debug&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(html_debug_output());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Normal request handling</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP Debug Tool</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body{font-family:Arial,sans-serif;margin:40px;text-align:center;}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTTP Debug Tool</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Add ?debug to URL to see full HTTP request dump.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">All requests are logged to: /tmp/http_debug.log</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="managing-cookies">Managing Cookies<a href="#managing-cookies" class="hash-link" aria-label="Direct link to Managing Cookies" title="Direct link to Managing Cookies" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Cookie management for CGI applications</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Parse Cookie header into mapping</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) parse_cookies() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) cookies = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string cookie_header = getenv(&quot;HTTP_COOKIE&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (cookie_header != &quot;&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(cookie_header / &quot;;&quot;; string cookie) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string trimmed = String.trim_all(cookie);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int pos = search(trimmed, &quot;=&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (pos &gt; 0) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string name = trimmed[0..pos-1];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string value = trimmed[pos+1..];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cookies[name] = value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return cookies;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Cookie attributes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class CookieAttributes {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int|void max_age;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int|void expires;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void domain;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void path;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int|void secure;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int|void http_only;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void same_site;  // &quot;Strict&quot;, &quot;Lax&quot;, or &quot;None&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void create(string _value,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:mixed)|void attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">value = _value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">max_age = attrs[&quot;max_age&quot;];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">expires = attrs[&quot;expires&quot;];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">domain = attrs[&quot;domain&quot;];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">path = attrs[&quot;path&quot;];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">secure = attrs[&quot;secure&quot;];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">http_only = attrs[&quot;http_only&quot;];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">same_site = attrs[&quot;same_site&quot;];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string format() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string result = value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (max_age) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result += sprintf(&quot;; Max-Age=%d&quot;, max_age);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (expires) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string date = Calendar.Second(expires)-&gt;format_http();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result += &quot;; Expires=&quot; + date;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (path) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result += &quot;; Path=&quot; + path;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (domain) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result += &quot;; Domain=&quot; + domain;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (secure) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result += &quot;; Secure&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (http_only) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result += &quot;; HttpOnly&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (same_site) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">result += &quot;; SameSite=&quot; + same_site;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return result;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Set a cookie with full attribute support</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void set_cookie(string name,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|CookieAttributes value_or_attrs,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:mixed)|void attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">CookieAttributes cookie_attrs;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (objectp(value_or_attrs)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cookie_attrs = value_or_attrs;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">cookie_attrs = CookieAttributes(value_or_attrs, attrs);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string cookie = sprintf(&quot;%s=%s&quot;, name, cookie_attrs-&gt;format());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;Set-Cookie: %s\r\n&quot;, cookie));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Delete a cookie by setting max-age=0</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void delete_cookie(string name, string|void path) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (!path) path = &quot;/&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set_cookie(name, &quot;&quot;, ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;max_age&quot;: 0,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;path&quot;: path,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;expires&quot;: 1  // Unix timestamp 1 = past</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Session management using cookies</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class Session {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string session_id;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:mixed) data = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int created;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int last_activity;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int timeout = 1800;  // 30 minutes</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void create(string|void id) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">created = time();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">last_activity = created;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (id) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session_id = id;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session_id = generate_session_id();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string generate_session_id() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string data = sprintf(&quot;%d.%s.%d&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">time(),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">String.string2hex(Crypto.Random.random_string(16)),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">getpid());</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return String.hash2(data, &quot;SHA256&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int is_expired() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return (time() - last_activity) &gt; timeout;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void touch() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">last_activity = time();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mixed get(string key) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return data[key];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void set(string key, mixed value) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data[key] = value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">touch();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">In-memory session store (for production, use database)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:Session) sessions = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Session|zero get_session(string|void session_id) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Clean up expired sessions first</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach (indices(sessions); string id) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (sessions[id]-&gt;is_expired()) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">m_delete(sessions, id);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (session_id &amp;&amp; sessions[session_id]) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Session s = sessions[session_id];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">s-&gt;touch();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return s;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Create new session</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Session new_session = Session();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">sessions[new_session-&gt;session_id] = new_session;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return new_session;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Send session cookie</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void send_session_cookie(Session session) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">set_cookie(&quot;session_id&quot;, session-&gt;session_id, ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;http_only&quot;: 1,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;same_site&quot;: &quot;Lax&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;path&quot;: &quot;/&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;max_age&quot;: 3600</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">]));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Example usage: Counter with session persistence</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Get session from cookie</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) cookies = parse_cookies();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Session session = get_session(cookies[&quot;session_id&quot;]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Handle actions</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string action = getenv(&quot;QUERY_STRING&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (action == &quot;increment&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int count = (int)(session-&gt;get(&quot;count&quot;) || &quot;0&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session-&gt;set(&quot;count&quot;, (string)(count + 1));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else if (action == &quot;reset&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session-&gt;set(&quot;count&quot;, &quot;0&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Ensure session cookie is set</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">send_session_cookie(session);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Send response</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int count = (int)(session-&gt;get(&quot;count&quot;) || &quot;0&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Session Counter</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body { font-family: Arial, sans-serif; margin: 40px; text-align: center; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.counter { font-size: 48px; margin: 20px 0; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">button { padding: 10px 20px; font-size: 16px; cursor: pointer; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Session Counter</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Session ID: %s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%d</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Increment</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Reset</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Refresh to persist. Close browser to end session.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">session-&gt;session_id, count));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="creating-sticky-widgets">Creating Sticky Widgets<a href="#creating-sticky-widgets" class="hash-link" aria-label="Direct link to Creating Sticky Widgets" title="Direct link to Creating Sticky Widgets" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sticky widgets preserve user input across form submissions</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTML escape function</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string h(string s) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return replace(replace(replace(replace(s, &quot;&amp;&quot;, &quot;&amp;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;&quot;, &quot;&gt;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;\&quot;&quot;, &quot;&quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Parse form data from GET or POST</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) parse_form() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string data;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string method = getenv(&quot;REQUEST_METHOD&quot;) || &quot;GET&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (method == &quot;POST&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string length = getenv(&quot;CONTENT_LENGTH&quot;) || &quot;0&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if ((int)length &gt; 0) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data = Stdio.File(stdin).read((int)length);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data = getenv(&quot;QUERY_STRING&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (data) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(data / &quot;&amp;&quot;; string pair) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) parts = pair / &quot;=&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (sizeof(parts) == 2) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">form[parts[0]] = Protocols.HTTP.http_decode_url(parts[1]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return form;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sticky text input</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sticky_input(string name,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void value,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string)|void attrs,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Use submitted value or default</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string display_value = form[name] || value || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string attr_str = sprintf(&quot;name=\&quot;%s\&quot; value=\&quot;%s\&quot;&quot;, name, h(display_value));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(attrs; string k; string v) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">attr_str += sprintf(&quot; %s=\&quot;%s\&quot;&quot;, k, h(v));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sticky textarea</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sticky_textarea(string name,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void value,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string)|void attrs,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string display_value = form[name] || value || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string attr_str = sprintf(&quot;name=\&quot;%s\&quot;&quot;, name);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(attrs; string k; string v) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">attr_str += sprintf(&quot; %s=\&quot;%s\&quot;&quot;, k, h(v));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(&quot;%s&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">attr_str, h(display_value));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sticky checkbox</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sticky_checkbox(string name,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string value,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int|void default_checked,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string)|void attrs,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Check if this checkbox was submitted</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int checked = default_checked || 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (form[name] == value) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">checked = 1;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">} else if (indices(form) [name] &amp;&amp; form[name] != value) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Checkbox exists in form but has different value = unchecked</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">checked = 0;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string attr_str = sprintf(&quot;type=\&quot;checkbox\&quot; name=\&quot;%s\&quot; value=\&quot;%s\&quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">name, h(value));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (checked) attr_str += &quot; checked&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (attrs) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(attrs; string k; string v) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">attr_str += sprintf(&quot; %s=\&quot;%s\&quot;&quot;, k, h(v));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sticky radio button group</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sticky_radio(string name,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(array(string)) options,  // ({({value, label}), ...})</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void selected,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string current = form[name] || selected || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string html = &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(options; array(string) option) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string value = option[0];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string label = option[1];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sel = (value == current) ? &quot; checked&quot; : &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += sprintf(&quot; %s\n&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">name, h(value), sel, h(label));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return html;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sticky select dropdown</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sticky_select(string name,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(array(string)) options,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|void selected,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">int|void multiple,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string current = form[name] || selected || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string html = sprintf(&quot;\n&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">name, multiple ? &quot; multiple&quot; : &quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(options; array(string) option) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string value = option[0];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string label = option[1];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sel = (value == current) ? &quot; selected&quot; : &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += sprintf(&quot;  %s\n&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">h(value), sel, h(label));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return html;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sticky multiselect (returns array of values)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sticky_multiselect(string name,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(array(string)) options,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string)|void selected,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Parse multiple values from form (e.g., &quot;name=val1&amp;name=val2&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) current = selected || ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Collect all submitted values for this name</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// (In a real implementation, you&#x27;d parse all values for the same key)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (form[name] &amp;&amp; form[name] != &quot;&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">current = ({ form[name] });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string html = sprintf(&quot;\n&quot;, name);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(options; array(string) option) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string value = option[0];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string label = option[1];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string sel = has_value(current, value) ? &quot; selected&quot; : &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += sprintf(&quot;  %s\n&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">h(value), sel, h(label));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">html += &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return html;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Complete sticky form example</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form = parse_form();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sticky Form Demo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body { font-family: Arial, sans-serif; margin: 40px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">fieldset { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">legend { font-weight: bold; padding: 0 10px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">label { display: block; margin: 10px 0 5px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">input[type=&quot;text&quot;], textarea, select { width: 300px; padding: 8px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">textarea { height: 80px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">button { padding: 10px 20px; cursor: pointer; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.result { background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 20px 0; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Sticky Form Widgets Demo</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Submit the form - your values will be preserved!&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Show submitted values</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (sizeof(form)) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Submitted values:\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(form; string k; string v) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(sprintf(&quot;%s: %s\n&quot;, k, h(v)));</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Generate sticky form</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  \n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    Personal Information\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    Name:\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    &quot; + sticky_input(&quot;name&quot;, &quot;Enter your name&quot;, ([&quot;placeholder&quot;: &quot;John Doe&quot;]), form) + &quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    Email:\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    &quot; + sticky_input(&quot;email&quot;, &quot;&quot;, ([&quot;type&quot;: &quot;email&quot;, &quot;placeholder&quot;: &quot;john@example.com&quot;]), form) + &quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  \n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  \n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    Preferences\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    Favorite Color:\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    &quot; + sticky_select(&quot;color&quot;, ({</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">({&quot;red&quot;, &quot;Red&quot;}), ({&quot;green&quot;, &quot;Green&quot;}), ({&quot;blue&quot;, &quot;Blue&quot;}), ({&quot;purple&quot;, &quot;Purple&quot;})</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}), &quot;blue&quot;, 0, form) + &quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    &quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  \n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    Options\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    &quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;      &quot; + sticky_checkbox(&quot;subscribe&quot;, &quot;yes&quot;, 1, ([]), form) + &quot; Subscribe to newsletter\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    \n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  \n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  \n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    Message\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    &quot;Your message:\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;    &quot; + sticky_textarea(&quot;message&quot;, &quot;Type here...&quot;, ([&quot;rows&quot;: &quot;4&quot;]), form) + &quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  \n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  Submit\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;  Reset\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="writing-a-multiscreen-cgi-script">Writing a Multiscreen CGI Script<a href="#writing-a-multiscreen-cgi-script" class="hash-link" aria-label="Direct link to Writing a Multiscreen CGI Script" title="Direct link to Writing a Multiscreen CGI Script" translate="no">​</a></h3>
<div class="language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-pike codeBlock_bY9V thin-scrollbar" style="color:#bfc7d5;background-color:#292d3e"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma strict_types</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">#pragma no_clone</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Multiscreen/state-driven CGI application with navigation</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">HTML escape function</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string h(string s) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return replace(replace(replace(replace(s, &quot;&amp;&quot;, &quot;&amp;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;&quot;, &quot;&gt;&quot;),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;\&quot;&quot;, &quot;&quot;&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Parse form data</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) parse_form() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string data = getenv(&quot;QUERY_STRING&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string method = getenv(&quot;REQUEST_METHOD&quot;) || &quot;GET&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (method == &quot;POST&quot;) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string length = getenv(&quot;CONTENT_LENGTH&quot;) || &quot;0&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if ((int)length &gt; 0) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data = Stdio.File(stdin).read((int)length);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (data) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">foreach(data / &quot;&amp;&quot;; string pair) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) parts = pair / &quot;=&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (sizeof(parts) == 2) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">form[parts[0]] = Protocols.HTTP.http_decode_url(parts[1]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return form;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Application state (session data)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">class AppState {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string current_screen;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) data = ([]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) errors = ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) messages = ({});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void create(string starting_screen) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">current_screen = starting_screen;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void set_screen(string screen) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">current_screen = screen;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void set_data(string key, string value) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">data[key] = value;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string|zero get_data(string key) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return data[key];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void add_error(string error) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">errors += ({ error });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void add_message(string message) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">messages += ({ message });</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Navigation helper</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string nav_link(string screen, string label) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(&quot;%s&quot;, screen, label);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Render common header</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string render_header(AppState state) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Multi-Screen App - %s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nav { background: #333; padding: 15px 20px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nav a { color: white; text-decoration: none; margin-right: 20px; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nav a:hover { text-decoration: underline; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nav a.active { font-weight: bold; color: #4CAF50; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.container { max-width: 800px; margin: 30px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 4px; margin: 10px 0; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">.message { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 4px; margin: 10px 0; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">h1 { margin-top: 0; color: #333; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">label { display: block; margin: 15px 0 5px; font-weight: bold; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">input, select, textarea { width: 100%%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">button { background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">button:hover { background: #45a049; }</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">%s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">String.capitalize(state-&gt;current_screen),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nav_link(&quot;home&quot;, &quot;Home&quot;) + &quot; &quot; +</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nav_link(&quot;form&quot;, &quot;Form&quot;) + &quot; &quot; +</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nav_link(&quot;confirm&quot;, &quot;Confirm&quot;) + &quot; &quot; +</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">nav_link(&quot;result&quot;, &quot;Result&quot;)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Render common footer</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string render_footer() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return &quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Screen: Home</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string screen_home(AppState state) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return render_header(state) + sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Welcome to the Multi-Screen Application</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">This is a demonstration of a state-driven CGI application in Pike.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Navigate through the screens using the menu above:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Home - This page</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Form - Enter your information</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Confirm - Review before submitting</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Result - See the final output</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Get Started</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;) + render_footer();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Screen: Form</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string screen_form(AppState state, mapping(string:string) form) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string name = form[&quot;name&quot;] || state-&gt;get_data(&quot;name&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string email = form[&quot;email&quot;] || state-&gt;get_data(&quot;email&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string interest = form[&quot;interest&quot;] || state-&gt;get_data(&quot;interest&quot;) || &quot;coding&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return render_header(state) + sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Enter Your Information</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Name:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Email:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Area of Interest:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Programming</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Design</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Business</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Other</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Continue to Confirm</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">h(name), h(email),</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">interest == &quot;coding&quot; ? &quot; selected&quot; : &quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">interest == &quot;design&quot; ? &quot; selected&quot; : &quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">interest == &quot;business&quot; ? &quot; selected&quot; : &quot;&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">interest == &quot;other&quot; ? &quot; selected&quot; : &quot;&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) + render_footer();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Screen: Confirm</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string screen_confirm(AppState state, mapping(string:string) form) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Save form data to state</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (form[&quot;name&quot;]) state-&gt;set_data(&quot;name&quot;, form[&quot;name&quot;]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (form[&quot;email&quot;]) state-&gt;set_data(&quot;email&quot;, form[&quot;email&quot;]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (form[&quot;interest&quot;]) state-&gt;set_data(&quot;interest&quot;, form[&quot;interest&quot;]);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string name = state-&gt;get_data(&quot;name&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string email = state-&gt;get_data(&quot;email&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string interest = state-&gt;get_data(&quot;interest&quot;) || &quot;&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string interest_label = ([</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;coding&quot;: &quot;Programming&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;design&quot;: &quot;Design&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;business&quot;: &quot;Business&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;other&quot;: &quot;Other&quot;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">])[interest] || interest;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return render_header(state) + sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Confirm Your Information</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Please review the information below before submitting:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Name:%s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Email:%s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Interest:%s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Confirm &amp; Submit</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Go Back</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">h(name), h(email), h(interest_label)</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) + render_footer();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Screen: Result</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string screen_result(AppState state) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string name = state-&gt;get_data(&quot;name&quot;) || &quot;Guest&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string ref_num = &quot;REF-&quot; + String.string2hex(Crypto.Random.random_string(4))[0..7];</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">return render_header(state) + sprintf(#</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Thank You!</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Submission Successful</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Your information has been recorded.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Name: %s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Reference Number: %s</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">We&#x27;ve sent a confirmation email to your address.</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Return Home</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">&quot;,</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">h(name), ref_num</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">) + render_footer();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">Main application router</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">void main() {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">mapping(string:string) form = parse_form();</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string screen = form[&quot;screen&quot;] || &quot;home&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Valid screens</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">array(string) valid_screens = ({&quot;home&quot;, &quot;form&quot;, &quot;confirm&quot;, &quot;result&quot;});</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">if (search(valid_screens, screen) == -1) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">screen = &quot;home&quot;;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Create application state</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">AppState state = AppState(screen);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Route to appropriate screen</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">string output;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">switch (screen) {</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case &quot;home&quot;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output = screen_home(state);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">break;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case &quot;form&quot;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output = screen_form(state, form);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">break;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case &quot;confirm&quot;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output = screen_confirm(state, form);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">break;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">case &quot;result&quot;:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output = screen_result(state);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">break;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">default:</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">output = screen_home(state);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">break;</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">// Send response</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(&quot;Content-Type: text/html; charset=utf-8\r\n\r\n&quot;);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">write(output);</span><br></span><span class="token-line" style="color:#bfc7d5"><span class="token plain">}</span><br></span></code></pre></div></div>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="saving-a-form-to-a-file-or-mail-pipe">Saving a Form to a File or Mail Pipe<a href="#saving-a-form-to-a-file-or-mail-pipe" class="hash-link" aria-label="Direct link to Saving a Form to a File or Mail Pipe" title="Direct link to Saving a Form to a File or Mail Pipe" translate="no">​</a></h3>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"></code></pre>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="program-chemiserie">Program: chemiserie<a href="#program-chemiserie" class="hash-link" aria-label="Direct link to Program: chemiserie" title="Direct link to Program: chemiserie" translate="no">​</a></h3>
<pre tabindex="0" class="codeBlockStandalone_MEMb thin-scrollbar language-pike codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#bfc7d5;--prism-background-color:#292d3e"><code class="codeBlockLines_e6Vv"></code></pre></div><footer class="theme-doc-footer docusaurus-mt-lg"><div class="row margin-top--sm theme-doc-footer-edit-meta-row"><div class="col noPrint_WFHX"><a href="https://github.com/smuks/pike-cookbook/tree/main/docs/network/cgi-programming.md" target="_blank" rel="noopener noreferrer" class="theme-edit-this-page"><svg fill="currentColor" height="20" width="20" viewBox="0 0 40 40" class="iconEdit_Z9Sw" aria-hidden="true"><g><path d="m34.5 11.7l-3 3.1-6.3-6.3 3.1-3q0.5-0.5 1.2-0.5t1.1 0.5l3.9 3.9q0.5 0.4 0.5 1.1t-0.5 1.2z m-29.5 17.1l18.4-18.5 6.3 6.3-18.4 18.4h-6.3v-6.2z"></path></g></svg>Edit this page</a></div><div class="col lastUpdated_JAkA"></div></div></footer></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/pike-cookbook/docs/files/database-access"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Database Access</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/pike-cookbook/docs/network/sockets"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Sockets</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#19-cgi-programming" class="table-of-contents__link toc-highlight">19. CGI Programming</a><ul><li><a href="#introduction-to-cgi-programming" class="table-of-contents__link toc-highlight">Introduction to CGI Programming</a></li><li><a href="#writing-a-cgi-script" class="table-of-contents__link toc-highlight">Writing a CGI Script</a></li><li><a href="#redirecting-error-messages" class="table-of-contents__link toc-highlight">Redirecting Error Messages</a></li><li><a href="#fixing-a-500-server-error" class="table-of-contents__link toc-highlight">Fixing a 500 Server Error</a></li><li><a href="#writing-a-safe-cgi-program" class="table-of-contents__link toc-highlight">Writing a Safe CGI Program</a></li><li><a href="#making-cgi-scripts-efficient" class="table-of-contents__link toc-highlight">Making CGI Scripts Efficient</a></li><li><a href="#executing-commands-without-shell-escapes" class="table-of-contents__link toc-highlight">Executing Commands Without Shell Escapes</a></li><li><a href="#formatting-lists-and-tables-with-html-shortcuts" class="table-of-contents__link toc-highlight">Formatting Lists and Tables with HTML Shortcuts</a></li><li><a href="#redirecting-to-a-different-location" class="table-of-contents__link toc-highlight">Redirecting to a Different Location</a></li><li><a href="#debugging-the-raw-http-exchange" class="table-of-contents__link toc-highlight">Debugging the Raw HTTP Exchange</a></li><li><a href="#managing-cookies" class="table-of-contents__link toc-highlight">Managing Cookies</a></li><li><a href="#creating-sticky-widgets" class="table-of-contents__link toc-highlight">Creating Sticky Widgets</a></li><li><a href="#writing-a-multiscreen-cgi-script" class="table-of-contents__link toc-highlight">Writing a Multiscreen CGI Script</a></li><li><a href="#saving-a-form-to-a-file-or-mail-pipe" class="table-of-contents__link toc-highlight">Saving a Form to a File or Mail Pipe</a></li><li><a href="#program-chemiserie" class="table-of-contents__link toc-highlight">Program: chemiserie</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer footer--dark"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Docs</div><ul class="footer__items clean-list"><li class="footer__item"><a class="footer__link-item" href="/pike-cookbook/docs/intro">Cookbook</a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">Community</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/smuks/pike-cookbook" target="_blank" rel="noopener noreferrer" class="footer__link-item">GitHub<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div><div class="theme-layout-footer-column col footer__col"><div class="footer__title">More</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://pike.lysator.liu.se/" target="_blank" rel="noopener noreferrer" class="footer__link-item">Pike Homepage<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2026 Built with Docusaurus.</div></div></div></footer></div>
</body>
</html>