<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>CGI Programming</TITLE
><META
NAME="GENERATOR"
CONTENT="Modular DocBook HTML Stylesheet Version 1.79"><LINK
REL="HOME"
TITLE="PLEAC-Pike
"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Internet Services"
HREF="internetservices.html"><LINK
REL="NEXT"
TITLE="Web Automation"
HREF="webautomation.html"><style type="text/css">    <!--
      .comment {
        /* font-lock-comment-face */
        color: #bebebe;
      }
      .comment-delimiter {
      }
      .constant {
        /* font-lock-constant-face */
        color: #ff7f50;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #b2dfee;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #ffa500;
      }
      .number {
        /* font-lock-number-face */
        color: #cdcd00;
      }
      .punctuation {
        /* font-lock-punctuation-face */
        color: #00ffff;
      }
      .string {
        /* font-lock-string-face */
        color: #00cd00;
      }
      .type {
        /* font-lock-type-face */
        color: #98fb98;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #9ac0cd;
      }
    -->
    </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Pike
</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="CGIPROGRAMMING"
>19. CGI Programming</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1007"
>Introduction to CGI Programming</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.1: CGI Basics and Environment Variables - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="comment-delimiter">// </span><span class="comment">CGI (Common Gateway Interface) allows web servers to execute programs</span>
<span class="comment-delimiter">// </span><span class="comment">and display their output. Pike provides built-in CGI support through</span>
<span class="comment-delimiter">// </span><span class="comment">various modules including Protocols.HTTP and CGI.</span>

<span class="comment-delimiter">// </span><span class="comment">Environment variables available in CGI:</span>
<span class="comment-delimiter">// </span><span class="comment">REQUEST_METHOD, QUERY_STRING, CONTENT_TYPE, CONTENT_LENGTH</span>
<span class="comment-delimiter">// </span><span class="comment">SCRIPT_NAME, PATH_INFO, PATH_TRANSLATED, SERVER_NAME, SERVER_PORT</span>
<span class="comment-delimiter">// </span><span class="comment">HTTP_USER_AGENT, HTTP_REFERER, HTTP_COOKIE, REMOTE_ADDR, etc.</span>

<span class="keyword">import</span> <span class="module">Standards</span><span class="punctuation">.</span><span class="module">JSON</span><span class="punctuation">;</span>

<span class="comment-delimiter">// </span><span class="comment">Display all CGI environment variables</span>
<span class="type">void</span> show_env_vars<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html\r\n\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;!DOCTYPE html&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;html&gt;&lt;head&gt;&lt;title&gt;CGI Environment&lt;/title&gt;&lt;/head&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;body&gt;&lt;h1&gt;CGI Environment Variables&lt;/h1&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;table border='1'&gt;\n"</span><span class="punctuation">);</span>

    <span class="keyword">foreach</span><span class="punctuation">(</span><span class="function-name">getenv</span><span class="punctuation">();</span> <span class="type">string</span> key<span class="punctuation">;</span> <span class="type">string</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;tr&gt;&lt;td&gt;%s&lt;/td&gt;&lt;td&gt;%s&lt;/td&gt;&lt;/tr&gt;\n"</span><span class="punctuation">,</span>
                 key<span class="punctuation">,</span> value<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;/table&gt;&lt;/body&gt;&lt;/html&gt;\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Simple JSON endpoint</span>
<span class="type">void</span> json_endpoint<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> data <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"method"</span><span class="punctuation">:</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"UNKNOWN"</span><span class="punctuation">,</span>
        <span class="string">"query"</span><span class="punctuation">:</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"QUERY_STRING"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">,</span>
        <span class="string">"user_agent"</span><span class="punctuation">:</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"HTTP_USER_AGENT"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"Unknown"</span><span class="punctuation">,</span>
        <span class="string">"remote_addr"</span><span class="punctuation">:</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REMOTE_ADDR"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"Unknown"</span>
    <span class="punctuation">]);</span>

    <span class="type">string</span> json <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">encode</span><span class="punctuation">(</span>data<span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: application/json\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Access-Control-Allow-Origin: *\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span>json<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Main entry point - determine response type based on Accept header</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> accept <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"HTTP_ACCEPT"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">has_prefix</span><span class="punctuation">(</span>accept<span class="punctuation">,</span> <span class="string">"application/json"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="function-name">json_endpoint</span><span class="punctuation">();</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="function-name">show_env_vars</span><span class="punctuation">();</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment">-------------</span>
</PRE
></TD
></TR
></TABLE
></DIV>
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1010"
>Writing a CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.2: Writing a CGI Script - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">A complete CGI script that handles GET and POST requests</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">HTTP</span><span class="punctuation">;</span>

<span class="comment-delimiter">// </span><span class="comment">URL decoding function</span>
<span class="type">string</span> url_decode<span class="punctuation">(</span><span class="type">string</span> s<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>s<span class="punctuation">,</span> <span class="string">"+"</span><span class="punctuation">,</span> <span class="string">" "</span><span class="punctuation">),</span>
            <span class="string">"%20"</span><span class="punctuation">,</span> <span class="string">" "</span><span class="punctuation">),</span>
            <span class="string">"\\\\"</span><span class="punctuation">,</span> <span class="string">"\"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">URL encoding function</span>
<span class="type">string</span> url_encode<span class="punctuation">(</span><span class="type">string</span> s<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">http_encode_url</span><span class="punctuation">(</span>s<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Parse query string or POST data into a mapping</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> parse_form_data<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
    <span class="type">string</span> data<span class="punctuation">;</span>

    <span class="type">string</span> method <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"GET"</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>method <span class="punctuation">==</span> <span class="string">"GET"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        data <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"QUERY_STRING"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span>method <span class="punctuation">==</span> <span class="string">"POST"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">int</span> length <span class="punctuation">=</span> <span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)(</span><span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"CONTENT_LENGTH"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"0"</span><span class="punctuation">);</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>length <span class="punctuation">&gt;</span> <span class="number">0</span> <span class="punctuation">&amp;&amp;</span> length <span class="punctuation">&lt;</span> <span class="number">1048576</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            data <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">(</span><span class="constant">stdin</span><span class="punctuation">).</span><span class="function-name">read</span><span class="punctuation">(</span>length<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>data <span class="punctuation">/</span> <span class="string">"&amp;"</span><span class="punctuation">;</span> <span class="type">string</span> pair<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> parts <span class="punctuation">=</span> pair <span class="punctuation">/</span> <span class="string">"="</span><span class="punctuation">;</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>parts<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                form<span class="punctuation">[</span>parts<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]]</span> <span class="punctuation">=</span> <span class="function-name">url_decode</span><span class="punctuation">(</span>parts<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]);</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> form<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">HTML escape function to prevent XSS</span>
<span class="type">string</span> html_escape<span class="punctuation">(</span><span class="type">string</span> s<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>s<span class="punctuation">,</span>
            <span class="string">"&amp;"</span><span class="punctuation">,</span> <span class="string">"&amp;amp;"</span><span class="punctuation">),</span>
            <span class="string">"&lt;"</span><span class="punctuation">,</span> <span class="string">"&amp;lt;"</span><span class="punctuation">),</span>
            <span class="string">"&gt;"</span><span class="punctuation">,</span> <span class="string">"&amp;gt;"</span><span class="punctuation">),</span>
            <span class="string">"\""</span><span class="punctuation">,</span> <span class="string">"&amp;quot;"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Send HTTP headers</span>
<span class="type">void</span> send_headers<span class="punctuation">(</span><span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> content_type<span class="punctuation">,</span> <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> status<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>content_type<span class="punctuation">)</span> content_type <span class="punctuation">=</span> <span class="string">"text/html"</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>status<span class="punctuation">)</span> status <span class="punctuation">=</span> <span class="number">200</span><span class="punctuation">;</span>

    <span class="type">string</span> status_text <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="number">200</span><span class="punctuation">:</span> <span class="string">"OK"</span><span class="punctuation">,</span>
        <span class="number">301</span><span class="punctuation">:</span> <span class="string">"Moved Permanently"</span><span class="punctuation">,</span>
        <span class="number">302</span><span class="punctuation">:</span> <span class="string">"Found"</span><span class="punctuation">,</span>
        <span class="number">400</span><span class="punctuation">:</span> <span class="string">"Bad Request"</span><span class="punctuation">,</span>
        <span class="number">404</span><span class="punctuation">:</span> <span class="string">"Not Found"</span><span class="punctuation">,</span>
        <span class="number">500</span><span class="punctuation">:</span> <span class="string">"Internal Server Error"</span>
    <span class="punctuation">])[</span>status<span class="punctuation">]</span> <span class="punctuation">||</span> <span class="string">"OK"</span><span class="punctuation">;</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: %d %s\r\n"</span><span class="punctuation">,</span> status<span class="punctuation">,</span> status_text<span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: %s; charset=utf-8\r\n"</span><span class="punctuation">,</span> content_type<span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\r\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Generate HTML form</span>
<span class="type">string</span> generate_form<span class="punctuation">(</span><span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> values<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> name <span class="punctuation">=</span> <span class="function-name">html_escape</span><span class="punctuation">(</span>values<span class="punctuation">-&gt;</span>name <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">);</span>
    <span class="type">string</span> email <span class="punctuation">=</span> <span class="function-name">html_escape</span><span class="punctuation">(</span>values<span class="punctuation">-&gt;</span>email <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">);</span>
    <span class="type">string</span> message <span class="punctuation">=</span> <span class="function-name">html_escape</span><span class="punctuation">(</span>values<span class="punctuation">-&gt;</span>message <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">);</span>

    <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Contact Form&lt;/title&gt;
&lt;style&gt;
    body { font-family: Arial, sans-serif; margin: 40px; }
    input, textarea { display: block; margin: 10px 0; padding: 8px; }
    button { padding: 10px 20px; cursor: pointer; }
&lt;/style&gt;
&lt;/head&gt;&lt;body&gt;
    &lt;h1&gt;Contact Form&lt;/h1&gt;
    &lt;form method="POST" action=""&gt;
        &lt;label&gt;Name:&lt;/label&gt;
        &lt;input type="text" name="name" value="%s" required&gt;
        &lt;label&gt;Email:&lt;/label&gt;
        &lt;input type="email" name="email" value="%s" required&gt;
        &lt;label&gt;Message:&lt;/label&gt;
        &lt;textarea name="message" rows="5" required&gt;%s&lt;/textarea&gt;
        &lt;button type="submit"&gt;Submit&lt;/button&gt;
    &lt;/form&gt;
&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">,</span> name<span class="punctuation">,</span> email<span class="punctuation">,</span> message<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Process form submission</span>
<span class="type">string</span> process_form<span class="punctuation">(</span><span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Validate required fields</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>form<span class="punctuation">-&gt;</span>name <span class="punctuation">||</span> <span class="punctuation">!</span><span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">trim_all</span><span class="punctuation">(</span>form<span class="punctuation">-&gt;</span>name<span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="string">"&lt;h1&gt;Error&lt;/h1&gt;&lt;p&gt;Name is required.&lt;/p&gt;"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>form<span class="punctuation">-&gt;</span>email <span class="punctuation">||</span> <span class="punctuation">!</span><span class="function-name">has_suffix</span><span class="punctuation">(</span>form<span class="punctuation">-&gt;</span>email<span class="punctuation">,</span> <span class="string">"@"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="string">"&lt;h1&gt;Error&lt;/h1&gt;&lt;p&gt;Valid email is required.&lt;/p&gt;"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">In production, save to database or send email</span>
    <span class="type">string</span> name <span class="punctuation">=</span> <span class="function-name">html_escape</span><span class="punctuation">(</span>form<span class="punctuation">-&gt;</span>name<span class="punctuation">);</span>
    <span class="type">string</span> email <span class="punctuation">=</span> <span class="function-name">html_escape</span><span class="punctuation">(</span>form<span class="punctuation">-&gt;</span>email<span class="punctuation">);</span>
    <span class="type">string</span> message <span class="punctuation">=</span> <span class="function-name">html_escape</span><span class="punctuation">(</span>form<span class="punctuation">-&gt;</span>message <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">);</span>

    <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Thank You&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Thank You!&lt;/h1&gt;
    &lt;p&gt;Your message has been received:&lt;/p&gt;
    &lt;pre&gt;
Name: %s
Email: %s
Message: %s
    &lt;/pre&gt;
&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">,</span> name<span class="punctuation">,</span> email<span class="punctuation">,</span> message<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Main entry point</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form <span class="punctuation">=</span> <span class="function-name">parse_form_data</span><span class="punctuation">();</span>
    <span class="type">string</span> output<span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">)</span> <span class="punctuation">==</span> <span class="string">"POST"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        output <span class="punctuation">=</span> <span class="function-name">process_form</span><span class="punctuation">(</span>form<span class="punctuation">);</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        output <span class="punctuation">=</span> <span class="function-name">generate_form</span><span class="punctuation">(</span>form<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="function-name">send_headers</span><span class="punctuation">();</span>
    <span class="function-name">write</span><span class="punctuation">(</span>output<span class="punctuation">);</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1013"
>Redirecting Error Messages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.3: Redirecting Error Messages - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">Capture and redirect error messages to browser instead of server log</span>

<span class="keyword">constant</span> ERROR_LOG_FILE <span class="punctuation">=</span> <span class="string">"/tmp/cgi_errors.log"</span><span class="punctuation">;</span>

<span class="comment-delimiter">// </span><span class="comment">Custom error handler that captures errors</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> error_data <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span>
    <span class="string">"has_error"</span><span class="punctuation">:</span> <span class="string">"0"</span><span class="punctuation">,</span>
    <span class="string">"error_message"</span><span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span>
    <span class="string">"backtrace"</span><span class="punctuation">:</span> <span class="string">""</span>
<span class="punctuation">]);</span>

<span class="comment-delimiter">// </span><span class="comment">Install error handler at the start of your CGI script</span>
<span class="type">void</span> install_error_handler<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="function-name">master</span><span class="punctuation">()-&gt;</span><span class="function-name">set_inhibit_compile_errors</span><span class="punctuation">(</span><span class="keyword">lambda</span><span class="punctuation">(</span><span class="type">mixed</span> err<span class="punctuation">)</span> <span class="punctuation">{</span>
        error_data<span class="punctuation">[</span><span class="string">"has_error"</span><span class="punctuation">]</span> <span class="punctuation">=</span> <span class="string">"1"</span><span class="punctuation">;</span>
        error_data<span class="punctuation">[</span><span class="string">"error_message"</span><span class="punctuation">]</span> <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%O"</span><span class="punctuation">,</span> err<span class="punctuation">);</span>
    <span class="punctuation">});</span>

    <span class="comment-delimiter">// </span><span class="comment">Redirect stderr to a file</span>
    <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">(</span>ERROR_LOG_FILE<span class="punctuation">,</span> <span class="string">"wac"</span><span class="punctuation">)-&gt;</span><span class="function-name">dup2</span><span class="punctuation">(</span><span class="constant">stderr</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Send error page to browser</span>
<span class="type">void</span> send_error_page<span class="punctuation">(</span><span class="type">string</span> title<span class="punctuation">,</span> <span class="type">string</span> message<span class="punctuation">,</span> <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> backtrace<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: 500 Internal Server Error\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\r\n"</span><span class="punctuation">);</span>

    <span class="type">string</span> safe_title <span class="punctuation">=</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>title<span class="punctuation">,</span> <span class="string">"&lt;"</span><span class="punctuation">,</span> <span class="string">"&amp;lt;"</span><span class="punctuation">),</span> <span class="string">"&gt;"</span><span class="punctuation">,</span> <span class="string">"&amp;gt;"</span><span class="punctuation">),</span> <span class="string">"\""</span><span class="punctuation">,</span> <span class="string">"&amp;quot;"</span><span class="punctuation">);</span>
    <span class="type">string</span> safe_message <span class="punctuation">=</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>message<span class="punctuation">,</span> <span class="string">"\n"</span><span class="punctuation">,</span> <span class="string">"&lt;br&gt;\n"</span><span class="punctuation">),</span> <span class="string">"&lt;"</span><span class="punctuation">,</span> <span class="string">"&amp;lt;"</span><span class="punctuation">),</span> <span class="string">"&gt;"</span><span class="punctuation">,</span> <span class="string">"&amp;gt;"</span><span class="punctuation">);</span>
    <span class="type">string</span> safe_backtrace <span class="punctuation">=</span> backtrace <span class="punctuation">?</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>backtrace<span class="punctuation">,</span> <span class="string">"\n"</span><span class="punctuation">,</span> <span class="string">"&lt;br&gt;\n"</span><span class="punctuation">),</span> <span class="string">"&lt;"</span><span class="punctuation">,</span> <span class="string">"&amp;lt;"</span><span class="punctuation">)</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Error&lt;/title&gt;
&lt;style&gt;
    body { font-family: Arial, sans-serif; margin: 40px; background: #f0f0f0; }
    .error-box { background: #fff; border-left: 4px solid #d32f2f; padding: 20px; }
    .error-title { color: #d32f2f; margin-top: 0; }
    .error-message { white-space: pre-wrap; }
    .backtrace { background: #f5f5f5; padding: 15px; margin-top: 20px;
                  font-family: monospace; font-size: 12px; }
&lt;/style&gt;
&lt;/head&gt;&lt;body&gt;
    &lt;div class="error-box"&gt;
        &lt;h1 class="error-title"&gt;%s&lt;/h1&gt;
        &lt;div class="error-message"&gt;%s&lt;/div&gt;</span><span class="string">"</span><span class="punctuation">,</span> safe_title<span class="punctuation">,</span> safe_message<span class="punctuation">);</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>safe_backtrace <span class="punctuation">!=</span> <span class="string">""</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"        &lt;div class=\"backtrace\"&gt;&lt;strong&gt;Backtrace:&lt;/strong&gt;&lt;br&gt;%s&lt;/div&gt;\n"</span><span class="punctuation">,</span> safe_backtrace<span class="punctuation">));</span>
    <span class="punctuation">}</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    &lt;/div&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;/body&gt;&lt;/html&gt;\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Log error to file with timestamp</span>
<span class="type">void</span> log_error<span class="punctuation">(</span><span class="type">string</span> message<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> timestamp <span class="punctuation">=</span> <span class="function-name">Calendar</span><span class="punctuation">.</span><span class="function-name">now</span><span class="punctuation">()-&gt;</span><span class="function-name">format_time</span><span class="punctuation">();</span>
    <span class="type">string</span> remote <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REMOTE_ADDR"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"unknown"</span><span class="punctuation">;</span>
    <span class="type">string</span> uri <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_URI"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"unknown"</span><span class="punctuation">;</span>

    <span class="type">string</span> log_entry <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"[%s] %s %s: %s\n"</span><span class="punctuation">,</span> timestamp<span class="punctuation">,</span> remote<span class="punctuation">,</span> uri<span class="punctuation">,</span> message<span class="punctuation">);</span>

    <span class="type">Stdio</span><span class="punctuation">.</span><span class="type">File</span> f <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">();</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>f<span class="punctuation">-&gt;</span><span class="function-name">open</span><span class="punctuation">(</span>ERROR_LOG_FILE<span class="punctuation">,</span> <span class="string">"wac"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
        f<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">write</span><span class="punctuation">(</span>log_entry<span class="punctuation">);</span>
        f<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">close</span><span class="punctuation">();</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Wrapper function for safe execution</span>
<span class="type">mixed</span> safe_execute<span class="punctuation">(</span><span class="type">function</span><span class="punctuation">(</span><span class="punctuation">)</span><span class="punctuation">:</span><span class="type">mixed</span> cb<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="function-name">install_error_handler</span><span class="punctuation">();</span>

    <span class="keyword">mixed</span> result <span class="punctuation">=</span> <span class="function-name">catch</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="function-name">cb</span><span class="punctuation">();</span>
    <span class="punctuation">};</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>result<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="comment-delimiter">// </span><span class="comment">Error was caught</span>
        <span class="type">string</span> err_msg <span class="punctuation">=</span> <span class="function-name">describe_error</span><span class="punctuation">(</span>result<span class="punctuation">);</span>
        <span class="function-name">log_error</span><span class="punctuation">(</span>err_msg<span class="punctuation">);</span>
        <span class="function-name">send_error_page</span><span class="punctuation">(</span><span class="string">"Application Error"</span><span class="punctuation">,</span> err_msg<span class="punctuation">,</span> <span class="function-name">backtrace</span><span class="punctuation">());</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>error_data<span class="punctuation">[</span><span class="string">"has_error"</span><span class="punctuation">]</span> == <span class="string">"1"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">log_error</span><span class="punctuation">(</span>error_data<span class="punctuation">[</span><span class="string">"error_message"</span><span class="punctuation">]);</span>
        <span class="function-name">send_error_page</span><span class="punctuation">(</span><span class="string">"Compilation Error"</span><span class="punctuation">,</span> error_data<span class="punctuation">[</span><span class="string">"error_message"</span><span class="punctuation">]);</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="keyword">UNDEFINED</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Example usage</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="keyword">mixed</span> err <span class="punctuation">=</span> <span class="function-name">safe_execute</span><span class="punctuation">(</span><span class="keyword">lambda</span><span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="comment-delimiter">// </span><span class="comment">Your CGI code here</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html\r\n\r\n"</span><span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;Hello World!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;\n"</span><span class="punctuation">);</span>
    <span class="punctuation">});</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>err<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="comment-delimiter">// </span><span class="comment">Error was already handled by safe_execute</span>
        <span class="keyword">return</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1016"
>Fixing a 500 Server Error</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.4: Fixing a 500 Server Error - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">Common causes of 500 errors and how to debug them</span>

<span class="comment-delimiter">// </span><span class="comment">1. Check file permissions (must be executable)</span>
<span class="comment-delimiter">// </span><span class="comment">$ chmod +x yourscript.pike</span>

<span class="comment-delimiter">// </span><span class="comment">2. Check shebang line at top of file</span>
<span class="comment-delimiter">// </span><span class="comment">#!/usr/bin/pike8</span>

<span class="comment-delimiter">// </span><span class="comment">3. Ensure proper HTTP headers are sent FIRST</span>
<span class="type">void</span> debug_cgi<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> debug <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"DEBUG_CGI"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>debug <span class="punctuation">==</span> <span class="string">"1"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="comment-delimiter">// </span><span class="comment">Enable verbose error output for debugging</span>
        <span class="function-name">master</span><span class="punctuation">()-&gt;</span><span class="function-name">set_inhibit_compile_errors</span><span class="punctuation">(</span><span class="number">0</span><span class="punctuation">);</span>
        <span class="function-name">add_constant</span><span class="punctuation">(</span><span class="string">"verbose_errors"</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Common 500 error causes checklist</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> check_environment<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> issues <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>

    <span class="comment-delimiter">// </span><span class="comment">Check if we have required CGI environment variables</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span><span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
        issues<span class="punctuation">[</span><span class="string">"no_cgi_env"</span><span class="punctuation">]</span> <span class="punctuation">=</span> <span class="string">"Not running in CGI environment"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Check if we can write to stdout</span>
    <span class="type">Stdio</span><span class="punctuation">.</span><span class="type">File</span> stdout_file <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">(</span><span class="constant">stdout</span><span class="punctuation">);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>stdout_file <span class="punctuation">||</span> stdout_file<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">is_open</span><span class="punctuation">())</span> <span class="punctuation">{</span>
        issues<span class="punctuation">[</span><span class="string">"stdout_closed"</span><span class="punctuation">]</span> <span class="punctuation">=</span> <span class="string">"Cannot write to stdout"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> issues<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Send proper error response</span>
<span class="type">void</span> error_response<span class="punctuation">(</span><span class="type">int</span> code<span class="punctuation">,</span> <span class="type">string</span> message<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> title <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="number">400</span><span class="punctuation">:</span> <span class="string">"Bad Request"</span><span class="punctuation">,</span>
        <span class="number">404</span><span class="punctuation">:</span> <span class="string">"Not Found"</span><span class="punctuation">,</span>
        <span class="number">500</span><span class="punctuation">:</span> <span class="string">"Internal Server Error"</span><span class="punctuation">,</span>
        <span class="number">503</span><span class="punctuation">:</span> <span class="string">"Service Unavailable"</span>
    <span class="punctuation">])[</span>code<span class="punctuation">]</span> <span class="punctuation">||</span> <span class="string">"Error"</span><span class="punctuation">;</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: %d %s\r\n"</span><span class="punctuation">,</span> code<span class="punctuation">,</span> title<span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;%d %s&lt;/title&gt;
&lt;style&gt;body{font-family:Arial,sans-serif;margin:40px;text-align:center;}&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;&lt;h1&gt;%d %s&lt;/h1&gt;&lt;p&gt;%s&lt;/p&gt;&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">,</span>
            code<span class="punctuation">,</span> title<span class="punctuation">,</span> code<span class="punctuation">,</span> title<span class="punctuation">,</span> message<span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Validate CGI script syntax before execution</span>
<span class="type">int</span> validate_script<span class="punctuation">(</span><span class="type">string</span> script_path<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> content<span class="punctuation">;</span>
    <span class="type">Stdio</span><span class="punctuation">.</span><span class="type">File</span> f <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">();</span>

    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>f<span class="punctuation">-&gt;</span><span class="function-name">open</span><span class="punctuation">(</span>script_path<span class="punctuation">,</span> <span class="string">"r"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">Cannot open file</span>
    <span class="punctuation">}</span>

    content <span class="punctuation">=</span> f<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">read</span><span class="punctuation">();</span>
    f<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">close</span><span class="punctuation">();</span>

    <span class="comment-delimiter">// </span><span class="comment">Check for shebang</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span><span class="function-name">has_prefix</span><span class="punctuation">(</span>content<span class="punctuation">,</span> <span class="string">"#!"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">Missing shebang</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Check for main() function</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span><span class="function-name">has_value</span><span class="punctuation">(</span>content<span class="punctuation">,</span> <span class="string">"void main()"</span><span class="punctuation">)</span> <span class="punctuation">&amp;&amp;</span>
        <span class="punctuation">!</span><span class="function-name">has_value</span><span class="punctuation">(</span>content<span class="punctuation">,</span> <span class="string">"int main()"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">Missing main() function</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="number">1</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Debug helper - outputs diagnostic information</span>
<span class="type">void</span> show_diagnostics<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/plain\r\n\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"CGI Diagnostics\n===============\n\n"</span><span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Environment Variables:\n"</span><span class="punctuation">);</span>
    <span class="keyword">foreach</span> <span class="punctuation">(</span><span class="function-name">getenv</span><span class="punctuation">();</span> <span class="type">string</span> k<span class="punctuation">;</span> <span class="type">string</span> v<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  %s: %s\n"</span><span class="punctuation">,</span> k<span class="punctuation">,</span> v<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"\nPike Version: %s\n"</span><span class="punctuation">,</span> <span class="function-name">__VERSION__</span><span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Current Working Directory: %s\n"</span><span class="punctuation">,</span> <span class="function-name">getcwd</span><span class="punctuation">()));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Example CGI script with proper error handling</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Enable debugging if requested</span>
    <span class="function-name">debug_cgi</span><span class="punctuation">();</span>

    <span class="comment-delimiter">// </span><span class="comment">Check environment</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> issues <span class="punctuation">=</span> <span class="function-name">check_environment</span><span class="punctuation">();</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>issues<span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"DEBUG_CGI"</span><span class="punctuation">)</span> <span class="punctuation">==</span> <span class="string">"1"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">show_diagnostics</span><span class="punctuation">();</span>
        <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
            <span class="function-name">error_response</span><span class="punctuation">(</span><span class="number">500</span><span class="punctuation">,</span> <span class="string">"CGI environment error"</span><span class="punctuation">);</span>
        <span class="punctuation">}</span>
        <span class="keyword">return</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Your CGI code here - ALWAYS send headers first</span>
    <span class="keyword">mixed</span> err <span class="punctuation">=</span> <span class="function-name">catch</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;!DOCTYPE html&gt;\n"</span><span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Success&lt;/title&gt;&lt;/head&gt;\n"</span><span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;body&gt;&lt;h1&gt;CGI Script Working!&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;\n"</span><span class="punctuation">);</span>
    <span class="punctuation">};</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>err<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">error_response</span><span class="punctuation">(</span><span class="number">500</span><span class="punctuation">,</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%O"</span><span class="punctuation">,</span> err<span class="punctuation">));</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1019"
>Writing a Safe CGI Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.5: Writing a Safe CGI Program - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">Security-focused CGI programming with input validation and XSS prevention</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">HTTP</span><span class="punctuation">;</span>

<span class="comment-delimiter">// </span><span class="comment">Configuration constants</span>
<span class="keyword">constant</span> MAX_POST_SIZE <span class="punctuation">=</span> <span class="number">1048576</span><span class="punctuation">;</span>         <span class="comment-delimiter">// </span><span class="comment">1MB limit</span>
<span class="keyword">constant</span> MAX_FIELD_LENGTH <span class="punctuation">=</span> <span class="number">1000</span><span class="punctuation">;</span>          <span class="comment-delimiter">// </span><span class="comment">Per-field limit</span>
<span class="keyword">constant</span> ALLOWED_TAGS <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="string">"b"</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span> <span class="string">"i"</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span> <span class="string">"em"</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span> <span class="string">"strong"</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span> <span class="string">"p"</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">,</span> <span class="string">"br"</span><span class="punctuation">:</span><span class="number">1</span><span class="punctuation">]);</span>

<span class="comment-delimiter">// </span><span class="comment">HTML escape to prevent XSS attacks</span>
<span class="type">string</span> html_escape<span class="punctuation">(</span><span class="type">string</span> s<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>s<span class="punctuation">,</span> <span class="string">"&amp;"</span><span class="punctuation">,</span> <span class="string">"&amp;amp;"</span><span class="punctuation">),</span>
            <span class="string">"&lt;"</span><span class="punctuation">,</span> <span class="string">"&amp;lt;"</span><span class="punctuation">),</span>
            <span class="string">"&gt;"</span><span class="punctuation">,</span> <span class="string">"&amp;gt;"</span><span class="punctuation">),</span>
            <span class="string">"\""</span><span class="punctuation">,</span> <span class="string">"&amp;quot;"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Strip dangerous HTML tags (basic XSS prevention)</span>
<span class="type">string</span> sanitize_html<span class="punctuation">(</span><span class="type">string</span> html<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Remove script tags and content</span>
    <span class="type">string</span> result <span class="punctuation">=</span> <span class="function-name">replace</span><span class="punctuation">(</span>html<span class="punctuation">,</span> <span class="string">"&lt;script"</span><span class="punctuation">,</span> <span class="string">""</span><span class="punctuation">);</span>
    result <span class="punctuation">=</span> <span class="function-name">replace</span><span class="punctuation">(</span>result<span class="punctuation">,</span> <span class="string">"&lt;/script"</span><span class="punctuation">,</span> <span class="string">""</span><span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Remove on* event handlers</span>
    result <span class="punctuation">=</span> <span class="function-name">Regexp</span><span class="punctuation">.</span><span class="function-name">replace</span><span class="punctuation">(</span>result<span class="punctuation">,</span> <span class="string">"\\bon\\w+\\s*="</span><span class="punctuation">,</span> <span class="string">""</span><span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Remove javascript: protocol</span>
    result <span class="punctuation">=</span> <span class="function-name">replace</span><span class="punctuation">(</span>result<span class="punctuation">,</span> <span class="string">"javascript:"</span><span class="punctuation">,</span> <span class="string">""</span><span class="punctuation">);</span>

    <span class="keyword">return</span> result<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Validate and sanitize string input</span>
<span class="type">string</span><span class="punctuation">|</span><span class="keyword">zero</span> validate_string<span class="punctuation">(</span><span class="type">string</span> input<span class="punctuation">,</span>
                                   <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> max_length<span class="punctuation">,</span>
                                   <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> allow_html<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>max_length<span class="punctuation">)</span> max_length <span class="punctuation">=</span> MAX_FIELD_LENGTH<span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Check length</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>input<span class="punctuation">)</span> <span class="punctuation">&gt;</span> max_length<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Trim whitespace</span>
    <span class="type">string</span> result <span class="punctuation">=</span> <span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">trim_all</span><span class="punctuation">(</span>input<span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Check for null bytes</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">has_value</span><span class="punctuation">(</span>result<span class="punctuation">,</span> <span class="string">"\0"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Remove HTML unless explicitly allowed</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>allow_html<span class="punctuation">)</span> <span class="punctuation">{</span>
        result <span class="punctuation">=</span> <span class="function-name">html_escape</span><span class="punctuation">(</span>result<span class="punctuation">);</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        result <span class="punctuation">=</span> <span class="function-name">sanitize_html</span><span class="punctuation">(</span>result<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> result<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Validate email format</span>
<span class="type">int</span> is_valid_email<span class="punctuation">(</span><span class="type">string</span> email<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>email <span class="punctuation">||</span> <span class="function-name">sizeof</span><span class="punctuation">(</span>email<span class="punctuation">)</span> <span class="punctuation">&lt;</span> <span class="number">3</span> <span class="punctuation">||</span> <span class="function-name">sizeof</span><span class="punctuation">(</span>email<span class="punctuation">)</span> <span class="punctuation">&gt;</span> <span class="number">254</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Basic email validation using Regexp</span>
    <span class="keyword">return</span> <span class="function-name">Regexp</span><span class="punctuation">.</span><span class="function-name">simple</span><span class="punctuation">(</span>email<span class="punctuation">,</span> <span class="string">"^[\\w._%+-]+@[\\w.-]+\\.[a-zA-Z]{2,}$"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Validate URL format</span>
<span class="type">int</span> is_valid_url<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>url<span class="punctuation">)</span> <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Check for allowed protocols only</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> allowed <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"http://"</span><span class="punctuation">,</span> <span class="string">"https://"</span><span class="punctuation">,</span> <span class="string">"ftp://"</span><span class="punctuation">});</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>allowed<span class="punctuation">;</span> <span class="type">string</span> proto<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">has_prefix</span><span class="punctuation">(</span>url<span class="punctuation">,</span> proto<span class="punctuation">))</span> <span class="keyword">return</span> <span class="number">1</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Rate limiting using simple file-based storage</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">int</span><span class="punctuation">)</span> rate_limits <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
<span class="type">int</span> rate_limit_window <span class="punctuation">=</span> <span class="number">60</span><span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">seconds</span>
<span class="type">int</span> max_requests_per_window <span class="punctuation">=</span> <span class="number">10</span><span class="punctuation">;</span>

<span class="type">int</span> check_rate_limit<span class="punctuation">(</span><span class="type">string</span> identifier<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">int</span> now <span class="punctuation">=</span> <span class="function-name">time</span><span class="punctuation">();</span>

    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>rate_limits<span class="punctuation">[</span>identifier<span class="punctuation">])</span> <span class="punctuation">{</span>
        rate_limits<span class="punctuation">[</span>identifier<span class="punctuation">]</span> <span class="punctuation">=</span> now<span class="punctuation">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">int</span> last_request <span class="punctuation">=</span> rate_limits<span class="punctuation">[</span>identifier<span class="punctuation">];</span>
    <span class="type">int</span> elapsed <span class="punctuation">=</span> now <span class="punctuation">-</span> last_request<span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>elapsed <span class="punctuation">&gt;=</span> rate_limit_window<span class="punctuation">)</span> <span class="punctuation">{</span>
        rate_limits<span class="punctuation">[</span>identifier<span class="punctuation">]</span> <span class="punctuation">=</span> now<span class="punctuation">;</span>
        <span class="keyword">return</span> <span class="number">1</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">Rate limited</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">CSRF token generation and validation</span>
<span class="type">string</span> generate_csrf_token<span class="punctuation">(</span><span class="type">string</span> session_id<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> secret <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"CSRF_SECRET"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"default-secret-change-me"</span><span class="punctuation">;</span>
    <span class="type">string</span> timestamp <span class="punctuation">=</span> <span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span><span class="function-name">time</span><span class="punctuation">();</span>
    <span class="type">string</span> data <span class="punctuation">=</span> session_id <span class="punctuation">+</span> timestamp <span class="punctuation">+</span> secret<span class="punctuation">;</span>
    <span class="keyword">return</span> <span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">hash2</span><span class="punctuation">(</span>data<span class="punctuation">,</span> <span class="string">"SHA256"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Parse and validate form data</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> parse_and_validate<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
    <span class="type">string</span> data<span class="punctuation">;</span>

    <span class="type">string</span> method <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"GET"</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>method <span class="punctuation">==</span> <span class="string">"POST"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> content_length <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"CONTENT_LENGTH"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"0"</span><span class="punctuation">;</span>
        <span class="type">int</span> len <span class="punctuation">=</span> <span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span>content_length<span class="punctuation">;</span>

        <span class="comment-delimiter">// </span><span class="comment">Enforce size limit</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>len <span class="punctuation">&gt;</span> MAX_POST_SIZE<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: 413 Payload Too Large\r\n\r\nRequest too large."</span><span class="punctuation">);</span>
            <span class="keyword">return</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
        <span class="punctuation">}</span>

        <span class="keyword">if</span> <span class="punctuation">(</span>len <span class="punctuation">&gt;</span> <span class="number">0</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            data <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">(</span><span class="constant">stdin</span><span class="punctuation">).</span><span class="function-name">read</span><span class="punctuation">(</span>len<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        data <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"QUERY_STRING"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>data <span class="punctuation">/</span> <span class="string">"&amp;"</span><span class="punctuation">;</span> <span class="type">string</span> pair<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> parts <span class="punctuation">=</span> pair <span class="punctuation">/</span> <span class="string">"="</span><span class="punctuation">;</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>parts<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="type">string</span><span class="punctuation">|</span><span class="keyword">zero</span> val <span class="punctuation">=</span> <span class="function-name">validate_string</span><span class="punctuation">(</span>
                    <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">http_decode_url</span><span class="punctuation">(</span>parts<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">])</span>
                <span class="punctuation">);</span>
                <span class="keyword">if</span> <span class="punctuation">(</span>val<span class="punctuation">)</span> form<span class="punctuation">[</span>parts<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]]</span> <span class="punctuation">=</span> val<span class="punctuation">;</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> form<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Send secure headers</span>
<span class="type">void</span> send_secure_headers<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"X-Content-Type-Options: nosniff\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"X-Frame-Options: SAMEORIGIN\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"X-XSS-Protection: 1; mode=block\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\r\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Example safe CGI handler</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Check rate limit by IP</span>
    <span class="type">string</span> ip <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REMOTE_ADDR"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"unknown"</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span><span class="function-name">check_rate_limit</span><span class="punctuation">(</span>ip<span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: 429 Too Many Requests\r\n\r\nRate limit exceeded."</span><span class="punctuation">);</span>
        <span class="keyword">return</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form <span class="punctuation">=</span> <span class="function-name">parse_and_validate</span><span class="punctuation">();</span>

    <span class="comment-delimiter">// </span><span class="comment">Validate email if provided</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>form<span class="punctuation">-&gt;</span>email <span class="punctuation">&amp;&amp;</span> <span class="punctuation">!</span><span class="function-name">is_valid_email</span><span class="punctuation">(</span>form<span class="punctuation">-&gt;</span>email<span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="function-name">send_secure_headers</span><span class="punctuation">();</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;html&gt;&lt;body&gt;&lt;h1&gt;Invalid email address&lt;/h1&gt;&lt;/body&gt;&lt;/html&gt;\n"</span><span class="punctuation">);</span>
        <span class="keyword">return</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Safe output with all input escaped</span>
    <span class="function-name">send_secure_headers</span><span class="punctuation">();</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;!DOCTYPE html&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;html&gt;&lt;head&gt;&lt;title&gt;Safe CGI&lt;/title&gt;&lt;/head&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;body&gt;&lt;h1&gt;Safe Form Submission&lt;/h1&gt;\n"</span><span class="punctuation">);</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>form<span class="punctuation">-&gt;</span>name<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;p&gt;Hello, %s!&lt;/p&gt;\n"</span><span class="punctuation">,</span> form<span class="punctuation">-</span><span class="punctuation">&gt;</span>name<span class="punctuation">));</span>
    <span class="punctuation">}</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;/body&gt;&lt;/html&gt;\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1022"
>Making CGI Scripts Efficient</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.6: Making CGI Scripts Efficient - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">Efficiency techniques for CGI scripts in Pike</span>

<span class="comment-delimiter">// </span><span class="comment">1. Use persistent connection for database access</span>
<span class="keyword">constant</span> DB_CACHE_FILE <span class="punctuation">=</span> <span class="string">"/tmp/cgi_db_cache.pike"</span><span class="punctuation">;</span>

<span class="comment-delimiter">// </span><span class="comment">Simple in-memory cache (process-specific)</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span> cache <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">int</span><span class="punctuation">)</span> cache_times <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
<span class="type">int</span> cache_ttl <span class="punctuation">=</span> <span class="number">300</span><span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">5 minutes</span>

<span class="comment-delimiter">// </span><span class="comment">Get value from cache if available and fresh</span>
<span class="type">mixed</span><span class="punctuation">|</span><span class="keyword">zero</span> cache_get<span class="punctuation">(</span><span class="type">string</span> key<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>cache<span class="punctuation">[</span>key<span class="punctuation">]</span> <span class="punctuation">&amp;&amp;</span> cache_times<span class="punctuation">[</span>key<span class="punctuation">])</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">time</span><span class="punctuation">()</span> <span class="punctuation">-</span> cache_times<span class="punctuation">[</span>key<span class="punctuation">]</span> <span class="punctuation">&lt;</span> cache_ttl<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="keyword">return</span> cache<span class="punctuation">[</span>key<span class="punctuation">];</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
    <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Store value in cache</span>
<span class="type">void</span> cache_set<span class="punctuation">(</span><span class="type">string</span> key<span class="punctuation">,</span> <span class="type">mixed</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
    cache<span class="punctuation">[</span>key<span class="punctuation">]</span> <span class="punctuation">=</span> value<span class="punctuation">;</span>
    cache_times<span class="punctuation">[</span>key<span class="punctuation">]</span> <span class="punctuation">=</span> <span class="function-name">time</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">2. Pre-compile templates</span>
<span class="type">string</span> header_template <span class="punctuation">=</span> <span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;
    &lt;title&gt;%s&lt;/title&gt;
    &lt;link rel="stylesheet" href="/style.css"&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;header&gt;&lt;h1&gt;%s&lt;/h1&gt;&lt;/header&gt;
    &lt;main&gt;
</span><span class="string">;</span>

<span class="type">string</span> footer_template <span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
    &lt;/main&gt;
    &lt;footer&gt;&amp;copy; 2024 My App&lt;/footer&gt;
&lt;/body&gt;
&lt;/html&gt;
</span><span class="string">;</span>

<span class="comment-delimiter">// </span><span class="comment">Efficient string builder for large output</span>
<span class="keyword">class</span> StringBuilder <span class="punctuation">{</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> parts <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>
    <span class="type">int</span> total_size <span class="punctuation">=</span> <span class="number">0</span><span class="punctuation">;</span>

    <span class="type">void</span> append<span class="punctuation">(</span><span class="type">string</span><span class="punctuation">|</span><span class="type">mixed</span> s<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> str <span class="punctuation">=</span> <span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span>s<span class="punctuation">;</span>
        parts <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> str <span class="punctuation">});</span>
        total_size <span class="punctuation">+=</span> <span class="function-name">sizeof</span><span class="punctuation">(</span>str<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> appendf<span class="punctuation">(</span><span class="type">string</span> fmt<span class="punctuation">,</span> <span class="type">mixed</span><span class="punctuation">...</span> args<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> str <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span>fmt<span class="punctuation">,</span> @args<span class="punctuation">);</span>
        parts <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> str <span class="punctuation">});</span>
        total_size <span class="punctuation">+=</span> <span class="function-name">sizeof</span><span class="punctuation">(</span>str<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="type">string</span> get<span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> parts <span class="punctuation">*</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">int</span> length<span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> total_size<span class="punctuation">;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">3. Lazy loading of expensive resources</span>
<span class="keyword">class</span> LazyLoader <span class="punctuation">{</span>
    <span class="type">mixed</span> value<span class="punctuation">;</span>
    <span class="type">function</span><span class="punctuation">(</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span> loader<span class="punctuation">;</span>
    <span class="type">int</span> loaded <span class="punctuation">=</span> <span class="number">0</span><span class="punctuation">;</span>

    <span class="type">void</span> create<span class="punctuation">(</span><span class="type">function</span><span class="punctuation">(</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span> f<span class="punctuation">)</span> <span class="punctuation">{</span>
        loader <span class="punctuation">=</span> f<span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">mixed</span> get<span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>loaded<span class="punctuation">)</span> <span class="punctuation">{</span>
            value <span class="punctuation">=</span> <span class="function-name">loader</span><span class="punctuation">();</span>
            loaded <span class="punctuation">=</span> <span class="number">1</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">return</span> value<span class="punctuation">;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">4. Batched database queries (simulated)</span>
<span class="type">array</span><span class="punctuation">(</span><span class="type">mapping</span><span class="punctuation">)</span> fetch_users_batch<span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span> user_ids<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">In production, use a single IN query instead of N queries</span>
    <span class="comment-delimiter">// </span><span class="comment">SELECT * FROM users WHERE id IN (1,2,3,...)</span>
    <span class="keyword">return</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>  <span class="comment-delimiter">// </span><span class="comment">Simulated</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">5. Output buffering - send headers once, then body</span>
<span class="keyword">class</span> BufferedOutput <span class="punctuation">{</span>
    <span class="type">StringBuilder</span> buffer <span class="punctuation">=</span> <span class="function-name">StringBuilder</span><span class="punctuation">();</span>
    <span class="type">int</span> headers_sent <span class="punctuation">=</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> headers <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"Content-Type"</span><span class="punctuation">:</span> <span class="string">"text/html; charset=utf-8"</span>
    <span class="punctuation">]);</span>

    <span class="type">void</span> set_header<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span> <span class="type">string</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
        headers<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">=</span> value<span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> write<span class="punctuation">(</span><span class="type">string</span><span class="punctuation">|</span><span class="type">mixed</span> s<span class="punctuation">)</span> <span class="punctuation">{</span>
        buffer<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">append</span><span class="punctuation">(</span>s<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> flush<span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>headers_sent<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="keyword">foreach</span><span class="punctuation">(</span>headers<span class="punctuation">;</span> <span class="type">string</span> name<span class="punctuation">;</span> <span class="type">string</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%s: %s\r\n"</span><span class="punctuation">,</span> name<span class="punctuation">,</span> value<span class="punctuation">));</span>
            <span class="punctuation">}</span>
            <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\r\n"</span><span class="punctuation">);</span>
            headers_sent <span class="punctuation">=</span> <span class="number">1</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>buffer<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">length</span><span class="punctuation">())</span> <span class="punctuation">{</span>
            <span class="function-name">write</span><span class="punctuation">(</span>buffer<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get</span><span class="punctuation">());</span>
            buffer <span class="punctuation">=</span> <span class="function-name">StringBuilder</span><span class="punctuation">();</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">6. Connection pooling helper</span>
<span class="keyword">class</span> ConnectionPool <span class="punctuation">{</span>
    <span class="type">int</span> max_connections<span class="punctuation">;</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">object</span><span class="punctuation">)</span> pool<span class="punctuation">;</span>
    <span class="type">int</span> created <span class="punctuation">=</span> <span class="number">0</span><span class="punctuation">;</span>

    <span class="type">void</span> create<span class="punctuation">(</span><span class="type">int</span> max<span class="punctuation">)</span> <span class="punctuation">{</span>
        max_connections <span class="punctuation">=</span> max<span class="punctuation">;</span>
        pool <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>
    <span class="punctuation">}</span>

    <span class="type">object</span><span class="punctuation">|</span><span class="keyword">zero</span> acquire<span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>pool<span class="punctuation">))</span> <span class="keyword">return</span> <span class="function-name">pop</span><span class="punctuation">(</span>pool<span class="punctuation">);</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>created <span class="punctuation">&lt;</span> max_connections<span class="punctuation">)</span> <span class="punctuation">{</span>
            created<span class="punctuation">++;</span>
            <span class="comment-delimiter">// </span><span class="comment">Return new connection</span>
            <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">Placeholder</span>
        <span class="punctuation">}</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> release<span class="punctuation">(</span><span class="type">object</span> conn<span class="punctuation">)</span> <span class="punctuation">{</span>
        pool <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> conn <span class="punctuation">});</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Example efficient CGI handler</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">BufferedOutput</span> out <span class="punctuation">=</span> <span class="function-name">BufferedOutput</span><span class="punctuation">();</span>

    <span class="comment-delimiter">// </span><span class="comment">Check cache first</span>
    <span class="type">string</span> cache_key <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_URI"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"/"</span><span class="punctuation">;</span>
    <span class="type">string</span><span class="punctuation">|</span><span class="keyword">zero</span> cached <span class="punctuation">=</span> <span class="function-name">cache_get</span><span class="punctuation">(</span>cache_key<span class="punctuation">);</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>cached<span class="punctuation">)</span> <span class="punctuation">{</span>
        out<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">set_header</span><span class="punctuation">(</span><span class="string">"X-Cache"</span><span class="punctuation">,</span> <span class="string">"HIT"</span><span class="punctuation">);</span>
        out<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">write</span><span class="punctuation">(</span>cached<span class="punctuation">);</span>
        out<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">flush</span><span class="punctuation">();</span>
        <span class="keyword">return</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Build response efficiently</span>
    out<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">set_header</span><span class="punctuation">(</span><span class="string">"X-Cache"</span><span class="punctuation">,</span> <span class="string">"MISS"</span><span class="punctuation">);</span>

    <span class="type">StringBuilder</span> sb <span class="punctuation">=</span> <span class="function-name">StringBuilder</span><span class="punctuation">();</span>
    sb<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">append</span><span class="punctuation">(</span>header_template<span class="punctuation">);</span>
    sb<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">appendf</span><span class="punctuation">(</span><span class="string">"Efficient CGI Page"</span><span class="punctuation">,</span> <span class="string">"Efficient CGI Page"</span><span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Add dynamic content</span>
    sb<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">append</span><span class="punctuation">(</span><span class="string">"&lt;p&gt;Page generated at: "</span><span class="punctuation">);</span>
    sb<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">append</span><span class="punctuation">(</span><span class="function-name">ctime</span><span class="punctuation">(</span><span class="function-name">time</span><span class="punctuation">()));</span>
    sb<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">append</span><span class="punctuation">(</span><span class="string">"&lt;/p&gt;\n"</span><span class="punctuation">);</span>

    sb<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">append</span><span class="punctuation">(</span>footer_template<span class="punctuation">);</span>

    <span class="type">string</span> response <span class="punctuation">=</span> sb<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get</span><span class="punctuation">();</span>

    <span class="comment-delimiter">// </span><span class="comment">Cache the response for GET requests</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">)</span> == <span class="string">"GET"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">cache_set</span><span class="punctuation">(</span>cache_key<span class="punctuation">,</span> response<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    out<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">write</span><span class="punctuation">(</span>response<span class="punctuation">);</span>
    out<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">flush</span><span class="punctuation">();</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1025"
>Executing Commands Without Shell Escapes</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.7: Executing Commands Without Shell Escapes - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">Safely execute external commands without shell interpolation</span>
<span class="comment-delimiter">// </span><span class="comment">NEVER use system() or popen() with user input - always use Process.spawn()</span>

<span class="keyword">import</span> <span class="module">Process</span><span class="punctuation">;</span>

<span class="comment-delimiter">// </span><span class="comment">WRONG - DANGEROUS - allows shell injection</span>
<span class="comment-delimiter">// </span><span class="comment">// string input = getenv("QUERY_STRING");</span>
<span class="comment-delimiter">// </span><span class="comment">// system("ls " + input);  // DON'T DO THIS!</span>

<span class="comment-delimiter">// </span><span class="comment">RIGHT - SAFE - direct execution without shell</span>
<span class="type">string</span> safe_exec<span class="punctuation">(</span><span class="type">string</span><span class="punctuation">...</span> args<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">Process</span><span class="punctuation">.</span><span class="type">Process</span> p <span class="punctuation">=</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">spawn</span><span class="punctuation">(</span>args<span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"stdout"</span><span class="punctuation">:</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">PIPE</span><span class="punctuation">,</span>
        <span class="string">"stderr"</span><span class="punctuation">:</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">PIPE</span><span class="punctuation">,</span>
        <span class="string">"stdin"</span><span class="punctuation">:</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">PIPE</span>
    <span class="punctuation">]));</span>

    <span class="type">string</span> output <span class="punctuation">=</span> p<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">stdout</span><span class="punctuation">()-&gt;</span><span class="function-name">read</span><span class="punctuation">();</span>
    <span class="type">string</span> errors <span class="punctuation">=</span> p<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">stderr</span><span class="punctuation">()-&gt;</span><span class="function-name">read</span><span class="punctuation">();</span>
    <span class="type">int</span> status <span class="punctuation">=</span> p<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">wait</span><span class="punctuation">();</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>status <span class="punctuation">!=</span> <span class="number">0</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="string">"Error: "</span> <span class="punctuation">+</span> errors<span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> output<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Validate filename to prevent path traversal</span>
<span class="type">int</span> is_safe_filename<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Reject empty names</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>name <span class="punctuation">||</span> <span class="function-name">sizeof</span><span class="punctuation">(</span>name<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">0</span><span class="punctuation">)</span> <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Reject path separators</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">has_value</span><span class="punctuation">(</span>name<span class="punctuation">,</span> <span class="string">"/"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="function-name">has_value</span><span class="punctuation">(</span>name<span class="punctuation">,</span> <span class="string">"\\"</span><span class="punctuation">))</span> <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Reject path traversal attempts</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">has_value</span><span class="punctuation">(</span>name<span class="punctuation">,</span> <span class="string">".."</span><span class="punctuation">))</span> <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Only allow alphanumeric, underscore, dash, and dot</span>
    <span class="type">int</span> safe_chars <span class="punctuation">=</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="keyword">for</span> <span class="punctuation">(</span><span class="type">int</span> i <span class="punctuation">=</span> <span class="number">0</span><span class="punctuation">;</span> i <span class="punctuation">&lt;</span> <span class="function-name">sizeof</span><span class="punctuation">(</span>name<span class="punctuation">);</span> i<span class="punctuation">++)</span> <span class="punctuation">{</span>
        <span class="type">string</span> c <span class="punctuation">=</span> name<span class="punctuation">[</span>i<span class="punctuation">..i</span><span class="punctuation">];</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>c <span class="punctuation">&gt;=</span> <span class="string">"a"</span> <span class="punctuation">&amp;&amp;</span> c <span class="punctuation">&lt;=</span> <span class="string">"z"</span><span class="punctuation">)</span> <span class="keyword">continue</span><span class="punctuation">;</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>c <span class="punctuation">&gt;=</span> <span class="string">"A"</span> <span class="punctuation">&amp;&amp;</span> c <span class="punctuation">&lt;=</span> <span class="string">"Z"</span><span class="punctuation">)</span> <span class="keyword">continue</span><span class="punctuation">;</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>c <span class="punctuation">&gt;=</span> <span class="string">"0"</span> <span class="punctuation">&amp;&amp;</span> c <span class="punctuation">&lt;=</span> <span class="string">"9"</span><span class="punctuation">)</span> <span class="keyword">continue</span><span class="punctuation">;</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>c <span class="punctuation">==</span> <span class="string">"_"</span> <span class="punctuation">||</span> c <span class="punctuation">==</span> <span class="string">"-"</span> <span class="punctuation">||</span> c <span class="punctuation">==</span> <span class="string">"."</span><span class="punctuation">)</span> <span class="keyword">continue</span><span class="punctuation">;</span>
        <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="number">1</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Safely execute command with user-provided arguments</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> safe_command<span class="punctuation">(</span><span class="type">string</span> program<span class="punctuation">,</span> <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> user_args<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Validate program name (whitelist approach)</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> allowed_programs <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span>
        <span class="string">"/bin/ls"</span><span class="punctuation">,</span>
        <span class="string">"/bin/cat"</span><span class="punctuation">,</span>
        <span class="string">"/usr/bin/file"</span>
    <span class="punctuation">});</span>

    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">search</span><span class="punctuation">(</span>allowed_programs<span class="punctuation">,</span> program<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="punctuation">-</span><span class="number">1</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="string">"error"</span><span class="punctuation">:</span> <span class="string">"Program not allowed"</span><span class="punctuation">,</span> <span class="string">"status"</span><span class="punctuation">:</span> <span class="string">"forbidden"</span><span class="punctuation">]);</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Validate each argument</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> safe_args <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span> program <span class="punctuation">});</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>user_args<span class="punctuation">;</span> <span class="type">string</span> arg<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span><span class="function-name">is_safe_filename</span><span class="punctuation">(</span>arg<span class="punctuation">))</span> <span class="punctuation">{</span>
            <span class="keyword">return</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="string">"error"</span><span class="punctuation">:</span> <span class="string">"Invalid argument"</span><span class="punctuation">,</span> <span class="string">"status"</span><span class="punctuation">:</span> <span class="string">"invalid"</span><span class="punctuation">]);</span>
        <span class="punctuation">}</span>
        safe_args <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> arg <span class="punctuation">});</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Execute with Process.spawn - no shell involved</span>
    <span class="type">Process</span><span class="punctuation">.</span><span class="type">Process</span> p <span class="punctuation">=</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">spawn</span><span class="punctuation">(</span>safe_args<span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"stdout"</span><span class="punctuation">:</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">PIPE</span><span class="punctuation">,</span>
        <span class="string">"stderr"</span><span class="punctuation">:</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">PIPE</span>
    <span class="punctuation">]));</span>

    <span class="type">string</span> stdout <span class="punctuation">=</span> p<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">stdout</span><span class="punctuation">()-&gt;</span><span class="function-name">read</span><span class="punctuation">();</span>
    <span class="type">string</span> stderr <span class="punctuation">=</span> p<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">stderr</span><span class="punctuation">()-&gt;</span><span class="function-name">read</span><span class="punctuation">();</span>
    <span class="type">int</span> exit_code <span class="punctuation">=</span> p<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">wait</span><span class="punctuation">();</span>

    <span class="keyword">return</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"stdout"</span><span class="punctuation">:</span> stdout<span class="punctuation">,</span>
        <span class="string">"stderr"</span><span class="punctuation">:</span> stderr<span class="punctuation">,</span>
        <span class="string">"exit_code"</span><span class="punctuation">:</span> <span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span>exit_code<span class="punctuation">,</span>
        <span class="string">"status"</span><span class="punctuation">:</span> exit_code == <span class="number">0</span> <span class="punctuation">?</span> <span class="string">"success"</span> <span class="punctuation">:</span> <span class="string">"error"</span>
    <span class="punctuation">]);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Wrapper for handling file operations safely</span>
<span class="type">string</span> safe_file_info<span class="punctuation">(</span><span class="type">string</span> filename<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span><span class="function-name">is_safe_filename</span><span class="punctuation">(</span>filename<span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="string">"Error: Invalid filename"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Use Process.spawn instead of system()</span>
    <span class="keyword">return</span> <span class="function-name">safe_exec</span><span class="punctuation">(</span><span class="string">"/usr/bin/file"</span><span class="punctuation">,</span> <span class="string">"/safe/uploads/"</span> <span class="punctuation">+</span> filename<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Example CGI handler for safe command execution</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/plain; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Example: Safe directory listing</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> args <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span> <span class="string">"/bin/ls"</span><span class="punctuation">,</span> <span class="string">"-la"</span><span class="punctuation">,</span> <span class="string">"/safe"</span> <span class="punctuation">});</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> result <span class="punctuation">=</span> <span class="function-name">safe_command</span><span class="punctuation">(</span>args<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">],</span> args<span class="punctuation">[</span><span class="number">1.</span><span class="punctuation">.</span><span class="punctuation">]);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Command Result:\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: "</span> <span class="punctuation">+</span> result<span class="punctuation">[</span><span class="string">"status"</span><span class="punctuation">]</span> <span class="punctuation">+</span> <span class="string">"\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Exit code: "</span> <span class="punctuation">+</span> result<span class="punctuation">[</span><span class="string">"exit_code"</span><span class="punctuation">]</span> <span class="punctuation">+</span> <span class="string">"\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\nOutput:\n"</span> <span class="punctuation">+</span> result<span class="punctuation">[</span><span class="string">"stdout"</span><span class="punctuation">]</span><span class="punctuation">);</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>result<span class="punctuation">[</span><span class="string">"stderr"</span><span class="punctuation">])</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\nErrors:\n"</span> <span class="punctuation">+</span> result<span class="punctuation">[</span><span class="string">"stderr"</span><span class="punctuation">]</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Also available: Process.popen() for reading command output</span>
<span class="comment-delimiter">// </span><span class="comment">But always validate arguments before passing!</span>
<span class="type">string</span> safe_popen<span class="punctuation">(</span><span class="type">string</span> program<span class="punctuation">,</span> <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> args<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="type">Process</span><span class="punctuation">.</span><span class="type">Process</span> p <span class="punctuation">=</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">spawn</span><span class="punctuation">(</span>args<span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"stdout"</span><span class="punctuation">:</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">PIPE</span>
    <span class="punctuation">]));</span>

    output <span class="punctuation">=</span> p<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">stdout</span><span class="punctuation">()-&gt;</span><span class="function-name">read</span><span class="punctuation">();</span>
    p<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">wait</span><span class="punctuation">();</span>

    <span class="keyword">return</span> output<span class="punctuation">;</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1028"
>Formatting Lists and Tables with HTML Shortcuts</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.8: Formatting Lists and Tables with HTML Shortcuts - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">HTML helper functions for generating common UI elements</span>

<span class="comment-delimiter">// </span><span class="comment">HTML tag builder helper</span>
<span class="type">string</span> tag<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span> <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> content<span class="punctuation">,</span> <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> attr_str <span class="punctuation">=</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>attrs<span class="punctuation">;</span> <span class="type">string</span> k<span class="punctuation">;</span> <span class="type">string</span> v<span class="punctuation">)</span> <span class="punctuation">{</span>
            attr_str <span class="punctuation">+=</span> <span class="string">" "</span> <span class="punctuation">+</span> k <span class="punctuation">+</span> <span class="string">"=\""</span> <span class="punctuation">+</span> v <span class="punctuation">+</span> <span class="string">"\""</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>content<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;%s%s&gt;%s&lt;/%s&gt;"</span><span class="punctuation">,</span> name<span class="punctuation">,</span> attr_str<span class="punctuation">,</span> content<span class="punctuation">,</span> name<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;%s%s /&gt;"</span><span class="punctuation">,</span> name<span class="punctuation">,</span> attr_str<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">HTML escape function</span>
<span class="type">string</span> h<span class="punctuation">(</span><span class="type">string</span> s<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>s<span class="punctuation">,</span> <span class="string">"&amp;"</span><span class="punctuation">,</span> <span class="string">"&amp;amp;"</span><span class="punctuation">),</span>
            <span class="string">"&lt;"</span><span class="punctuation">,</span> <span class="string">"&amp;lt;"</span><span class="punctuation">),</span>
            <span class="string">"&gt;"</span><span class="punctuation">,</span> <span class="string">"&amp;gt;"</span><span class="punctuation">),</span>
            <span class="string">"\""</span><span class="punctuation">,</span> <span class="string">"&amp;quot;"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Unordered list generator</span>
<span class="type">string</span> ul<span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> items<span class="punctuation">,</span> <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> lis <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>items<span class="punctuation">;</span> <span class="type">string</span> item<span class="punctuation">)</span> <span class="punctuation">{</span>
        lis <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> <span class="string">"  &lt;li&gt;"</span> <span class="punctuation">+</span> <span class="function-name">h</span><span class="punctuation">(</span>item<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"&lt;/li&gt;"</span> <span class="punctuation">});</span>
    <span class="punctuation">}</span>
    <span class="keyword">return</span> <span class="string">"&lt;ul"</span> <span class="punctuation">+</span> <span class="punctuation">(</span>attrs <span class="punctuation">?</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">" %s"</span><span class="punctuation">,</span> <span class="function-name">encode_value</span><span class="punctuation">(</span>attrs<span class="punctuation">))</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"&gt;\n"</span> +
           lis <span class="punctuation">*</span> <span class="string">"\n"</span> <span class="punctuation">+</span> <span class="string">"\n&lt;/ul&gt;"</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Ordered list generator</span>
<span class="type">string</span> ol<span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> items<span class="punctuation">,</span> <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> start<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> lis <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>items<span class="punctuation">;</span> <span class="type">string</span> item<span class="punctuation">)</span> <span class="punctuation">{</span>
        lis <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> <span class="string">"  &lt;li&gt;"</span> <span class="punctuation">+</span> <span class="function-name">h</span><span class="punctuation">(</span>item<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"&lt;/li&gt;"</span> <span class="punctuation">});</span>
    <span class="punctuation">}</span>
    <span class="type">string</span> start_attr <span class="punctuation">=</span> start <span class="punctuation">?</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">" start=\"%d\""</span><span class="punctuation">,</span> start<span class="punctuation">)</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="keyword">return</span> <span class="string">"&lt;ol"</span> <span class="punctuation">+</span> start_attr <span class="punctuation">+</span> <span class="string">"&gt;\n"</span> <span class="punctuation">+</span> <span class="punctuation">(</span>lis <span class="punctuation">*</span> <span class="string">"\n"</span><span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"\n&lt;/ol&gt;"</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Definition list generator</span>
<span class="type">string</span> dl<span class="punctuation">(</span><span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> items<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> pairs <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>items<span class="punctuation">;</span> <span class="type">string</span> term<span class="punctuation">;</span> <span class="type">string</span> definition<span class="punctuation">)</span> <span class="punctuation">{</span>
        pairs <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> <span class="string">"  &lt;dt&gt;"</span> <span class="punctuation">+</span> <span class="function-name">h</span><span class="punctuation">(</span>term<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"&lt;/dt&gt;"</span><span class="punctuation">,</span>
                     <span class="string">"  &lt;dd&gt;"</span> <span class="punctuation">+</span> <span class="function-name">h</span><span class="punctuation">(</span>definition<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"&lt;/dd&gt;"</span> <span class="punctuation">});</span>
    <span class="punctuation">}</span>
    <span class="keyword">return</span> <span class="string">"&lt;dl&gt;\n"</span> <span class="punctuation">+</span> <span class="punctuation">(</span>pairs <span class="punctuation">*</span> <span class="string">"\n"</span><span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"\n&lt;/dl&gt;"</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Table generator from array of arrays</span>
<span class="type">string</span> table<span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">))</span> rows<span class="punctuation">,</span>
              <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)|</span><span class="keyword">void</span> headers<span class="punctuation">,</span>
              <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> attr_str <span class="punctuation">=</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>attrs<span class="punctuation">;</span> <span class="type">string</span> k<span class="punctuation">;</span> <span class="type">string</span> v<span class="punctuation">)</span> <span class="punctuation">{</span>
            attr_str <span class="punctuation">+=</span> <span class="string">" "</span> <span class="punctuation">+</span> k <span class="punctuation">+</span> <span class="string">"=\""</span> <span class="punctuation">+</span> v <span class="punctuation">+</span> <span class="string">"\""</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="type">string</span> html <span class="punctuation">=</span> <span class="string">"&lt;table"</span> <span class="punctuation">+</span> attr_str <span class="punctuation">+</span> <span class="string">"&gt;\n"</span><span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Add header row if provided</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>headers<span class="punctuation">)</span> <span class="punctuation">{</span>
        html <span class="punctuation">+=</span> <span class="string">"  &lt;thead&gt;\n    &lt;tr&gt;\n"</span><span class="punctuation">;</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>headers<span class="punctuation">;</span> <span class="type">string</span> h<span class="punctuation">)</span> <span class="punctuation">{</span>
            html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"      &lt;th&gt;%s&lt;/th&gt;\n"</span><span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>h<span class="punctuation">));</span>
        <span class="punctuation">}</span>
        html <span class="punctuation">+=</span> <span class="string">"    &lt;/tr&gt;\n  &lt;/thead&gt;\n"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Add data rows</span>
    html <span class="punctuation">+=</span> <span class="string">"  &lt;tbody&gt;\n"</span><span class="punctuation">;</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>rows<span class="punctuation">;</span> <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> row<span class="punctuation">;</span> <span class="type">int</span> row_idx<span class="punctuation">)</span> <span class="punctuation">{</span>
        html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"    &lt;tr class=\"%s\"&gt;\n"</span><span class="punctuation">,</span>
                       row_idx <span class="punctuation">%</span> <span class="number">2</span> <span class="punctuation">?</span> <span class="string">"odd"</span> <span class="punctuation">:</span> <span class="string">"even"</span><span class="punctuation">);</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>row<span class="punctuation">;</span> <span class="type">string</span> cell<span class="punctuation">)</span> <span class="punctuation">{</span>
            html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"      &lt;td&gt;%s&lt;/td&gt;\n"</span><span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>cell<span class="punctuation">));</span>
        <span class="punctuation">}</span>
        html <span class="punctuation">+=</span> <span class="string">"    &lt;/tr&gt;\n"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
    html <span class="punctuation">+=</span> <span class="string">"  &lt;/tbody&gt;\n"</span><span class="punctuation">;</span>
    html <span class="punctuation">+=</span> <span class="string">"&lt;/table&gt;"</span><span class="punctuation">;</span>

    <span class="keyword">return</span> html<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Table from mapping (key-value pairs)</span>
<span class="type">string</span> kv_table<span class="punctuation">(</span><span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> data<span class="punctuation">,</span>
                    <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> key_header<span class="punctuation">,</span>
                    <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> value_header<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">))</span> rows <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>data<span class="punctuation">;</span> <span class="type">string</span> k<span class="punctuation">;</span> <span class="type">string</span> v<span class="punctuation">)</span> <span class="punctuation">{</span>
        rows <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> <span class="punctuation">(</span><span class="punctuation">{</span> k<span class="punctuation">,</span> v <span class="punctuation">}</span><span class="punctuation">)</span> <span class="punctuation">});</span>
    <span class="punctuation">}</span>

    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> headers <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">(</span>key_header <span class="punctuation">&amp;&amp;</span> value_header<span class="punctuation">)</span> <span class="punctuation">?</span> <span class="punctuation">(</span><span class="punctuation">{</span>key_header<span class="punctuation">,</span> value_header<span class="punctuation">}</span><span class="punctuation">)</span> <span class="punctuation">:</span> <span class="keyword">UNDEFINED</span><span class="punctuation">);</span>

    <span class="keyword">return</span> <span class="function-name">table</span><span class="punctuation">(</span>rows<span class="punctuation">,</span> headers<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Form generator</span>
<span class="type">string</span> form<span class="punctuation">(</span><span class="type">string</span> action<span class="punctuation">,</span>
            <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> method<span class="punctuation">,</span>
            <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> content<span class="punctuation">,</span>
            <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>method<span class="punctuation">)</span> method <span class="punctuation">=</span> <span class="string">"POST"</span><span class="punctuation">;</span>
    <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;form action=\"%s\" method=\"%s\"%s&gt;%s&lt;/form&gt;"</span><span class="punctuation">,</span>
                     action<span class="punctuation">,</span> method<span class="punctuation">,</span>
                     attrs <span class="punctuation">?</span> <span class="string">" enctype=\"multipart/form-data\""</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span>
                     content <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Select dropdown generator</span>
<span class="type">string</span> select<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span>
               <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> options<span class="punctuation">,</span>
               <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> selected<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> html <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;select name=\"%s\"&gt;\n"</span><span class="punctuation">,</span> name<span class="punctuation">);</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>options<span class="punctuation">;</span> <span class="type">string</span> opt<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> sel <span class="punctuation">=</span> <span class="punctuation">(</span>opt == selected<span class="punctuation">)</span> <span class="punctuation">?</span> <span class="string">" selected"</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">;</span>
        html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"  &lt;option value=\"%s\"%s&gt;%s&lt;/option&gt;\n"</span><span class="punctuation">,</span>
                          <span class="function-name">h</span><span class="punctuation">(</span>opt<span class="punctuation">),</span> sel<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>opt<span class="punctuation">));</span>
    <span class="punctuation">}</span>
    html <span class="punctuation">+=</span> <span class="string">"&lt;/select&gt;"</span><span class="punctuation">;</span>
    <span class="keyword">return</span> html<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Checkbox generator</span>
<span class="type">string</span> checkbox<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span> <span class="type">string</span> value<span class="punctuation">,</span> <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> checked<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> chk <span class="punctuation">=</span> checked <span class="punctuation">?</span> <span class="string">" checked"</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;input type=\"checkbox\" name=\"%s\" value=\"%s\"%s&gt;"</span><span class="punctuation">,</span>
                     name<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>value<span class="punctuation">),</span> chk<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Pagination links generator</span>
<span class="type">string</span> pagination<span class="punctuation">(</span><span class="type">int</span> current<span class="punctuation">,</span> <span class="type">int</span> total<span class="punctuation">,</span> <span class="type">int</span> per_page<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">int</span> pages <span class="punctuation">=</span> <span class="punctuation">(</span>total <span class="punctuation">+</span> per_page <span class="punctuation">-</span> <span class="number">1</span><span class="punctuation">)</span> <span class="punctuation">/</span> per_page<span class="punctuation">;</span>
    <span class="type">string</span> html <span class="punctuation">=</span> <span class="string">"&lt;div class=\"pagination\"&gt;\n"</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>current <span class="punctuation">&gt;</span> <span class="number">1</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"  &lt;a href=\"?page=%d\"&gt;Prev&lt;/a&gt;\n"</span><span class="punctuation">,</span> current <span class="punctuation">-</span> <span class="number">1</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="keyword">for</span> <span class="punctuation">(</span><span class="type">int</span> i <span class="punctuation">=</span> <span class="number">1</span><span class="punctuation">;</span> i <span class="punctuation">&lt;=</span> pages<span class="punctuation">;</span> i<span class="punctuation">++)</span> <span class="punctuation">{</span>
        <span class="type">string</span> cls <span class="punctuation">=</span> <span class="punctuation">(</span>i == current<span class="punctuation">)</span> <span class="punctuation">?</span> <span class="string">" class=\"active\""</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">;</span>
        html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"  &lt;a href=\"?page=%d\"%s&gt;%d&lt;/a&gt;\n"</span><span class="punctuation">,</span> i<span class="punctuation">,</span> cls<span class="punctuation">,</span> i<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>current <span class="punctuation">&lt;</span> pages<span class="punctuation">)</span> <span class="punctuation">{</span>
        html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"  &lt;a href=\"?page=%d\"&gt;Next&lt;/a&gt;\n"</span><span class="punctuation">,</span> current <span class="punctuation">+</span> <span class="number">1</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>

    html <span class="punctuation">+=</span> <span class="string">"&lt;/div&gt;"</span><span class="punctuation">;</span>
    <span class="keyword">return</span> html<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Example usage in CGI</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Sample data</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> fruits <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"Apple"</span><span class="punctuation">,</span> <span class="string">"Banana"</span><span class="punctuation">,</span> <span class="string">"Cherry"</span><span class="punctuation">,</span> <span class="string">"Date"</span><span class="punctuation">});</span>

    <span class="type">array</span><span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">))</span> users <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span>
        <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"Alice"</span><span class="punctuation">,</span> <span class="string">"alice@example.com"</span><span class="punctuation">,</span> <span class="string">"Admin"</span><span class="punctuation">}</span><span class="punctuation">),</span>
        <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"Bob"</span><span class="punctuation">,</span> <span class="string">"bob@example.com"</span><span class="punctuation">,</span> <span class="string">"User"</span><span class="punctuation">}</span><span class="punctuation">),</span>
        <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"Carol"</span><span class="punctuation">,</span> <span class="string">"carol@example.com"</span><span class="punctuation">,</span> <span class="string">"User"</span><span class="punctuation">}</span><span class="punctuation">)</span>
    <span class="punctuation">});</span>

    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> headers <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"Name"</span><span class="punctuation">,</span> <span class="string">"Email"</span><span class="punctuation">,</span> <span class="string">"Role"</span><span class="punctuation">});</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;HTML Helpers Demo&lt;/title&gt;
&lt;style&gt;
    body { font-family: Arial, sans-serif; margin: 40px; }
    table { border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
    th { background: #4CAF50; color: white; }
    .even { background: #f2f2f2; }
    ul, ol { margin: 20px 0; }
&lt;/style&gt;
&lt;/head&gt;&lt;body&gt;
    &lt;h1&gt;HTML Helpers Demo&lt;/h1&gt;

    &lt;h2&gt;Unordered List&lt;/h2&gt;</span><span class="string">"</span><span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">ul</span><span class="punctuation">(</span>fruits<span class="punctuation">));</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"
    &lt;h2&gt;Ordered List&lt;/h2&gt;</span><span class="string">"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">ol</span><span class="punctuation">(</span>fruits<span class="punctuation">, </span><span class="number">5</span><span class="punctuation">));</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"
    &lt;h2&gt;Definition List&lt;/h2&gt;</span><span class="string">"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">dl</span><span class="punctuation">(</span><span class="punctuation">(</span><span class="punctuation">[</span><span class="string">"Pike"</span><span class="punctuation">:</span> <span class="string">"A dynamic programming language"</span><span class="punctuation">,</span>
                  <span class="string">"CGI"</span><span class="punctuation">:</span> <span class="string">"Common Gateway Interface"</span><span class="punctuation">])));</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"
    &lt;h2&gt;Data Table&lt;/h2&gt;</span><span class="string">"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">table</span><span class="punctuation">(</span>users<span class="punctuation">,</span> headers<span class="punctuation">, (</span><span class="punctuation">[</span><span class="string">"class"</span><span class="punctuation">:</span> <span class="string">"data-table"</span><span class="punctuation">])));</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"
    &lt;h2&gt;Pagination&lt;/h2&gt;</span><span class="string">"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">pagination</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">,</span> <span class="number">45</span><span class="punctuation">,</span> <span class="number">10</span><span class="punctuation">));</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;/body&gt;&lt;/html&gt;\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1031"
>Redirecting to a Different Location</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.9: Redirecting to a Different Location - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">HTTP redirects for CGI applications</span>

<span class="comment-delimiter">// </span><span class="comment">Simple 301 Moved Permanently redirect</span>
<span class="type">void</span> redirect_permanent<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: 301 Moved Permanently\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Location: %s\r\n"</span><span class="punctuation">,</span> url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Moved&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;&lt;h1&gt;301 Moved Permanently&lt;/h1&gt;
&lt;p&gt;This resource has moved to &lt;a href="%s"&gt;%s&lt;/a&gt;.&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">,</span> url<span class="punctuation">,</span> url<span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Temporary 302 Found redirect (common for POST-Redirect-GET pattern)</span>
<span class="type">void</span> redirect_temporary<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: 302 Found\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Location: %s\r\n"</span><span class="punctuation">,</span> url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Redirect&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;&lt;h1&gt;302 Found&lt;/h1&gt;
&lt;p&gt;Redirecting to &lt;a href="%s"&gt;%s&lt;/a&gt;...&lt;/p&gt;
&lt;script&gt;window.location="%s";&lt;/script&gt;
&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">,</span> url<span class="punctuation">,</span> url<span class="punctuation">,</span> url<span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">303 See Other redirect (after POST to prevent resubmission)</span>
<span class="type">void</span> redirect_after_post<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: 303 See Other\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Location: %s\r\n"</span><span class="punctuation">,</span> url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\r\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">307 Temporary Redirect (preserves method)</span>
<span class="type">void</span> redirect_temp_preserve<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: 307 Temporary Redirect\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Location: %s\r\n"</span><span class="punctuation">,</span> url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"\r\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Safe redirect with validation (prevent open redirect attacks)</span>
<span class="type">int</span> is_safe_url<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Reject empty URLs</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>url<span class="punctuation">)</span> <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Allow relative URLs starting with /</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">has_prefix</span><span class="punctuation">(</span>url<span class="punctuation">,</span> <span class="string">"/"</span><span class="punctuation">))</span> <span class="keyword">return</span> <span class="number">1</span><span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Allow absolute URLs only from whitelist</span>
    <span class="type">string</span> host <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"HTTP_HOST"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"localhost"</span><span class="punctuation">;</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> allowed_hosts <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span> host<span class="punctuation">,</span> <span class="string">"www."</span> <span class="punctuation">+</span> host <span class="punctuation">});</span>

    <span class="keyword">foreach</span><span class="punctuation">(</span>allowed_hosts<span class="punctuation">;</span> <span class="type">string</span> allowed<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">has_prefix</span><span class="punctuation">(</span>url<span class="punctuation">,</span> <span class="string">"http://"</span> <span class="punctuation">+</span> allowed<span class="punctuation">)</span> <span class="punctuation">||</span>
            <span class="function-name">has_prefix</span><span class="punctuation">(</span>url<span class="punctuation">,</span> <span class="string">"https://"</span> <span class="punctuation">+</span> allowed<span class="punctuation">))</span> <span class="punctuation">{</span>
            <span class="keyword">return</span> <span class="number">1</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="number">0</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="type">void</span> safe_redirect<span class="punctuation">(</span><span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Default to home if URL is invalid</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>url <span class="punctuation">||</span> <span class="punctuation">!</span><span class="function-name">is_safe_url</span><span class="punctuation">(</span>url<span class="punctuation">))</span> <span class="punctuation">{</span>
        url <span class="punctuation">=</span> <span class="string">"/"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
    <span class="function-name">redirect_temporary</span><span class="punctuation">(</span>url<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Build URL with query string</span>
<span class="type">string</span> build_url<span class="punctuation">(</span><span class="type">string</span> base<span class="punctuation">,</span> <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> params<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> pairs <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>params<span class="punctuation">;</span> <span class="type">string</span> key<span class="punctuation">;</span> <span class="type">string</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> encoded_key <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">http_encode_url</span><span class="punctuation">(</span>key<span class="punctuation">);</span>
        <span class="type">string</span> encoded_value <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">http_encode_url</span><span class="punctuation">(</span>value<span class="punctuation">);</span>
        pairs <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> encoded_key <span class="punctuation">+</span> <span class="string">"="</span> <span class="punctuation">+</span> encoded_value <span class="punctuation">});</span>
    <span class="punctuation">}</span>

    <span class="type">string</span> separator <span class="punctuation">=</span> <span class="function-name">has_value</span><span class="punctuation">(</span>base<span class="punctuation">,</span> <span class="string">"?"</span><span class="punctuation">)</span> <span class="punctuation">?</span> <span class="string">"&amp;"</span> <span class="punctuation">:</span> <span class="string">"?"</span><span class="punctuation">;</span>
    <span class="keyword">return</span> base <span class="punctuation">+</span> separator <span class="punctuation">+</span> pairs <span class="punctuation">*</span> <span class="string">"&amp;"</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Refresh meta redirect (client-side fallback)</span>
<span class="type">void</span> meta_redirect<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">,</span> <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> delay<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>delay<span class="punctuation">)</span> delay <span class="punctuation">=</span> <span class="number">0</span><span class="punctuation">;</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Redirecting...&lt;/title&gt;
&lt;meta http-equiv="refresh" content="%d;url=%s"&gt;
&lt;style&gt;body{font-family:Arial,sans-serif;text-align:center;margin-top:100px;}&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Redirecting...&lt;/h1&gt;
    &lt;p&gt;Please wait while we redirect you to &lt;a href="%s"%s&gt;%s&lt;/a&gt;.&lt;/p&gt;
    &lt;script&gt;setTimeout(function(){window.location="%s";},%d&lt;span class="punctuation">*</span><span class="number">1000</span>);&lt;/script&gt;
&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">,</span> delay<span class="punctuation">,</span> url<span class="punctuation">,</span> url<span class="punctuation">,</span>
             delay <span class="punctuation">==</span> <span class="number">0</span> <span class="punctuation">?</span> <span class="string">" style=\"display:none\""</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span>
             url<span class="punctuation">,</span> url<span class="punctuation">,</span> delay<span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Example: POST-Redirect-GET pattern to prevent form resubmission</span>
<span class="type">void</span> handle_form_post<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Process the form data...</span>

    <span class="comment-delimiter">// </span><span class="comment">Store success message in session or cookie</span>
    <span class="function-name">set_cookie</span><span class="punctuation">(</span><span class="string">"flash_message"</span><span class="punctuation">,</span> <span class="string">"Form submitted successfully!"</span><span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Redirect to GET page</span>
    <span class="function-name">redirect_after_post</span><span class="punctuation">(</span><span class="string">"/thank-you"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Simple cookie setting helper</span>
<span class="type">void</span> set_cookie<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span> <span class="type">string</span> value<span class="punctuation">,</span>
                  <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> lifetime<span class="punctuation">,</span>
                  <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> path<span class="punctuation">,</span>
                  <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> domain<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>path<span class="punctuation">)</span> path <span class="punctuation">=</span> <span class="string">"/"</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>lifetime<span class="punctuation">)</span> lifetime <span class="punctuation">=</span> <span class="number">3600</span><span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">1 hour default</span>

    <span class="type">int</span> expiry <span class="punctuation">=</span> <span class="function-name">time</span><span class="punctuation">()</span> <span class="punctuation">+</span> lifetime<span class="punctuation">;</span>
    <span class="type">string</span> date <span class="punctuation">=</span> <span class="function-name">Calendar</span><span class="punctuation">.</span><span class="function-name">Second</span><span class="punctuation">(</span>expiry<span class="punctuation">)-&gt;</span><span class="function-name">format_http</span><span class="punctuation">();</span>

    <span class="type">string</span> cookie <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%s=%s; Expires=%s; Path=%s"</span><span class="punctuation">,</span>
                               name<span class="punctuation">,</span> value<span class="punctuation">,</span> date<span class="punctuation">,</span> path<span class="punctuation">);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>domain<span class="punctuation">)</span> cookie <span class="punctuation">+=</span> <span class="string">"; Domain="</span> <span class="punctuation">+</span> domain<span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Set cookie via Set-Cookie header</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Set-Cookie: %s\r\n"</span><span class="punctuation">,</span> cookie<span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Example usage</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> redirect_target <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"QUERY_STRING"</span><span class="punctuation">);</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>redirect_target<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="comment-delimiter">// </span><span class="comment">Parse the target parameter</span>
        <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> params <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>redirect_target <span class="punctuation">/</span> <span class="string">"&amp;"</span><span class="punctuation">;</span> <span class="type">string</span> pair<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> parts <span class="punctuation">=</span> pair <span class="punctuation">/</span> <span class="string">"="</span><span class="punctuation">;</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>parts<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                params<span class="punctuation">[</span>parts<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]]</span> <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">http_decode_url</span><span class="punctuation">(</span>parts<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]);</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>

        <span class="comment-delimiter">// </span><span class="comment">Safely redirect to target (prevents open redirect attacks)</span>
        <span class="function-name">safe_redirect</span><span class="punctuation">(</span>params<span class="punctuation">-</span><span class="punctuation">&gt;</span>url<span class="punctuation">);</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="comment-delimiter">// </span><span class="comment">Show a page with redirect examples</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Redirect Examples&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;HTTP Redirect Examples&lt;/h1&gt;
    &lt;ul&gt;
        &lt;li&gt;&lt;a href="?url=/home"&gt;Temporary redirect (302)&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href="?url=/about"&gt;Safe redirect&lt;/a&gt;&lt;/li&gt;
        &lt;li&gt;&lt;a href="?url="&gt;Default redirect&lt;/a&gt;&lt;/li&gt;
    &lt;/ul&gt;
&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1034"
>Debugging the Raw HTTP Exchange</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.10: Debugging the Raw HTTP Exchange - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">HTTP debugging tools for CGI applications</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">HTTP</span><span class="punctuation">;</span>

<span class="comment-delimiter">// </span><span class="comment">Log file for HTTP debugging</span>
<span class="keyword">constant</span> DEBUG_LOG <span class="punctuation">=</span> <span class="string">"/tmp/http_debug.log"</span><span class="punctuation">;</span>

<span class="comment-delimiter">// </span><span class="comment">Write debug information to log file</span>
<span class="type">void</span> debug_log<span class="punctuation">(</span><span class="type">string</span> message<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> timestamp <span class="punctuation">=</span> <span class="function-name">Calendar</span><span class="punctuation">.</span><span class="function-name">now</span><span class="punctuation">()-&gt;</span><span class="function-name">format_time</span><span class="punctuation">();</span>
    <span class="type">Stdio</span><span class="punctuation">.</span><span class="type">File</span> f <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">();</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>f<span class="punctuation">-&gt;</span><span class="function-name">open</span><span class="punctuation">(</span>DEBUG_LOG<span class="punctuation">,</span> <span class="string">"wac"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
        f<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"[%s] %s\n"</span><span class="punctuation">,</span> timestamp<span class="punctuation">,</span> message<span class="punctuation">));</span>
        f<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">close</span><span class="punctuation">();</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Dump all HTTP headers received</span>
<span class="type">string</span> dump_request_headers<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="string">"=== HTTP Request Headers ===\n"</span><span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Standard CGI environment variables that represent headers</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> http_vars <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span>
        <span class="string">"HTTP_ACCEPT"</span><span class="punctuation">,</span> <span class="string">"HTTP_ACCEPT_CHARSET"</span><span class="punctuation">,</span> <span class="string">"HTTP_ACCEPT_ENCODING"</span><span class="punctuation">,</span>
        <span class="string">"HTTP_ACCEPT_LANGUAGE"</span><span class="punctuation">,</span> <span class="string">"HTTP_AUTHORIZATION"</span><span class="punctuation">,</span> <span class="string">"HTTP_CONNECTION"</span><span class="punctuation">,</span>
        <span class="string">"HTTP_COOKIE"</span><span class="punctuation">,</span> <span class="string">"HTTP_HOST"</span><span class="punctuation">,</span> <span class="string">"HTTP_REFERER"</span><span class="punctuation">,</span>
        <span class="string">"HTTP_USER_AGENT"</span><span class="punctuation">,</span> <span class="string">"HTTP_X_FORWARDED_FOR"</span>
    <span class="punctuation">});</span>

    <span class="keyword">foreach</span><span class="punctuation">(</span>http_vars<span class="punctuation">;</span> <span class="type">string</span> var<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> value <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span>var<span class="punctuation">);</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>value<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="comment-delimiter">// </span><span class="comment">Convert HTTP_XXX to readable header name</span>
            <span class="type">string</span> header_name <span class="punctuation">=</span> <span class="function-name">replace</span><span class="punctuation">(</span>var<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">substring</span><span class="punctuation">(</span><span class="number">5</span><span class="punctuation">),</span> <span class="string">"_"</span><span class="punctuation">,</span> <span class="string">"-"</span><span class="punctuation">);</span>
            output <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%s: %s\n"</span><span class="punctuation">,</span> header_name<span class="punctuation">,</span> value<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> output<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Dump all CGI environment variables</span>
<span class="type">string</span> dump_cgi_environment<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="string">"=== CGI Environment ===\n"</span><span class="punctuation">;</span>

    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> cgi_vars <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span>
        <span class="string">"REQUEST_METHOD"</span><span class="punctuation">,</span> <span class="string">"REQUEST_URI"</span><span class="punctuation">,</span> <span class="string">"QUERY_STRING"</span><span class="punctuation">,</span>
        <span class="string">"CONTENT_TYPE"</span><span class="punctuation">,</span> <span class="string">"CONTENT_LENGTH"</span><span class="punctuation">,</span>
        <span class="string">"SCRIPT_NAME"</span><span class="punctuation">,</span> <span class="string">"PATH_INFO"</span><span class="punctuation">,</span> <span class="string">"PATH_TRANSLATED"</span><span class="punctuation">,</span>
        <span class="string">"SERVER_NAME"</span><span class="punctuation">,</span> <span class="string">"SERVER_PORT"</span><span class="punctuation">,</span> <span class="string">"SERVER_PROTOCOL"</span><span class="punctuation">,</span>
        <span class="string">"REMOTE_ADDR"</span><span class="punctuation">,</span> <span class="string">"REMOTE_HOST"</span><span class="punctuation">,</span> <span class="string">"REMOTE_USER"</span><span class="punctuation">,</span>
        <span class="string">"AUTH_TYPE"</span><span class="punctuation">,</span> <span class="string">"DOCUMENT_ROOT"</span>
    <span class="punctuation">});</span>

    <span class="keyword">foreach</span><span class="punctuation">(</span>cgi_vars<span class="punctuation">;</span> <span class="type">string</span> var<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> value <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span>var<span class="punctuation">);</span>
        output <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%s: %s\n"</span><span class="punctuation">,</span> var<span class="punctuation">,</span> value <span class="punctuation">||</span> <span class="string">"(not set)"</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> output<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Read and dump raw POST data</span>
<span class="type">string</span> dump_post_data<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="string">"=== POST Data ===\n"</span><span class="punctuation">;</span>

    <span class="type">string</span> method <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"GET"</span><span class="punctuation">;</span>
    <span class="type">string</span> content_type <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"CONTENT_TYPE"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    output <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Method: %s\n"</span><span class="punctuation">,</span> method<span class="punctuation">);</span>
    output <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Content-Type: %s\n"</span><span class="punctuation">,</span> content_type<span class="punctuation">);</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>method <span class="punctuation">==</span> <span class="string">"POST"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> length <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"CONTENT_LENGTH"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"0"</span><span class="punctuation">;</span>
        output <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Content-Length: %s\n"</span><span class="punctuation">,</span> length<span class="punctuation">);</span>

        <span class="type">int</span> len <span class="punctuation">=</span> <span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span>length<span class="punctuation">;</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>len <span class="punctuation">&gt;</span> <span class="number">0</span> <span class="punctuation">&amp;&amp;</span> len <span class="punctuation">&lt;</span> <span class="number">1048576</span><span class="punctuation">)</span> <span class="punctuation">{</span>  <span class="comment-delimiter">// </span><span class="comment">Max 1MB</span>
            <span class="type">string</span> data <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">(</span><span class="constant">stdin</span><span class="punctuation">).</span><span class="function-name">read</span><span class="punctuation">(</span>len<span class="punctuation">);</span>

            <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">has_prefix</span><span class="punctuation">(</span>content_type<span class="punctuation">,</span> <span class="string">"application/x-www-form-urlencoded"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
                <span class="comment-delimiter">// </span><span class="comment">Parse form data</span>
                output <span class="punctuation">+=</span> <span class="string">"\nParsed Form Data:\n"</span><span class="punctuation">;</span>
                <span class="keyword">foreach</span><span class="punctuation">(</span>data <span class="punctuation">/</span> <span class="string">"&amp;"</span><span class="punctuation">;</span> <span class="type">string</span> pair<span class="punctuation">)</span> <span class="punctuation">{</span>
                    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> parts <span class="punctuation">=</span> pair <span class="punctuation">/</span> <span class="string">"="</span><span class="punctuation">;</span>
                    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>parts<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                        <span class="type">string</span> key <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">http_decode_url</span><span class="punctuation">(</span>parts<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]);</span>
                        <span class="type">string</span> val <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">http_decode_url</span><span class="punctuation">(</span>parts<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]);</span>
                        output <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"  %s: %s\n"</span><span class="punctuation">,</span> key<span class="punctuation">,</span> val<span class="punctuation">);</span>
                    <span class="punctuation">}</span>
                <span class="punctuation">}</span>
            <span class="punctuation">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">has_prefix</span><span class="punctuation">(</span>content_type<span class="punctuation">,</span> <span class="string">"application/json"</span><span class="punctuation">))</span> <span class="punctuation">{</span>
                output <span class="punctuation">+=</span> <span class="string">"\nJSON Data:\n"</span> <span class="punctuation">+</span> data <span class="punctuation">+</span> <span class="string">"\n"</span><span class="punctuation">;</span>
            <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
                output <span class="punctuation">+=</span> <span class="string">"\nRaw POST Data (first 500 chars):\n"</span><span class="punctuation">;</span>
                output <span class="punctuation">+=</span> data<span class="punctuation">[</span><span class="number">0.</span><span class="punctuation">.</span><span class="number">499</span><span class="punctuation">]</span> <span class="punctuation">+</span> <span class="string">"\n"</span><span class="punctuation">;</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> output<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Parse and display cookies</span>
<span class="type">string</span> dump_cookies<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="string">"=== Cookies ===\n"</span><span class="punctuation">;</span>
    <span class="type">string</span> cookie_header <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"HTTP_COOKIE"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>cookie_header <span class="punctuation">==</span> <span class="string">""</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        output <span class="punctuation">+=</span> <span class="string">"(No cookies sent)\n"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>cookie_header <span class="punctuation">/</span> <span class="string">";"</span><span class="punctuation">;</span> <span class="type">string</span> cookie<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> parts <span class="punctuation">=</span> <span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">trim_all</span><span class="punctuation">(</span>cookie<span class="punctuation">)</span> <span class="punctuation">/</span> <span class="string">"="</span><span class="punctuation">;</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>parts<span class="punctuation">)</span> <span class="punctuation">&gt;=</span> <span class="number">2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                output <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%s: %s\n"</span><span class="punctuation">,</span> parts<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">],</span> parts<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]</span> <span class="punctuation">*</span> <span class="string">"="</span><span class="punctuation">);</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> output<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Generate full HTTP request dump</span>
<span class="type">string</span> dump_full_request<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="string">""</span><span class="punctuation">;</span>

    output <span class="punctuation">+=</span> <span class="function-name">dump_cgi_environment</span><span class="punctuation">();</span>
    output <span class="punctuation">+=</span> <span class="string">"\n"</span><span class="punctuation">;</span>
    output <span class="punctuation">+=</span> <span class="function-name">dump_request_headers</span><span class="punctuation">();</span>
    output <span class="punctuation">+=</span> <span class="string">"\n"</span><span class="punctuation">;</span>
    output <span class="punctuation">+=</span> <span class="function-name">dump_cookies</span><span class="punctuation">();</span>
    output <span class="punctuation">+=</span> <span class="string">"\n"</span><span class="punctuation">;</span>
    output <span class="punctuation">+=</span> <span class="function-name">dump_post_data</span><span class="punctuation">();</span>

    <span class="keyword">return</span> output<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Save request info to debug log</span>
<span class="type">void</span> log_request<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> remote <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REMOTE_ADDR"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"unknown"</span><span class="punctuation">;</span>
    <span class="type">string</span> method <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"UNKNOWN"</span><span class="punctuation">;</span>
    <span class="type">string</span> uri <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_URI"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"/"</span><span class="punctuation">;</span>

    <span class="function-name">debug_log</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%s %s from %s"</span><span class="punctuation">,</span> method<span class="punctuation">,</span> uri<span class="punctuation">,</span> remote<span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Pretty HTML output for debugging</span>
<span class="type">string</span> html_debug_output<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="function-name">dump_full_request</span><span class="punctuation">();</span>

    <span class="comment-delimiter">// </span><span class="comment">Escape HTML and wrap in &lt;pre&gt; tags</span>
    output <span class="punctuation">=</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>output<span class="punctuation">,</span> <span class="string">"&lt;"</span><span class="punctuation">,</span> <span class="string">"&amp;lt;"</span><span class="punctuation">),</span>
            <span class="string">"&gt;"</span><span class="punctuation">,</span> <span class="string">"&amp;gt;"</span><span class="punctuation">),</span>
            <span class="string">"\n"</span><span class="punctuation">,</span> <span class="string">"&lt;br&gt;\n"</span><span class="punctuation">);</span>

    <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;HTTP Debug Info&lt;/title&gt;
&lt;style&gt;
    body { font-family: monospace; margin: 20px; background: #1e1e1e; color: #d4d4d4; }
    h1 { color: #4ec9b0; }
    .section { color: #569cd6; font-weight: bold; margin-top: 20px; }
    pre { background: #252526; padding: 15px; border-radius: 5px; }
&lt;/style&gt;
&lt;/head&gt;&lt;body&gt;
    &lt;h1&gt;HTTP Request Debug Information&lt;/h1&gt;
    &lt;pre&gt;%s&lt;/pre&gt;
    &lt;hr&gt;
    &lt;p&gt;&lt;small&gt;Timestamp: %s&lt;/small&gt;&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">,</span>
            output<span class="punctuation">,</span> <span class="function-name">ctime</span><span class="punctuation">(</span><span class="function-name">time</span><span class="punctuation">()));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Main debug CGI handler</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Always log requests</span>
    <span class="function-name">log_request</span><span class="punctuation">();</span>

    <span class="comment-delimiter">// </span><span class="comment">Check if debugging is enabled</span>
    <span class="type">string</span> debug <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"DEBUG_HTTP"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"QUERY_STRING"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>debug <span class="punctuation">==</span> <span class="string">"1"</span> <span class="punctuation">||</span> debug <span class="punctuation">==</span> <span class="string">"debug"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">html_debug_output</span><span class="punctuation">());</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="comment-delimiter">// </span><span class="comment">Normal request handling</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;HTTP Debug Tool&lt;/title&gt;
&lt;style&gt;body{font-family:Arial,sans-serif;margin:40px;text-align:center;}&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;HTTP Debug Tool&lt;/h1&gt;
    &lt;p&gt;Add &lt;code&gt;?debug&lt;/code&gt; to URL to see full HTTP request dump.&lt;/p&gt;
    &lt;p&gt;All requests are logged to: /tmp/http_debug.log&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1037"
>Managing Cookies</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.11: Managing Cookies - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">Cookie management for CGI applications</span>

<span class="comment-delimiter">// </span><span class="comment">Parse Cookie header into mapping</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> parse_cookies<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> cookies <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
    <span class="type">string</span> cookie_header <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"HTTP_COOKIE"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>cookie_header <span class="punctuation">!=</span> <span class="string">""</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>cookie_header <span class="punctuation">/</span> <span class="string">";"</span><span class="punctuation">;</span> <span class="type">string</span> cookie<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">string</span> trimmed <span class="punctuation">=</span> <span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">trim_all</span><span class="punctuation">(</span>cookie<span class="punctuation">);</span>
            <span class="type">int</span> pos <span class="punctuation">=</span> <span class="function-name">search</span><span class="punctuation">(</span>trimmed<span class="punctuation">,</span> <span class="string">"="</span><span class="punctuation">);</span>
            <span class="keyword">if</span> <span class="punctuation">(</span>pos <span class="punctuation">&gt;</span> <span class="number">0</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="type">string</span> name <span class="punctuation">=</span> trimmed<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">..</span><span class="punctuation">p</span><span class="punctuation">o</span><span class="punctuation">s-</span><span class="number">1</span><span class="punctuation">];</span>
                <span class="type">string</span> value <span class="punctuation">=</span> trimmed<span class="punctuation">[</span>pos<span class="punctuation">+</span><span class="number">1</span><span class="punctuation">..]</span><span class="punctuation">;</span>
                cookies<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">=</span> value<span class="punctuation">;</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> cookies<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Cookie attributes</span>
<span class="keyword">class</span> CookieAttributes <span class="punctuation">{</span>
    <span class="type">string</span> value<span class="punctuation">;</span>
    <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> max_age<span class="punctuation">;</span>
    <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> expires<span class="punctuation">;</span>
    <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> domain<span class="punctuation">;</span>
    <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> path<span class="punctuation">;</span>
    <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> secure<span class="punctuation">;</span>
    <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> http_only<span class="punctuation">;</span>
    <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> same_site<span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">"Strict", "Lax", or "None"</span>

    <span class="type">void</span> create<span class="punctuation">(</span><span class="type">string</span> _value<span class="punctuation">,</span>
                      <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
        value <span class="punctuation">=</span> _value<span class="punctuation">;</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
            max_age <span class="punctuation">=</span> attrs<span class="punctuation">[</span><span class="string">"max_age"</span><span class="punctuation">];</span>
            expires <span class="punctuation">=</span> attrs<span class="punctuation">[</span><span class="string">"expires"</span><span class="punctuation">];</span>
            domain <span class="punctuation">=</span> attrs<span class="punctuation">[</span><span class="string">"domain"</span><span class="punctuation">];</span>
            path <span class="punctuation">=</span> attrs<span class="punctuation">[</span><span class="string">"path"</span><span class="punctuation">];</span>
            secure <span class="punctuation">=</span> attrs<span class="punctuation">[</span><span class="string">"secure"</span><span class="punctuation">];</span>
            http_only <span class="punctuation">=</span> attrs<span class="punctuation">[</span><span class="string">"http_only"</span><span class="punctuation">];</span>
            same_site <span class="punctuation">=</span> attrs<span class="punctuation">[</span><span class="string">"same_site"</span><span class="punctuation">];</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="type">string</span> format<span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="type">string</span> result <span class="punctuation">=</span> value<span class="punctuation">;</span>

        <span class="keyword">if</span> <span class="punctuation">(</span>max_age<span class="punctuation">)</span> <span class="punctuation">{</span>
            result <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"; Max-Age=%d"</span><span class="punctuation">,</span> max_age<span class="punctuation">);</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>expires<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">string</span> date <span class="punctuation">=</span> <span class="function-name">Calendar</span><span class="punctuation">.</span><span class="function-name">Second</span><span class="punctuation">(</span>expires<span class="punctuation">)-&gt;</span><span class="function-name">format_http</span><span class="punctuation">();</span>
            result <span class="punctuation">+=</span> <span class="string">"; Expires="</span> <span class="punctuation">+</span> date<span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>path<span class="punctuation">)</span> <span class="punctuation">{</span>
            result <span class="punctuation">+=</span> <span class="string">"; Path="</span> <span class="punctuation">+</span> path<span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>domain<span class="punctuation">)</span> <span class="punctuation">{</span>
            result <span class="punctuation">+=</span> <span class="string">"; Domain="</span> <span class="punctuation">+</span> domain<span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>secure<span class="punctuation">)</span> <span class="punctuation">{</span>
            result <span class="punctuation">+=</span> <span class="string">"; Secure"</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>http_only<span class="punctuation">)</span> <span class="punctuation">{</span>
            result <span class="punctuation">+=</span> <span class="string">"; HttpOnly"</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>same_site<span class="punctuation">)</span> <span class="punctuation">{</span>
            result <span class="punctuation">+=</span> <span class="string">"; SameSite="</span> <span class="punctuation">+</span> same_site<span class="punctuation">;</span>
        <span class="punctuation">}</span>

        <span class="keyword">return</span> result<span class="punctuation">;</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Set a cookie with full attribute support</span>
<span class="type">void</span> set_cookie<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span>
                  <span class="type">string</span><span class="punctuation">|</span><span class="keyword">CookieAttributes</span> value_or_attrs<span class="punctuation">,</span>
                  <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">CookieAttributes</span> cookie_attrs<span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">objectp</span><span class="punctuation">(</span>value_or_attrs<span class="punctuation">))</span> <span class="punctuation">{</span>
        cookie_attrs <span class="punctuation">=</span> value_or_attrs<span class="punctuation">;</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        cookie_attrs <span class="punctuation">=</span> <span class="function-name">CookieAttributes</span><span class="punctuation">(</span>value_or_attrs<span class="punctuation">,</span> attrs<span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="type">string</span> cookie <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%s=%s"</span><span class="punctuation">,</span> name<span class="punctuation">,</span> cookie_attrs<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">format</span><span class="punctuation">());</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"Set-Cookie: %s\r\n"</span><span class="punctuation">,</span> cookie<span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Delete a cookie by setting max-age=0</span>
<span class="type">void</span> delete_cookie<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span> <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> path<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">!</span>path<span class="punctuation">)</span> path <span class="punctuation">=</span> <span class="string">"/"</span><span class="punctuation">;</span>
    <span class="function-name">set_cookie</span><span class="punctuation">(</span>name<span class="punctuation">,</span> <span class="string">""</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"max_age"</span><span class="punctuation">:</span> <span class="number">0</span><span class="punctuation">,</span>
        <span class="string">"path"</span><span class="punctuation">:</span> path<span class="punctuation">,</span>
        <span class="string">"expires"</span><span class="punctuation">:</span> <span class="number">1</span>  <span class="comment-delimiter">// </span><span class="comment">Unix timestamp 1 = past</span>
    <span class="punctuation">]));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Session management using cookies</span>
<span class="keyword">class</span> Session <span class="punctuation">{</span>
    <span class="type">string</span> session_id<span class="punctuation">;</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span> data <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
    <span class="type">int</span> created<span class="punctuation">;</span>
    <span class="type">int</span> last_activity<span class="punctuation">;</span>
    <span class="type">int</span> timeout <span class="punctuation">=</span> <span class="number">1800</span><span class="punctuation">;</span>  <span class="comment-delimiter">// </span><span class="comment">30 minutes</span>

    <span class="type">void</span> create<span class="punctuation">(</span><span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> id<span class="punctuation">)</span> <span class="punctuation">{</span>
        created <span class="punctuation">=</span> <span class="function-name">time</span><span class="punctuation">();</span>
        last_activity <span class="punctuation">=</span> created<span class="punctuation">;</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>id<span class="punctuation">)</span> <span class="punctuation">{</span>
            session_id <span class="punctuation">=</span> id<span class="punctuation">;</span>
        <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
            session_id <span class="punctuation">=</span> <span class="function-name">generate_session_id</span><span class="punctuation">();</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="type">string</span> generate_session_id<span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="type">string</span> data <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"%d.%s.%d"</span><span class="punctuation">,</span>
                               <span class="function-name">time</span><span class="punctuation">(),</span>
                               <span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">string2hex</span><span class="punctuation">(</span><span class="function-name">Crypto</span><span class="punctuation">.</span><span class="function-name">Random</span><span class="punctuation">.</span><span class="function-name">random_string</span><span class="punctuation">(</span><span class="number">16</span><span class="punctuation">)),</span>
                               <span class="function-name">getpid</span><span class="punctuation">());</span>
        <span class="keyword">return</span> <span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">hash2</span><span class="punctuation">(</span>data<span class="punctuation">,</span> <span class="string">"SHA256"</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="type">int</span> is_expired<span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="punctuation">(</span><span class="function-name">time</span><span class="punctuation">()</span> <span class="punctuation">-</span> last_activity<span class="punctuation">)</span> <span class="punctuation">&gt;</span> timeout<span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> touch<span class="punctuation">()</span> <span class="punctuation">{</span>
        last_activity <span class="punctuation">=</span> <span class="function-name">time</span><span class="punctuation">();</span>
    <span class="punctuation">}</span>

    <span class="type">mixed</span> get<span class="punctuation">(</span><span class="type">string</span> key<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> data<span class="punctuation">[</span>key<span class="punctuation">];</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> set<span class="punctuation">(</span><span class="type">string</span> key<span class="punctuation">,</span> <span class="type">mixed</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
        data<span class="punctuation">[</span>key<span class="punctuation">]</span> <span class="punctuation">=</span> value<span class="punctuation">;</span>
        <span class="function-name">touch</span><span class="punctuation">();</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">In-memory session store (for production, use database)</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">Session</span><span class="punctuation">)</span> sessions <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>

<span class="type">Session</span><span class="punctuation">|</span><span class="keyword">zero</span> get_session<span class="punctuation">(</span><span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> session_id<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Clean up expired sessions first</span>
    <span class="keyword">foreach</span> <span class="punctuation">(</span><span class="function-name">indices</span><span class="punctuation">(</span>sessions<span class="punctuation">);</span> <span class="type">string</span> id<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span>sessions<span class="punctuation">[</span>id<span class="punctuation">]</span><span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">is_expired</span><span class="punctuation">())</span> <span class="punctuation">{</span>
            m_delete<span class="punctuation">(</span>sessions<span class="punctuation">,</span> id<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>session_id <span class="punctuation">&amp;&amp;</span> sessions<span class="punctuation">[</span>session_id<span class="punctuation">]</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">Session</span> s <span class="punctuation">=</span> sessions<span class="punctuation">[</span>session_id<span class="punctuation">];</span>
        s<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">touch</span><span class="punctuation">();</span>
        <span class="keyword">return</span> s<span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Create new session</span>
    <span class="type">Session</span> new_session <span class="punctuation">=</span> <span class="function-name">Session</span><span class="punctuation">();</span>
    sessions<span class="punctuation">[</span>new_session<span class="punctuation">-</span><span class="punctuation">&gt;</span>session_id<span class="punctuation">]</span> <span class="punctuation">=</span> new_session<span class="punctuation">;</span>
    <span class="keyword">return</span> new_session<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Send session cookie</span>
<span class="type">void</span> send_session_cookie<span class="punctuation">(</span><span class="type">Session</span> session<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="function-name">set_cookie</span><span class="punctuation">(</span><span class="string">"session_id"</span><span class="punctuation">,</span> session<span class="punctuation">-</span><span class="punctuation">&gt;</span>session_id<span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"http_only"</span><span class="punctuation">:</span> <span class="number">1</span><span class="punctuation">,</span>
        <span class="string">"same_site"</span><span class="punctuation">:</span> <span class="string">"Lax"</span><span class="punctuation">,</span>
        <span class="string">"path"</span><span class="punctuation">:</span> <span class="string">"/"</span><span class="punctuation">,</span>
        <span class="string">"max_age"</span><span class="punctuation">:</span> <span class="number">3600</span>
    <span class="punctuation">]));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Example usage: Counter with session persistence</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Get session from cookie</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> cookies <span class="punctuation">=</span> <span class="function-name">parse_cookies</span><span class="punctuation">();</span>
    <span class="type">Session</span> session <span class="punctuation">=</span> <span class="function-name">get_session</span><span class="punctuation">(</span>cookies<span class="punctuation">[</span><span class="string">"session_id"</span><span class="punctuation">]);</span>

    <span class="comment-delimiter">// </span><span class="comment">Handle actions</span>
    <span class="type">string</span> action <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"QUERY_STRING"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>action <span class="punctuation">==</span> <span class="string">"increment"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">int</span> count <span class="punctuation">=</span> <span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span><span class="punctuation">(</span>session<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get</span><span class="punctuation">(</span><span class="string">"count"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"0"</span><span class="punctuation">);</span>
        session<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">set</span><span class="punctuation">(</span><span class="string">"count"</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)(</span>count <span class="punctuation">+</span> <span class="number">1</span><span class="punctuation">));</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span>action <span class="punctuation">==</span> <span class="string">"reset"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        session<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">set</span><span class="punctuation">(</span><span class="string">"count"</span><span class="punctuation">,</span> <span class="string">"0"</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Ensure session cookie is set</span>
    <span class="function-name">send_session_cookie</span><span class="punctuation">(</span>session<span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Send response</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>

    <span class="type">int</span> count <span class="punctuation">=</span> <span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span><span class="punctuation">(</span>session<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get</span><span class="punctuation">(</span><span class="string">"count"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"0"</span><span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Session Counter&lt;/title&gt;
&lt;style&gt;
    body { font-family: Arial, sans-serif; margin: 40px; text-align: center; }
    .counter { font-size: 48px; margin: 20px 0; }
    button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Session Counter&lt;/h1&gt;
    &lt;p&gt;Session ID: %s&lt;/p&gt;
    &lt;div class="counter"&gt;%d&lt;/div&gt;
    &lt;a href="?increment"&gt;&lt;button&gt;Increment&lt;/button&gt;&lt;/a&gt;
    &lt;a href="?reset"&gt;&lt;button&gt;Reset&lt;/button&gt;&lt;/a&gt;
    &lt;p&gt;&lt;small&gt;Refresh to persist. Close browser to end session.&lt;/small&gt;&lt;/p&gt;
&lt;/body&gt;&lt;/html&gt;</span><span class="string">"</span><span class="punctuation">,</span>
            session<span class="punctuation">-</span><span class="punctuation">&gt;</span>session_id<span class="punctuation">,</span> count<span class="punctuation">));</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1040"
>Creating Sticky Widgets</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.12: Creating Sticky Widgets - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">Sticky widgets preserve user input across form submissions</span>

<span class="comment-delimiter">// </span><span class="comment">HTML escape function</span>
<span class="type">string</span> h<span class="punctuation">(</span><span class="type">string</span> s<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>s<span class="punctuation">,</span> <span class="string">"&amp;"</span><span class="punctuation">,</span> <span class="string">"&amp;amp;"</span><span class="punctuation">),</span>
            <span class="string">"&lt;"</span><span class="punctuation">,</span> <span class="string">"&amp;lt;"</span><span class="punctuation">),</span>
            <span class="string">"&gt;"</span><span class="punctuation">,</span> <span class="string">"&amp;gt;"</span><span class="punctuation">),</span>
            <span class="string">"\""</span><span class="punctuation">,</span> <span class="string">"&amp;quot;"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Parse form data from GET or POST</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> parse_form<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
    <span class="type">string</span> data<span class="punctuation">;</span>

    <span class="type">string</span> method <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"GET"</span><span class="punctuation">;</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>method <span class="punctuation">==</span> <span class="string">"POST"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> length <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"CONTENT_LENGTH"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"0"</span><span class="punctuation">;</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span>length <span class="punctuation">&gt;</span> <span class="number">0</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            data <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">(</span><span class="constant">stdin</span><span class="punctuation">).</span><span class="function-name">read</span><span class="punctuation">(</span><span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span>length<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        data <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"QUERY_STRING"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>data <span class="punctuation">/</span> <span class="string">"&amp;"</span><span class="punctuation">;</span> <span class="type">string</span> pair<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> parts <span class="punctuation">=</span> pair <span class="punctuation">/</span> <span class="string">"="</span><span class="punctuation">;</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>parts<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                form<span class="punctuation">[</span>parts<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]]</span> <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">http_decode_url</span><span class="punctuation">(</span>parts<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]);</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> form<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Sticky text input</span>
<span class="type">string</span> sticky_input<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span>
                      <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> value<span class="punctuation">,</span>
                      <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> attrs<span class="punctuation">,</span>
                      <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Use submitted value or default</span>
    <span class="type">string</span> display_value <span class="punctuation">=</span> form<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">||</span> value <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="type">string</span> attr_str <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"name=\"%s\" value=\"%s\""</span><span class="punctuation">,</span> name<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>display_value<span class="punctuation">));</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>attrs<span class="punctuation">;</span> <span class="type">string</span> k<span class="punctuation">;</span> <span class="type">string</span> v<span class="punctuation">)</span> <span class="punctuation">{</span>
            attr_str <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">" %s=\"%s\""</span><span class="punctuation">,</span> k<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>v<span class="punctuation">));</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="string">"&lt;input "</span> <span class="punctuation">+</span> attr_str <span class="punctuation">+</span> <span class="string">"&gt;"</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Sticky textarea</span>
<span class="type">string</span> sticky_textarea<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span>
                          <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> value<span class="punctuation">,</span>
                          <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> attrs<span class="punctuation">,</span>
                          <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> display_value <span class="punctuation">=</span> form<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">||</span> value <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="type">string</span> attr_str <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"name=\"%s\""</span><span class="punctuation">,</span> name<span class="punctuation">);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>attrs<span class="punctuation">;</span> <span class="type">string</span> k<span class="punctuation">;</span> <span class="type">string</span> v<span class="punctuation">)</span> <span class="punctuation">{</span>
            attr_str <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">" %s=\"%s\""</span><span class="punctuation">,</span> k<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>v<span class="punctuation">));</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;textarea %s&gt;%s&lt;/textarea&gt;"</span><span class="punctuation">,</span>
                     attr_str<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>display_value<span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Sticky checkbox</span>
<span class="type">string</span> sticky_checkbox<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span>
                         <span class="type">string</span> value<span class="punctuation">,</span>
                         <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> default_checked<span class="punctuation">,</span>
                         <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> attrs<span class="punctuation">,</span>
                         <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Check if this checkbox was submitted</span>
    <span class="type">int</span> checked <span class="punctuation">=</span> default_checked <span class="punctuation">||</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>form<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">==</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
        checked <span class="punctuation">=</span> <span class="number">1</span><span class="punctuation">;</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">indices</span><span class="punctuation">(</span>form<span class="punctuation">)</span> <span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">&amp;&amp;</span> form<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">!=</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="comment-delimiter">// </span><span class="comment">Checkbox exists in form but has different value = unchecked</span>
        checked <span class="punctuation">=</span> <span class="number">0</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">string</span> attr_str <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"type=\"checkbox\" name=\"%s\" value=\"%s\""</span><span class="punctuation">,</span>
                              name<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>value<span class="punctuation">));</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>checked<span class="punctuation">)</span> attr_str <span class="punctuation">+=</span> <span class="string">" checked"</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>attrs<span class="punctuation">;</span> <span class="type">string</span> k<span class="punctuation">;</span> <span class="type">string</span> v<span class="punctuation">)</span> <span class="punctuation">{</span>
            attr_str <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">" %s=\"%s\""</span><span class="punctuation">,</span> k<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>v<span class="punctuation">));</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> <span class="string">"&lt;input "</span> <span class="punctuation">+</span> attr_str <span class="punctuation">+</span> <span class="string">"&gt;"</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Sticky radio button group</span>
<span class="type">string</span> sticky_radio<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span>
                       <span class="type">array</span><span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">))</span> options<span class="punctuation">,</span>  <span class="comment-delimiter">// </span><span class="comment">({({value, label}), ...})</span>
                       <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> selected<span class="punctuation">,</span>
                       <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> current <span class="punctuation">=</span> form<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">||</span> selected <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="type">string</span> html <span class="punctuation">=</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="keyword">foreach</span><span class="punctuation">(</span>options<span class="punctuation">;</span> <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> option<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> value <span class="punctuation">=</span> option<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">];</span>
        <span class="type">string</span> label <span class="punctuation">=</span> option<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">];</span>
        <span class="type">string</span> sel <span class="punctuation">=</span> <span class="punctuation">(</span>value == current<span class="punctuation">)</span> <span class="punctuation">?</span> <span class="string">" checked"</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">;</span>
        html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;label&gt;&lt;input type=\"radio\" name=\"%s\" value=\"%s\"%s&gt; %s&lt;/label&gt;\n"</span><span class="punctuation">,</span>
                          name<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>value<span class="punctuation">),</span> sel<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>label<span class="punctuation">));</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> html<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Sticky select dropdown</span>
<span class="type">string</span> sticky_select<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span>
                        <span class="type">array</span><span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">))</span> options<span class="punctuation">,</span>
                        <span class="type">string</span><span class="punctuation">|</span><span class="keyword">void</span> selected<span class="punctuation">,</span>
                        <span class="type">int</span><span class="punctuation">|</span><span class="keyword">void</span> multiple<span class="punctuation">,</span>
                        <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> current <span class="punctuation">=</span> form<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">||</span> selected <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="type">string</span> html <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;select name=\"%s\"%s&gt;\n"</span><span class="punctuation">,</span>
                              name<span class="punctuation">,</span> multiple <span class="punctuation">?</span> <span class="string">" multiple"</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">);</span>

    <span class="keyword">foreach</span><span class="punctuation">(</span>options<span class="punctuation">;</span> <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> option<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> value <span class="punctuation">=</span> option<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">];</span>
        <span class="type">string</span> label <span class="punctuation">=</span> option<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">];</span>
        <span class="type">string</span> sel <span class="punctuation">=</span> <span class="punctuation">(</span>value == current<span class="punctuation">)</span> <span class="punctuation">?</span> <span class="string">" selected"</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">;</span>
        html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"  &lt;option value=\"%s\"%s&gt;%s&lt;/option&gt;\n"</span><span class="punctuation">,</span>
                          <span class="function-name">h</span><span class="punctuation">(</span>value<span class="punctuation">),</span> sel<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>label<span class="punctuation">));</span>
    <span class="punctuation">}</span>

    html <span class="punctuation">+=</span> <span class="string">"&lt;/select&gt;"</span><span class="punctuation">;</span>
    <span class="keyword">return</span> html<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Sticky multiselect (returns array of values)</span>
<span class="type">string</span> sticky_multiselect<span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span>
                           <span class="type">array</span><span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">))</span> options<span class="punctuation">,</span>
                           <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span><span class="punctuation">|</span><span class="keyword">void</span> selected<span class="punctuation">,</span>
                           <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Parse multiple values from form (e.g., "name=val1&amp;name=val2")</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> current <span class="punctuation">=</span> selected <span class="punctuation">||</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>

    <span class="comment-delimiter">// </span><span class="comment">Collect all submitted values for this name</span>
    <span class="comment-delimiter">// </span><span class="comment">(In a real implementation, you'd parse all values for the same key)</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>form<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">&amp;&amp;</span> form<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">!=</span> <span class="string">""</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        current <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span> form<span class="punctuation">[</span>name<span class="punctuation">]</span> <span class="punctuation">});</span>
    <span class="punctuation">}</span>

    <span class="type">string</span> html <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;select name=\"%s\" multiple&gt;\n"</span><span class="punctuation">,</span> name<span class="punctuation">);</span>

    <span class="keyword">foreach</span><span class="punctuation">(</span>options<span class="punctuation">;</span> <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> option<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> value <span class="punctuation">=</span> option<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">];</span>
        <span class="type">string</span> label <span class="punctuation">=</span> option<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">];</span>
        <span class="type">string</span> sel <span class="punctuation">=</span> <span class="function-name">has_value</span><span class="punctuation">(</span>current<span class="punctuation">,</span> value<span class="punctuation">)</span> <span class="punctuation">?</span> <span class="string">" selected"</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">;</span>
        html <span class="punctuation">+=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"  &lt;option value=\"%s\"%s&gt;%s&lt;/option&gt;\n"</span><span class="punctuation">,</span>
                          <span class="function-name">h</span><span class="punctuation">(</span>value<span class="punctuation">),</span> sel<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>label<span class="punctuation">));</span>
    <span class="punctuation">}</span>

    html <span class="punctuation">+=</span> <span class="string">"&lt;/select&gt;"</span><span class="punctuation">;</span>
    <span class="keyword">return</span> html<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Complete sticky form example</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form <span class="punctuation">=</span> <span class="function-name">parse_form</span><span class="punctuation">();</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;&lt;title&gt;Sticky Form Demo&lt;/title&gt;
&lt;style&gt;
    body { font-family: Arial, sans-serif; margin: 40px; }
    fieldset { border: 1px solid #ddd; padding: 20px; margin-bottom: 20px; border-radius: 8px; }
    legend { font-weight: bold; padding: 0 10px; }
    label { display: block; margin: 10px 0 5px; }
    input[type="text"], textarea, select { width: 300px; padding: 8px; }
    textarea { height: 80px; }
    button { padding: 10px 20px; cursor: pointer; }
    .result { background: #e8f5e9; padding: 15px; border-radius: 5px; margin: 20px 0; }
&lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;h1&gt;Sticky Form Widgets Demo&lt;/h1&gt;
    &lt;p&gt;Submit the form - your values will be preserved!&lt;/p&gt;</span><span class="string">"</span><span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Show submitted values</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>form<span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;div class=\"result\"&gt;&lt;strong&gt;Submitted values:&lt;/strong&gt;&lt;ul&gt;\n"</span><span class="punctuation">);</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>form<span class="punctuation">;</span> <span class="type">string</span> k<span class="punctuation">;</span> <span class="type">string</span> v<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">write</span><span class="punctuation">(</span><span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;li&gt;%s: %s&lt;/li&gt;\n"</span><span class="punctuation">,</span> k<span class="punctuation">,</span> <span class="function-name">h</span><span class="punctuation">(</span>v<span class="punctuation">)));</span>
        <span class="punctuation">}</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;/ul&gt;&lt;/div&gt;\n"</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Generate sticky form</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;form method=\"POST\"&gt;\n"</span><span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  &lt;fieldset&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    &lt;legend&gt;Personal Information&lt;/legend&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    &lt;label&gt;Name:&lt;/label&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    "</span> <span class="punctuation">+</span> <span class="function-name">sticky_input</span><span class="punctuation">(</span><span class="string">"name"</span><span class="punctuation">,</span> <span class="string">"Enter your name"</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="string">"placeholder"</span><span class="punctuation">:</span> <span class="string">"John Doe"</span><span class="punctuation">]),</span> form<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    &lt;label&gt;Email:&lt;/label&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    "</span> <span class="punctuation">+</span> <span class="function-name">sticky_input</span><span class="punctuation">(</span><span class="string">"email"</span><span class="punctuation">,</span> <span class="string">""</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="string">"type"</span><span class="punctuation">:</span> <span class="string">"email"</span><span class="punctuation">,</span> <span class="string">"placeholder"</span><span class="punctuation">:</span> <span class="string">"john@example.com"</span><span class="punctuation">]),</span> form<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  &lt;/fieldset&gt;\n"</span><span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  &lt;fieldset&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    &lt;legend&gt;Preferences&lt;/legend&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    &lt;label&gt;Favorite Color:&lt;/label&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    "</span> <span class="punctuation">+</span> <span class="function-name">sticky_select</span><span class="punctuation">(</span><span class="string">"color"</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">{</span>
        <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"red"</span><span class="punctuation">,</span> <span class="string">"Red"</span><span class="punctuation">}),</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"green"</span><span class="punctuation">,</span> <span class="string">"Green"</span><span class="punctuation">}),</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"blue"</span><span class="punctuation">,</span> <span class="string">"Blue"</span><span class="punctuation">}),</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"purple"</span><span class="punctuation">,</span> <span class="string">"Purple"</span><span class="punctuation">})
    <span class="punctuation">}),</span> <span class="string">"blue"</span><span class="punctuation">,</span> <span class="number">0</span><span class="punctuation">,</span> form<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    "&lt;/fieldset&gt;\n"</span><span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  &lt;fieldset&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    &lt;legend&gt;Options&lt;/legend&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    "&lt;label&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"      "</span> <span class="punctuation">+</span> <span class="function-name">sticky_checkbox</span><span class="punctuation">(</span><span class="string">"subscribe"</span><span class="punctuation">,</span> <span class="string">"yes"</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]),</span> form<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">" Subscribe to newsletter\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    &lt;/label&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  &lt;/fieldset&gt;\n"</span><span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  &lt;fieldset&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    &lt;legend&gt;Message&lt;/legend&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    "&lt;label&gt;Your message:&lt;/label&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"    "</span> <span class="punctuation">+</span> <span class="function-name">sticky_textarea</span><span class="punctuation">(</span><span class="string">"message"</span><span class="punctuation">,</span> <span class="string">"Type here..."</span><span class="punctuation">,</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="string">"rows"</span><span class="punctuation">:</span> <span class="string">"4"</span><span class="punctuation">]),</span> form<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  &lt;/fieldset&gt;\n"</span><span class="punctuation">);</span>

    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  &lt;button type=\"submit\"&gt;Submit&lt;/button&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  &lt;a href=\"?\"&gt;&lt;button type=\"button\"&gt;Reset&lt;/button&gt;&lt;/a&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;/form&gt;\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"&lt;/body&gt;&lt;/html&gt;\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1043"
>Writing a Multiscreen CGI Script</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 19.13: Writing a Multiscreen CGI Script - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">---------------------------------------------------------------</span>

<span class="keyword">#pragma </span><span class="keyword">strict_types</span>
<span class="keyword">#pragma </span><span class="keyword">no_clone</span>

<span class="comment-delimiter">// </span><span class="comment">Multiscreen/state-driven CGI application with navigation</span>

<span class="comment-delimiter">// </span><span class="comment">HTML escape function</span>
<span class="type">string</span> h<span class="punctuation">(</span><span class="type">string</span> s<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span><span class="function-name">replace</span><span class="punctuation">(</span>s<span class="punctuation">,</span> <span class="string">"&amp;"</span><span class="punctuation">,</span> <span class="string">"&amp;amp;"</span><span class="punctuation">),</span>
            <span class="string">"&lt;"</span><span class="punctuation">,</span> <span class="string">"&amp;lt;"</span><span class="punctuation">),</span>
            <span class="string">"&gt;"</span><span class="punctuation">,</span> <span class="string">"&amp;gt;"</span><span class="punctuation">),</span>
            <span class="string">"\""</span><span class="punctuation">,</span> <span class="string">"&amp;quot;"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Parse form data</span>
<span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> parse_form<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
    <span class="type">string</span> data <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"QUERY_STRING"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="type">string</span> method <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"REQUEST_METHOD"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"GET"</span><span class="punctuation">;</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>method <span class="punctuation">==</span> <span class="string">"POST"</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> length <span class="punctuation">=</span> <span class="function-name">getenv</span><span class="punctuation">(</span><span class="string">"CONTENT_LENGTH"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"0"</span><span class="punctuation">;</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span>length <span class="punctuation">&gt;</span> <span class="number">0</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            data <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">(</span><span class="constant">stdin</span><span class="punctuation">).</span><span class="function-name">read</span><span class="punctuation">(</span><span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span>length<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">if</span> <span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>data <span class="punctuation">/</span> <span class="string">"&amp;"</span><span class="punctuation">;</span> <span class="type">string</span> pair<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> parts <span class="punctuation">=</span> pair <span class="punctuation">/</span> <span class="string">"="</span><span class="punctuation">;</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sizeof</span><span class="punctuation">(</span>parts<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                form<span class="punctuation">[</span>parts<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">]]</span> <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">http_decode_url</span><span class="punctuation">(</span>parts<span class="punctuation">[</span><span class="number">1</span><span class="punctuation">]);</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>

    <span class="keyword">return</span> form<span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Application state (session data)</span>
<span class="keyword">class</span> AppState <span class="punctuation">{</span>
    <span class="type">string</span> current_screen<span class="punctuation">;</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> data <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span><span class="punctuation">]);</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> errors <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> messages <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="punctuation">});</span>

    <span class="type">void</span> create<span class="punctuation">(</span><span class="type">string</span> starting_screen<span class="punctuation">)</span> <span class="punctuation">{</span>
        current_screen <span class="punctuation">=</span> starting_screen<span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> set_screen<span class="punctuation">(</span><span class="type">string</span> screen<span class="punctuation">)</span> <span class="punctuation">{</span>
        current_screen <span class="punctuation">=</span> screen<span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> set_data<span class="punctuation">(</span><span class="type">string</span> key<span class="punctuation">,</span> <span class="type">string</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
        data<span class="punctuation">[</span>key<span class="punctuation">]</span> <span class="punctuation">=</span> value<span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="type">string</span><span class="punctuation">|</span><span class="keyword">zero</span> get_data<span class="punctuation">(</span><span class="type">string</span> key<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> data<span class="punctuation">[</span>key<span class="punctuation">];</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> add_error<span class="punctuation">(</span><span class="type">string</span> error<span class="punctuation">)</span> <span class="punctuation">{</span>
        errors <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> error <span class="punctuation">});</span>
    <span class="punctuation">}</span>

    <span class="type">void</span> add_message<span class="punctuation">(</span><span class="type">string</span> message<span class="punctuation">)</span> <span class="punctuation">{</span>
        messages <span class="punctuation">+=</span> <span class="punctuation">(</span><span class="punctuation">{</span> message <span class="punctuation">});</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Navigation helper</span>
<span class="type">string</span> nav_link<span class="punctuation">(</span><span class="type">string</span> screen<span class="punctuation">,</span> <span class="type">string</span> label<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"&lt;a href=\"?screen=%s\"&gt;%s&lt;/a&gt;"</span><span class="punctuation">,</span> screen<span class="punctuation">,</span> label<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Render common header</span>
<span class="type">string</span> render_header<span class="punctuation">(</span><span class="type">AppState</span> state<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
&lt;html&gt;&lt;head&gt;
    &lt;title&gt;Multi-Screen App - %s&lt;/title&gt;
    &lt;style&gt;
        body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f5f5; }
        nav { background: #333; padding: 15px 20px; }
        nav a { color: white; text-decoration: none; margin-right: 20px; }
        nav a:hover { text-decoration: underline; }
        nav a.active { font-weight: bold; color: #4CAF50; }
        .container { max-width: 800px; margin: 30px auto; padding: 30px; background: white; border-radius: 8px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .error { background: #ffebee; color: #c62828; padding: 10px; border-radius: 4px; margin: 10px 0; }
        .message { background: #e8f5e9; color: #2e7d32; padding: 10px; border-radius: 4px; margin: 10px 0; }
        h1 { margin-top: 0; color: #333; }
        label { display: block; margin: 15px 0 5px; font-weight: bold; }
        input, select, textarea { width: 100%%; padding: 10px; border: 1px solid #ddd; border-radius: 4px; box-sizing: border-box; }
        button { background: #4CAF50; color: white; border: none; padding: 12px 24px; border-radius: 4px; cursor: pointer; }
        button:hover { background: #45a049; }
    &lt;/style&gt;
&lt;/head&gt;
&lt;body&gt;
    &lt;nav&gt;
        %s
    &lt;/nav&gt;
    &lt;div class="container"&gt;</span><span class="string">"</span><span class="punctuation">,</span>
        <span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">capitalize</span><span class="punctuation">(</span>state<span class="punctuation">-</span><span class="punctuation">&gt;</span>current_screen<span class="punctuation">),</span>
        <span class="function-name">nav_link</span><span class="punctuation">(</span><span class="string">"home"</span><span class="punctuation">,</span> <span class="string">"Home"</span><span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">" "</span> <span class="punctuation">+</span>
        <span class="function-name">nav_link</span><span class="punctuation">(</span><span class="string">"form"</span><span class="punctuation">,</span> <span class="string">"Form"</span><span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">" "</span> <span class="punctuation">+</span>
        <span class="function-name">nav_link</span><span class="punctuation">(</span><span class="string">"confirm"</span><span class="punctuation">,</span> <span class="string">"Confirm"</span><span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">" "</span> <span class="punctuation">+</span>
        <span class="function-name">nav_link</span><span class="punctuation">(</span><span class="string">"result"</span><span class="punctuation">,</span> <span class="string">"Result"</span><span class="punctuation">)</span>
    <span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Render common footer</span>
<span class="type">string</span> render_footer<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="string">"
    &lt;/div&gt;
&lt;/body&gt;
&lt;/html&gt;"</span><span class="punctuation">;</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Screen: Home</span>
<span class="type">string</span> screen_home<span class="punctuation">(</span><span class="type">AppState</span> state<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">return</span> <span class="function-name">render_header</span><span class="punctuation">(</span>state<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
        &lt;h1&gt;Welcome to the Multi-Screen Application&lt;/h1&gt;
        &lt;p&gt;This is a demonstration of a state-driven CGI application in Pike.&lt;/p&gt;
        &lt;p&gt;Navigate through the screens using the menu above:&lt;/p&gt;
        &lt;ul&gt;
            &lt;li&gt;&lt;strong&gt;Home&lt;/strong&gt; - This page&lt;/li&gt;
            &lt;li&gt;&lt;strong&gt;Form&lt;/strong&gt; - Enter your information&lt;/li&gt;
            &lt;li&gt;&lt;strong&gt;Confirm&lt;/strong&gt; - Review before submitting&lt;/li&gt;
            &lt;li&gt;&lt;strong&gt;Result&lt;/strong&gt; - See the final output&lt;/li&gt;
        &lt;/ul&gt;
        &lt;p&gt;&lt;a href="?screen=form"&gt;&lt;button&gt;Get Started&lt;/button&gt;&lt;/a&gt;&lt;/p&gt;
</span><span class="string">"</span><span class="punctuation">)</span> <span class="punctuation">+</span> <span class="function-name">render_footer</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Screen: Form</span>
<span class="type">string</span> screen_form<span class="punctuation">(</span><span class="type">AppState</span> state<span class="punctuation">,</span> <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> name <span class="punctuation">=</span> form<span class="punctuation">[</span><span class="string">"name"</span><span class="punctuation">]</span> <span class="punctuation">||</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get_data</span><span class="punctuation">(</span><span class="string">"name"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="type">string</span> email <span class="punctuation">=</span> form<span class="punctuation">[</span><span class="string">"email"</span><span class="punctuation">]</span> <span class="punctuation">||</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get_data</span><span class="punctuation">(</span><span class="string">"email"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="type">string</span> interest <span class="punctuation">=</span> form<span class="punctuation">[</span><span class="string">"interest"</span><span class="punctuation">]</span> <span class="punctuation">||</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get_data</span><span class="punctuation">(</span><span class="string">"interest"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"coding"</span><span class="punctuation">;</span>

    <span class="keyword">return</span> <span class="function-name">render_header</span><span class="punctuation">(</span>state<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
        &lt;h1&gt;Enter Your Information&lt;/h1&gt;
        &lt;form method="POST" action="?screen=confirm"&gt;
            &lt;input type="hidden" name="screen" value="form"&gt;
            &lt;label&gt;Name:&lt;/label&gt;
            &lt;input type="text" name="name" value="%s" required&gt;
            &lt;label&gt;Email:&lt;/label&gt;
            &lt;input type="email" name="email" value="%s" required&gt;
            &lt;label&gt;Area of Interest:&lt;/label&gt;
            &lt;select name="interest"&gt;
                &lt;option value="coding"%s&gt;Programming&lt;/option&gt;
                &lt;option value="design"%s&gt;Design&lt;/option&gt;
                &lt;option value="business"%s&gt;Business&lt;/option&gt;
                &lt;option value="other"%s&gt;Other&lt;/option&gt;
            &lt;/select&gt;
            &lt;button type="submit"&gt;Continue to Confirm&lt;/button&gt;
        &lt;/form&gt;
</span><span class="string">"</span><span class="punctuation">,</span>
        <span class="function-name">h</span><span class="punctuation">(</span>name<span class="punctuation">),</span> <span class="function-name">h</span><span class="punctuation">(</span>email<span class="punctuation">),</span>
        interest == <span class="string">"coding"</span> <span class="punctuation">?</span> <span class="string">" selected"</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span>
        interest == <span class="string">"design"</span> <span class="punctuation">?</span> <span class="string">" selected"</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span>
        interest == <span class="string">"business"</span> <span class="punctuation">?</span> <span class="string">" selected"</span> <span class="punctuation">:</span> <span class="string">""</span><span class="punctuation">,</span>
        interest == <span class="string">"other"</span> <span class="punctuation">?</span> <span class="string">" selected"</span> <span class="punctuation">:</span> <span class="string">""</span>
    <span class="punctuation">)</span> <span class="punctuation">+</span> <span class="function-name">render_footer</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Screen: Confirm</span>
<span class="type">string</span> screen_confirm<span class="punctuation">(</span><span class="type">AppState</span> state<span class="punctuation">,</span> <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">// </span><span class="comment">Save form data to state</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>form<span class="punctuation">[</span><span class="string">"name"</span><span class="punctuation">])</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">set_data</span><span class="punctuation">(</span><span class="string">"name"</span><span class="punctuation">,</span> form<span class="punctuation">[</span><span class="string">"name"</span><span class="punctuation">]);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>form<span class="punctuation">[</span><span class="string">"email"</span><span class="punctuation">])</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">set_data</span><span class="punctuation">(</span><span class="string">"email"</span><span class="punctuation">,</span> form<span class="punctuation">[</span><span class="string">"email"</span><span class="punctuation">]);</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>form<span class="punctuation">[</span><span class="string">"interest"</span><span class="punctuation">])</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">set_data</span><span class="punctuation">(</span><span class="string">"interest"</span><span class="punctuation">,</span> form<span class="punctuation">[</span><span class="string">"interest"</span><span class="punctuation">]);</span>

    <span class="type">string</span> name <span class="punctuation">=</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get_data</span><span class="punctuation">(</span><span class="string">"name"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="type">string</span> email <span class="punctuation">=</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get_data</span><span class="punctuation">(</span><span class="string">"email"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="type">string</span> interest <span class="punctuation">=</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get_data</span><span class="punctuation">(</span><span class="string">"interest"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">""</span><span class="punctuation">;</span>

    <span class="type">string</span> interest_label <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"coding"</span><span class="punctuation">:</span> <span class="string">"Programming"</span><span class="punctuation">,</span>
        <span class="string">"design"</span><span class="punctuation">:</span> <span class="string">"Design"</span><span class="punctuation">,</span>
        <span class="string">"business"</span><span class="punctuation">:</span> <span class="string">"Business"</span><span class="punctuation">,</span>
        <span class="string">"other"</span><span class="punctuation">:</span> <span class="string">"Other"</span>
    <span class="punctuation">])[</span>interest<span class="punctuation">]</span> <span class="punctuation">||</span> interest<span class="punctuation">;</span>

    <span class="keyword">return</span> <span class="function-name">render_header</span><span class="punctuation">(</span>state<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
        &lt;h1&gt;Confirm Your Information&lt;/h1&gt;
        &lt;p&gt;Please review the information below before submitting:&lt;/p&gt;
        &lt;table style="width:100%%; border-collapse:collapse;"&gt;
            &lt;tr&gt;&lt;td style="padding:10px; border-bottom:1px solid #ddd;"&gt;&lt;strong&gt;Name:&lt;/strong&gt;&lt;/td&gt;&lt;td style="padding:10px; border-bottom:1px solid #ddd;"&gt;%s&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td style="padding:10px; border-bottom:1px solid #ddd;"&gt;&lt;strong&gt;Email:&lt;/strong&gt;&lt;/td&gt;&lt;td style="padding:10px; border-bottom:1px solid #ddd;"&gt;%s&lt;/td&gt;&lt;/tr&gt;
            &lt;tr&gt;&lt;td style="padding:10px; border-bottom:1px solid #ddd;"&gt;&lt;strong&gt;Interest:&lt;/strong&gt;&lt;/td&gt;&lt;td style="padding:10px; border-bottom:1px solid #ddd;"&gt;%s&lt;/td&gt;&lt;/tr&gt;
        &lt;/table&gt;
        &lt;form method="POST" action="?screen=result"&gt;
            &lt;button type="submit" name="action" value="confirm"&gt;Confirm &amp; Submit&lt;/button&gt;
            &lt;a href="?screen=form"&gt;&lt;button type="button"&gt;Go Back&lt;/button&gt;&lt;/a&gt;
        &lt;/form&gt;
</span><span class="string">"</span><span class="punctuation">,</span>
        <span class="function-name">h</span><span class="punctuation">(</span>name<span class="punctuation">),</span> <span class="function-name">h</span><span class="punctuation">(</span>email<span class="punctuation">),</span> <span class="function-name">h</span><span class="punctuation">(</span>interest_label<span class="punctuation">)</span>
    <span class="punctuation">)</span> <span class="punctuation">+</span> <span class="function-name">render_footer</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Screen: Result</span>
<span class="type">string</span> screen_result<span class="punctuation">(</span><span class="type">AppState</span> state<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">string</span> name <span class="punctuation">=</span> state<span class="punctuation">-</span><span class="punctuation">&gt;</span><span class="function-name">get_data</span><span class="punctuation">(</span><span class="string">"name"</span><span class="punctuation">)</span> <span class="punctuation">||</span> <span class="string">"Guest"</span><span class="punctuation">;</span>
    <span class="type">string</span> ref_num <span class="punctuation">=</span> <span class="string">"REF-"</span> <span class="punctuation">+</span> <span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">string2hex</span><span class="punctuation">(</span><span class="function-name">Crypto</span><span class="punctuation">.</span><span class="function-name">Random</span><span class="punctuation">.</span><span class="function-name">random_string</span><span class="punctuation">(</span><span class="number">4</span><span class="punctuation">))[</span><span class="number">0.</span><span class="punctuation">.</span><span class="number">7</span><span class="punctuation">];</span>

    <span class="keyword">return</span> <span class="function-name">render_header</span><span class="punctuation">(</span>state<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">#&lt;!"</span><span class="punctuation">[</span>DOCTYPE html<span class="punctuation">]</span><span class="string">&gt;
        &lt;h1&gt;Thank You!&lt;/h1&gt;
        &lt;div style="background: #e8f5e9; padding: 20px; border-radius: 8px; text-align: center;"&gt;
            &lt;h2 style="color: #2e7d32; margin-top: 0;"&gt;Submission Successful&lt;/h2&gt;
            &lt;p&gt;Your information has been recorded.&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Name:&lt;/strong&gt; %s&lt;/p&gt;
            &lt;p&gt;&lt;strong&gt;Reference Number:&lt;/strong&gt; &lt;code&gt;%s&lt;/code&gt;&lt;/p&gt;
            &lt;p&gt;We've sent a confirmation email to your address.&lt;/p&gt;
        &lt;/div&gt;
        &lt;p&gt;&lt;a href="?screen=home"&gt;&lt;button&gt;Return Home&lt;/button&gt;&lt;/a&gt;&lt;/p&gt;
</span><span class="string">"</span><span class="punctuation">,</span>
        <span class="function-name">h</span><span class="punctuation">(</span>name<span class="punctuation">),</span> ref_num
    <span class="punctuation">)</span> <span class="punctuation">+</span> <span class="function-name">render_footer</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">// </span><span class="comment">Main application router</span>
<span class="type">void</span> main<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> form <span class="punctuation">=</span> <span class="function-name">parse_form</span><span class="punctuation">();</span>
    <span class="type">string</span> screen <span class="punctuation">=</span> form<span class="punctuation">[</span><span class="string">"screen"</span><span class="punctuation">]</span> <span class="punctuation">||</span> <span class="string">"home"</span><span class="punctuation">;</span>

    <span class="comment-delimiter">// </span><span class="comment">Valid screens</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> valid_screens <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">{</span><span class="string">"home"</span><span class="punctuation">,</span> <span class="string">"form"</span><span class="punctuation">,</span> <span class="string">"confirm"</span><span class="punctuation">,</span> <span class="string">"result"</span><span class="punctuation">});</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">search</span><span class="punctuation">(</span>valid_screens<span class="punctuation">,</span> screen<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="punctuation">-</span><span class="number">1</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        screen <span class="punctuation">=</span> <span class="string">"home"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Create application state</span>
    <span class="type">AppState</span> state <span class="punctuation">=</span> <span class="function-name">AppState</span><span class="punctuation">(</span>screen<span class="punctuation">);</span>

    <span class="comment-delimiter">// </span><span class="comment">Route to appropriate screen</span>
    <span class="type">string</span> output<span class="punctuation">;</span>
    <span class="keyword">switch</span> <span class="punctuation">(</span>screen<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">case</span> <span class="string">"home"</span><span class="punctuation">:</span>
            output <span class="punctuation">=</span> <span class="function-name">screen_home</span><span class="punctuation">(</span>state<span class="punctuation">);</span>
            <span class="keyword">break</span><span class="punctuation">;</span>
        <span class="keyword">case</span> <span class="string">"form"</span><span class="punctuation">:</span>
            output <span class="punctuation">=</span> <span class="function-name">screen_form</span><span class="punctuation">(</span>state<span class="punctuation">,</span> form<span class="punctuation">);</span>
            <span class="keyword">break</span><span class="punctuation">;</span>
        <span class="keyword">case</span> <span class="string">"confirm"</span><span class="punctuation">:</span>
            output <span class="punctuation">=</span> <span class="function-name">screen_confirm</span><span class="punctuation">(</span>state<span class="punctuation">,</span> form<span class="punctuation">);</span>
            <span class="keyword">break</span><span class="punctuation">;</span>
        <span class="keyword">case</span> <span class="string">"result"</span><span class="punctuation">:</span>
            output <span class="punctuation">=</span> <span class="function-name">screen_result</span><span class="punctuation">(</span>state<span class="punctuation">);</span>
            <span class="keyword">break</span><span class="punctuation">;</span>
        <span class="keyword">default</span><span class="punctuation">:</span>
            output <span class="punctuation">=</span> <span class="function-name">screen_home</span><span class="punctuation">(</span>state<span class="punctuation">);</span>
            <span class="keyword">break</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>

    <span class="comment-delimiter">// </span><span class="comment">Send response</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Content-Type: text/html; charset=utf-8\r\n\r\n"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span>output<span class="punctuation">);</span>
<span class="punctuation">}</span>
</PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1046"
>Saving a Form to a File or Mail Pipe</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1049"
>Program: chemiserie</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="internetservices.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="webautomation.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Internet Services</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>Web Automation</TD
></TR
></TABLE
></DIV
></BODY
></HTML
>