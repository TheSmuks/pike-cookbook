<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN" "http://www.w3.org/TR/html4/loose.dtd">
<HTML
><HEAD
><TITLE
>Internet Services</TITLE
><META
NAME="GENERATOR"
CONTENT="Pike 8 Cookbook"><LINK
REL="HOME"
TITLE="PLEAC-Pike
"
HREF="index.html"><LINK
REL="PREVIOUS"
TITLE="Sockets"
HREF="sockets.html"><LINK
REL="NEXT"
TITLE="CGI Programming"
HREF="cgiprogramming.html"><style type="text/css">    <!--
      .comment {
        /* font-lock-comment-face */
        color: #bebebe;
      }
      .comment-delimiter {
      }
      .constant {
        /* font-lock-constant-face */
        color: #ff7f50;
      }
      .function-name {
        /* font-lock-function-name-face */
        color: #b2dfee;
      }
      .keyword {
        /* font-lock-keyword-face */
        color: #ffa500;
      }
      .number {
        /* font-lock-number-face */
        color: #cdcd00;
      }
      .punctuation {
        /* font-lock-punctuation-face */
        color: #00ffff;
      }
      .string {
        /* font-lock-string-face */
        color: #00cd00;
      }
      .type {
        /* font-lock-type-face */
        color: #98fb98;
      }
      .variable-name {
        /* font-lock-variable-name-face */
        color: #9ac0cd;
      }
    -->
    </style></head
><BODY TEXT="#cecece" BGCOLOR="#4f6f6f" LINK="#f5deb3" VLINK="#d5ae83"
CLASS="SECT1"
BGCOLOR="#FFFFFF"
TEXT="#000000"
LINK="#0000FF"
VLINK="#840084"
ALINK="#0000FF"
><DIV
CLASS="NAVHEADER"
><TABLE
SUMMARY="Header navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TH
COLSPAN="3"
ALIGN="center"
>PLEAC-Pike
</TH
></TR
><TR
><TD
WIDTH="10%"
ALIGN="left"
VALIGN="bottom"
><A
HREF="sockets.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="80%"
ALIGN="center"
VALIGN="bottom"
></TD
><TD
WIDTH="10%"
ALIGN="right"
VALIGN="bottom"
><A
HREF="cgiprogramming.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
></TABLE
><HR
ALIGN="LEFT"
WIDTH="100%"></DIV
><DIV
CLASS="SECT1"
><H1
CLASS="SECT1"
><A
NAME="INTERNETSERVICES"
>18. Internet Services</A
></H1
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN978"
>Simple DNS Lookups</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.1: DNS Lookups with Protocols.DNS - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">DNS</span><span class="punctuation">;</span>
<span class="keyword">import</span> <span class="module">Standards</span><span class="punctuation">.</span><span class="module">DNS</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> Basic A record lookup (hostname to IP)</span>
<span class="keyword">async</span> <span class="type">void</span> lookup_a<span class="punctuation">(</span><span class="type">string</span> hostname<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">DNS</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> ips <span class="punctuation">=</span> <span class="punctuation">[array]</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">getaddrbyname</span><span class="punctuation">(</span>hostname<span class="punctuation">));</span>
    
    <span class="keyword">foreach</span><span class="punctuation">(</span>ips<span class="punctuation">;</span> <span class="type">string</span> ip<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"%s -&gt; %s\n"</span><span class="punctuation">,</span> hostname<span class="punctuation">,</span> ip<span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Reverse DNS lookup (IP to hostname)</span>
<span class="keyword">async</span> <span class="type">void</span> lookup_ptr<span class="punctuation">(</span><span class="type">string</span> ip<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">DNS</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="type">string</span> hostname <span class="punctuation">=</span> <span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">getnamebyaddr</span><span class="punctuation">(</span>ip<span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"%s -&gt; %s\n"</span><span class="punctuation">,</span> ip<span class="punctuation">,</span> hostname<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> MX record lookup (mail servers)</span>
<span class="keyword">async</span> <span class="type">void</span> lookup_mx<span class="punctuation">(</span><span class="type">string</span> domain<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">DNS</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span> result <span class="punctuation">=</span> <span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">lookup</span><span class="punctuation">(</span>
        domain<span class="punctuation">,</span> <span class="constant">Protocol</span><span class="punctuation">.</span><span class="constant">DNS</span><span class="punctuation">.</span><span class="constant">MX</span>
    <span class="punctuation">);</span>
    
    <span class="keyword">if</span><span class="punctuation">(</span>result<span class="punctuation">-&gt;</span>rcode <span class="punctuation">==</span> <span class="constant">Protocol</span><span class="punctuation">.</span><span class="constant">DNS</span><span class="punctuation">.</span><span class="constant">NOERROR</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"MX records for %s:\n"</span><span class="punctuation">,</span> domain<span class="punctuation">);</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>result<span class="punctuation">-&gt;</span>an<span class="punctuation">;</span> <span class="type">mapping</span> rr<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="keyword">if</span><span class="punctuation">(</span>rr<span class="punctuation">-&gt;</span>type <span class="punctuation">==</span> <span class="constant">Protocol</span><span class="punctuation">.</span><span class="constant">DNS</span><span class="punctuation">.</span><span class="constant">MX</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  Priority %d: %s\n"</span><span class="punctuation">,</span> rr<span class="punctuation">-&gt;</span>preference<span class="punctuation">,</span> rr<span class="punctuation">-&gt;</span>exchange<span class="punctuation">);</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> TXT record lookup (DKIM, SPF, verification records)</span>
<span class="keyword">async</span> <span class="type">void</span> lookup_txt<span class="punctuation">(</span><span class="type">string</span> domain<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">DNS</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span> result <span class="punctuation">=</span> <span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">lookup</span><span class="punctuation">(</span>
        domain<span class="punctuation">,</span> <span class="constant">Protocol</span><span class="punctuation">.</span><span class="constant">DNS</span><span class="punctuation">.</span><span class="constant">TXT</span>
    <span class="punctuation">);</span>
    
    <span class="keyword">if</span><span class="punctuation">(</span>result<span class="punctuation">-&gt;</span>rcode <span class="punctuation">==</span> <span class="constant">Protocol</span><span class="punctuation">.</span><span class="constant">DNS</span><span class="punctuation">.</span><span class="constant">NOERROR</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"TXT records for %s:\n"</span><span class="punctuation">,</span> domain<span class="punctuation">);</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>result<span class="punctuation">-&gt;</span>an<span class="punctuation">;</span> <span class="type">mapping</span> rr<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="keyword">if</span><span class="punctuation">(</span>rr<span class="punctuation">-&gt;</span>type <span class="punctuation">==</span> <span class="constant">Protocol</span><span class="punctuation">.</span><span class="constant">DNS</span><span class="punctuation">.</span><span class="constant">TXT</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  %s\n"</span><span class="punctuation">,</span> rr<span class="punctuation">-&gt;</span>txt<span class="punctuation">);</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> AAAA record lookup (IPv6 addresses)</span>
<span class="keyword">async</span> <span class="type">void</span> lookup_aaaa<span class="punctuation">(</span><span class="type">string</span> hostname<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">DNS</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span> result <span class="punctuation">=</span> <span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">lookup</span><span class="punctuation">(</span>
        hostname<span class="punctuation">,</span> <span class="constant">Protocol</span><span class="punctuation">.</span><span class="constant">DNS</span><span class="punctuation">.</span><span class="constant">AAAA</span>
    <span class="punctuation">);</span>
    
    <span class="keyword">if</span><span class="punctuation">(</span>result<span class="punctuation">-&gt;</span>rcode <span class="punctuation">==</span> <span class="constant">Protocol</span><span class="punctuation">.</span><span class="constant">DNS</span><span class="punctuation">.</span><span class="constant">NOERROR</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"IPv6 addresses for %s:\n"</span><span class="punctuation">,</span> hostname<span class="punctuation">);</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>result<span class="punctuation">-&gt;</span>an<span class="punctuation">;</span> <span class="type">mapping</span> rr<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="keyword">if</span><span class="punctuation">(</span>rr<span class="punctuation">-&gt;</span>type <span class="punctuation">==</span> <span class="constant">Protocol</span><span class="punctuation">.</span><span class="constant">DNS</span><span class="punctuation">.</span><span class="constant">AAAA</span><span class="punctuation">)</span> <span class="punctuation">{</span>
                <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  %s\n"</span><span class="punctuation">,</span> rr<span class="punctuation">-&gt;</span>ipv6<span class="punctuation">);</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Async DNS queries with Future</span>
<span class="keyword">async</span> <span class="type">void</span> async_lookup<span class="punctuation">(</span><span class="type">string</span> hostname<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">DNS</span><span class="punctuation">.</span><span class="function-name">async_client</span><span class="punctuation">();</span>
    <span class="type">Future</span><span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">))</span> future <span class="punctuation">=</span> <span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">getaddrbyname</span><span class="punctuation">(</span>hostname<span class="punctuation">);</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> ips <span class="punctuation">=</span> <span class="keyword">await</span> future<span class="punctuation">;</span>
    
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Resolved %s: %s\n"</span><span class="punctuation">,</span> hostname<span class="punctuation">,</span> ips<span class="punctuation">*</span><span class="string">", "</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Concurrent lookups</span>
<span class="keyword">async</span> <span class="type">void</span> concurrent_lookups<span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> hostnames<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">Future</span><span class="punctuation">)</span> futures <span class="punctuation">=</span> <span class="function-name">map</span><span class="punctuation">(</span>hostnames<span class="punctuation">,</span> <span class="keyword">lambda</span><span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">DNS</span><span class="punctuation">.</span><span class="function-name">async_client</span><span class="punctuation">();</span>
        <span class="keyword">return</span> <span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">getaddrbyname</span><span class="punctuation">(</span>host<span class="punctuation">);</span>
    <span class="punctuation">});</span>
    
    <span class="type">array</span><span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">))</span> results <span class="punctuation">=</span> <span class="keyword">await</span> <span class="function-name">Future</span><span class="punctuation">.</span><span class="function-name">all</span><span class="punctuation">(</span>futures<span class="punctuation">);</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>results<span class="punctuation">;</span> <span class="type">int</span> i<span class="punctuation">;</span> <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> ips<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"%s -&gt; %s\n"</span><span class="punctuation">,</span> hostnames<span class="punctuation">[</span>i<span class="punctuation">],</span> ips<span class="punctuation">*</span><span class="string">", "</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN981"
>Being an FTP Client</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.2: FTP Operations with Protocols.FTP - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">FTP</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> Basic FTP connection and file download</span>
<span class="keyword">async</span> <span class="type">void</span> ftp_download<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">,</span> 
                          <span class="type">string</span> remote_file<span class="punctuation">,</span> <span class="type">string</span> local_path<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> ftp <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">FTP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Connect and authenticate</span>
    <span class="type">int</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">));</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>result <span class="punctuation">!=</span> <span class="number">220</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">werror</span><span class="punctuation">(</span><span class="string">"FTP connection failed: %d\n"</span><span class="punctuation">,</span> result<span class="punctuation">);</span>
        <span class="keyword">return</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
    
    result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">login</span><span class="punctuation">(</span>user<span class="punctuation">,</span> pass<span class="punctuation">));</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>result <span class="punctuation">!=</span> <span class="number">230</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">werror</span><span class="punctuation">(</span><span class="string">"FTP login failed: %d\n"</span><span class="punctuation">,</span> result<span class="punctuation">);</span>
        <span class="keyword">return</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Download file</span>
    <span class="type">string</span> data <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">get</span><span class="punctuation">(</span>remote_file<span class="punctuation">));</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">object</span> f <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">(</span>local_path<span class="punctuation">,</span> <span class="string">"wct"</span><span class="punctuation">);</span>
        <span class="function-name">f</span><span class="punctuation">-></span><span class="function-name">write</span><span class="punctuation">(</span>data<span class="punctuation">);</span>
        <span class="function-name">f</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Downloaded %s to %s\n"</span><span class="punctuation">,</span> remote_file<span class="punctuation">,</span> local_path<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Upload file to FTP server</span>
<span class="keyword">async</span> <span class="type">void</span> ftp_upload<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">,</span>
                        <span class="type">string</span> local_file<span class="punctuation">,</span> <span class="type">string</span> remote_path<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> ftp <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">FTP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">login</span><span class="punctuation">(</span>user<span class="punctuation">,</span> pass<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Read local file</span>
    <span class="type">string</span> data <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">read_file</span><span class="punctuation">(</span>local_file<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Upload to server</span>
    <span class="type">int</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">put</span><span class="punctuation">(</span>remote_path<span class="punctuation">,</span> data<span class="punctuation">));</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>result <span class="punctuation">==</span> <span class="number">226</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Uploaded %s to %s\n"</span><span class="punctuation">,</span> local_file<span class="punctuation">,</span> remote_path<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> List directory contents</span>
<span class="keyword">async</span> <span class="type">void</span> ftp_listdir<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">,</span>
                         <span class="type">string</span> remote_dir<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> ftp <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">FTP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">login</span><span class="punctuation">(</span>user<span class="punctuation">,</span> pass<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Change to directory</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">cwd</span><span class="punctuation">(</span>remote_dir<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Get file listing</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">mapping</span><span class="punctuation">)</span> files <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">list</span><span class="punctuation">());</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Directory listing for %s:\n"</span><span class="punctuation">,</span> remote_dir<span class="punctuation">);</span>
    
    <span class="keyword">foreach</span><span class="punctuation">(</span>files<span class="punctuation">;</span> <span class="type">mapping</span> file<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> type <span class="punctuation">=</span> file<span class="punctuation">-&gt;</span>isdirectory <span class="punctuation">?</span> <span class="string">"DIR "</span> <span class="punctuation">:</span> <span class="string">"FILE"</span><span class="punctuation">;</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  [%s] %s (%d bytes)\n"</span><span class="punctuation">,</span> 
                 type<span class="punctuation">,</span> file<span class="punctuation">-&gt;</span>name<span class="punctuation">,</span> file<span class="punctuation">-&gt;</span>size<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Delete file on FTP server</span>
<span class="keyword">async</span> <span class="type">void</span> ftp_delete<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">,</span>
                         <span class="type">string</span> remote_file<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> ftp <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">FTP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">login</span><span class="punctuation">(</span>user<span class="punctuation">,</span> pass<span class="punctuation">));</span>
    
    <span class="type">int</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">delete</span><span class="punctuation">(</span>remote_file<span class="punctuation">));</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>result <span class="punctuation">==</span> <span class="number">250</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Deleted %s\n"</span><span class="punctuation">,</span> remote_file<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Create directory on FTP server</span>
<span class="keyword">async</span> <span class="type">void</span>ftp_mkdir<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">,</span>
                       <span class="type">string</span> remote_dir<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> ftp <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">FTP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">login</span><span class="punctuation">(</span>user<span class="punctuation">,</span> pass<span class="punctuation">));</span>
    
    <span class="type">int</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">mkdir</span><span class="punctuation">(</span>remote_dir<span class="punctuation">));</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>result <span class="punctuation">==</span> <span class="number">257</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Created directory %s\n"</span><span class="punctuation">,</span> remote_dir<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> FTP with SSL/TLS (FTPS)</span>
<span class="keyword">async</span> <span class="type">void</span> ftps_download<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">,</span>
                           <span class="type">string</span> remote_file<span class="punctuation">,</span> <span class="type">string</span> local_path<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> context <span class="punctuation">=</span> <span class="function-name">SSL</span><span class="punctuation">.</span><span class="function-name">Context</span><span class="punctuation">();</span>
    <span class="type">object</span> ftp <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">FTP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Enable SSL/TLS</span>
    <span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">set_ssl_context</span><span class="punctuation">(</span>context<span class="punctuation">);</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">,</span> <span class="number">21</span><span class="punctuation">,</span> <span class="number">1</span><span class="punctuation">));</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">login</span><span class="punctuation">(</span>user<span class="punctuation">,</span> pass<span class="punctuation">));</span>
    <span class="type">string</span> data <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">get</span><span class="punctuation">(</span>remote_file<span class="punctuation">));</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">write_file</span><span class="punctuation">(</span>local_path<span class="punctuation">,</span> data<span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Downloaded via FTPS: %s\n"</span><span class="punctuation">,</span> local_path<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="function-name">ftp</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN984"
>Sending Mail</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.3: Sending Email with SMTP - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">SMTP</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> Basic email sending</span>
<span class="keyword">async</span> <span class="type">void</span> send_email<span class="punctuation">(</span><span class="type">string</span> to<span class="punctuation">,</span> <span class="type">string</span> from<span class="punctuation">,</span> 
                    <span class="type">string</span> subject<span class="punctuation">,</span> <span class="type">string</span> body<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> msg <span class="punctuation">=</span> <span class="function-name">MIME</span><span class="punctuation">.</span><span class="function-name">Message</span><span class="punctuation">();</span>
    <span class="function-name">msg</span><span class="punctuation">-></span><span class="function-name">set_data</span><span class="punctuation">(</span>body<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set headers</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"to"</span><span class="punctuation">]</span> <span class="punctuation">=</span> to<span class="punctuation">;</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"from"</span><span class="punctuation">]</span> <span class="punctuation">=</span> from<span class="punctuation">;</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"subject"</span><span class="punctuation">]</span> <span class="punctuation">=</span> subject<span class="punctuation">;</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"date"</span><span class="punctuation">]</span> <span class="punctuation">=</span> <span class="function-name">Calendar</span><span class="punctuation">.</span><span class="function-name">now</span><span class="punctuation">()-></span><span class="function-name">format_time</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send via localhost SMTP</span>
    <span class="keyword">mixed</span> err <span class="punctuation">=</span> <span class="keyword">catch</span> <span class="punctuation">{</span>
        <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">SMTP</span><span class="punctuation">.</span><span class="function-name">send_msg</span><span class="punctuation">(</span>msg<span class="punctuation">,</span> <span class="string">"localhost"</span><span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Email sent to %s\n"</span><span class="punctuation">,</span> to<span class="punctuation">);</span>
    <span class="punctuation">};</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span>err<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">werror</span><span class="punctuation">(</span><span class="string">"Failed to send email: %s\n"</span><span class="punctuation">,</span> <span class="function-name">describe_error</span><span class="punctuation">(</span>err<span class="punctuation">));</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> SMTP with authentication</span>
<span class="keyword">async</span> <span class="type">void</span> send_email_auth<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">int</span> port<span class="punctuation">,</span>
                           <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">,</span>
                           <span class="type">string</span> to<span class="punctuation">,</span> <span class="type">string</span> from<span class="punctuation">,</span>
                           <span class="type">string</span> subject<span class="punctuation">,</span> <span class="type">string</span> body<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> msg <span class="punctuation">=</span> <span class="function-name">MIME</span><span class="punctuation">.</span><span class="function-name">Message</span><span class="punctuation">();</span>
    <span class="function-name">msg</span><span class="punctuation">-></span><span class="function-name">set_data</span><span class="punctuation">(</span>body<span class="punctuation">);</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"to"</span><span class="punctuation">]</span> <span class="punctuation">=</span> to<span class="punctuation">;</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"from"</span><span class="punctuation">]</span> <span class="punctuation">=</span> from<span class="punctuation">;</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"subject"</span><span class="punctuation">]</span> <span class="punctuation">=</span> subject<span class="punctuation">;</span>
    
    <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">SMTP</span><span class="punctuation">.</span><span class="function-name">Client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">,</span> port<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> EHLO</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">ehlo</span><span class="punctuation">());</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> STARTTLS if available</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">has_starttls</span><span class="punctuation">())</span> <span class="punctuation">{</span>
        <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">starttls</span><span class="punctuation">());</span>
    <span class="punctuation">}</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Authenticate</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">authenticate</span><span class="punctuation">(</span>user<span class="punctuation">,</span> pass<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send email</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">send_message</span><span class="punctuation">(</span>msg<span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">quit</span><span class="punctuation">());</span>
    
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Email sent with authentication\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Send HTML email</span>
<span class="keyword">async</span> <span class="type">void</span> send_html_email<span class="punctuation">(</span><span class="type">string</span> to<span class="punctuation">,</span> <span class="type">string</span> from<span class="punctuation">,</span>
                           <span class="type">string</span> subject<span class="punctuation">,</span> <span class="type">string</span> html_body<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> msg <span class="punctuation">=</span> <span class="function-name">MIME</span><span class="punctuation">.</span><span class="function-name">Message</span><span class="punctuation">();</span>
    <span class="function-name">msg</span><span class="punctuation">-></span><span class="function-name">set_type</span><span class="punctuation">(</span><span class="string">"text/html"</span><span class="punctuation">);</span>
    <span class="function-name">msg</span><span class="punctuation">-></span><span class="function-name">set_data</span><span class="punctuation">(</span>html_body<span class="punctuation">);</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"to"</span><span class="punctuation">]</span> <span class="punctuation">=</span> to<span class="punctuation">;</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"from"</span><span class="punctuation">]</span> <span class="punctuation">=</span> from<span class="punctuation">;</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"subject"</span><span class="punctuation">]</span> <span class="punctuation">=</span> subject<span class="punctuation">;</span>
    
    <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">SMTP</span><span class="punctuation">.</span><span class="function-name">send_msg</span><span class="punctuation">(</span>msg<span class="punctuation">,</span> <span class="string">"localhost"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"HTML email sent\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Send email with attachments</span>
<span class="keyword">async</span> <span class="type">void</span> send_email_attachment<span class="punctuation">(</span><span class="type">string</span> to<span class="punctuation">,</span> <span class="type">string</span> from<span class="punctuation">,</span>
                                  <span class="type">string</span> subject<span class="punctuation">,</span> <span class="type">string</span> body<span class="punctuation">,</span>
                                  <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> attachments<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">//</span><span class="comment"> Create multipart message</span>
    <span class="type">object</span> msg <span class="punctuation">=</span> <span class="function-name">MIME</span><span class="punctuation">.</span><span class="function-name">Message</span><span class="punctuation">();</span>
    <span class="function-name">msg</span><span class="punctuation">-></span><span class="function-name">set_type</span><span class="punctuation">(</span><span class="string">"multipart/mixed"</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Add text body</span>
    <span class="type">object</span> text_part <span class="punctuation">=</span> <span class="function-name">MIME</span><span class="punctuation">.</span><span class="function-name">Message</span><span class="punctuation">();</span>
    <span class="function-name">text_part</span><span class="punctuation">-></span><span class="function-name">set_type</span><span class="punctuation">(</span><span class="string">"text/plain"</span><span class="punctuation">);</span>
    <span class="function-name">text_part</span><span class="punctuation">-></span><span class="function-name">set_data</span><span class="punctuation">(</span>body<span class="punctuation">);</span>
    <span class="function-name">msg</span><span class="punctuation">-></span><span class="function-name">add_part</span><span class="punctuation">(</span>text_part<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Add attachments</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>attachments<span class="punctuation">;</span> <span class="type">string</span> filepath<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> data <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">read_file</span><span class="punctuation">(</span>filepath<span class="punctuation">);</span>
        <span class="type">string</span> filename <span class="punctuation">=</span> <span class="function-name">basename</span><span class="punctuation">(</span>filepath<span class="punctuation">);</span>
        
        <span class="type">object</span> attachment <span class="punctuation">=</span> <span class="function-name">MIME</span><span class="punctuation">.</span><span class="function-name">Message</span><span class="punctuation">();</span>
        <span class="function-name">attachment</span><span class="punctuation">-></span><span class="function-name">set_type</span><span class="punctuation">(</span><span class="string">"application/octet-stream"</span><span class="punctuation">);</span>
        <span class="function-name">attachment</span><span class="punctuation">-></span><span class="function-name">set_data</span><span class="punctuation">(</span>data<span class="punctuation">);</span>
        <span class="function-name">attachment</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"content-disposition"</span><span class="punctuation">]</span> <span class="punctuation">=</span> 
            <span class="function-name">sprintf</span><span class="punctuation">(</span><span class="string">"attachment; filename=\"%s\""</span><span class="punctuation">,</span> filename<span class="punctuation">);</span>
        <span class="function-name">attachment</span><span class="punctuation">-></span><span class="function-name">set_encoding</span><span class="punctuation">(</span><span class="string">"base64"</span><span class="punctuation">);</span>
        
        <span class="function-name">msg</span><span class="punctuation">-></span><span class="function-name">add_part</span><span class="punctuation">(</span>attachment<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set headers</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"to"</span><span class="punctuation">]</span> <span class="punctuation">=</span> to<span class="punctuation">;</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"from"</span><span class="punctuation">]</span> <span class="punctuation">=</span> from<span class="punctuation">;</span>
    <span class="function-name">msg</span><span class="punctuation">-&gt;</span><span class="punctuation">[</span><span class="string">"subject"</span><span class="punctuation">]</span> <span class="punctuation">=</span> subject<span class="punctuation">;</span>
    
    <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">SMTP</span><span class="punctuation">.</span><span class="function-name">send_msg</span><span class="punctuation">(</span>msg<span class="punctuation">,</span> <span class="string">"localhost"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Email with attachments sent\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Reading Mail with POP3</span>
<span class="keyword">async</span> <span class="type">void</span> read_pop3<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">POP3</span><span class="punctuation">;</span>
    
    <span class="type">object</span> pop3 <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">POP3</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">(</span>host<span class="punctuation">,</span> <span class="number">110</span><span class="punctuation">);</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">pop3</span><span class="punctuation">-></span><span class="function-name">login</span><span class="punctuation">(</span>user<span class="punctuation">,</span> pass<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Get message count</span>
    <span class="type">int</span> count <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">pop3</span><span class="punctuation">-></span><span class="function-name">get_msg_count</span><span class="punctuation">());</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Messages: %d\n"</span><span class="punctuation">,</span> count<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Fetch messages</span>
    <span class="keyword">for</span> <span class="punctuation">(</span><span class="type">int</span> i <span class="punctuation">=</span> <span class="number">1</span><span class="punctuation">;</span> i <span class="punctuation">&lt;=</span> count<span class="punctuation">;</span> i<span class="punctuation">++)</span> <span class="punctuation">{</span>
        <span class="type">mapping</span> msg <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">pop3</span><span class="punctuation">-></span><span class="function-name">get_message</span><span class="punctuation">(</span>i<span class="punctuation">));</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"From: %s\nSubject: %s\n%s\n"</span><span class="punctuation">,</span>
                 msg<span class="punctuation">-&gt;</span>from<span class="punctuation">,</span> msg<span class="punctuation">-&gt;</span>subject<span class="punctuation">,</span> msg<span class="punctuation">-&gt;</span>body<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">pop3</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Reading Mail with IMAP</span>
<span class="keyword">async</span> <span class="type">void</span> read_imap<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">IMAP</span><span class="punctuation">;</span>
    
    <span class="type">object</span> imap <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">IMAP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">(</span>host<span class="punctuation">,</span> <span class="number">143</span><span class="punctuation">);</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">imap</span><span class="punctuation">-></span><span class="function-name">login</span><span class="punctuation">(</span>user<span class="punctuation">,</span> pass<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Select INBOX</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">imap</span><span class="punctuation">-></span><span class="function-name">select_mailbox</span><span class="punctuation">(</span><span class="string">"INBOX"</span><span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Search for unread messages</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">int</span><span class="punctuation">)</span> uids <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">imap</span><span class="punctuation">-></span><span class="function-name">search</span><span class="punctuation">(</span><span class="string">"UNSEEN"</span><span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Unread messages: %d\n"</span><span class="punctuation">,</span> <span class="keyword">sizeof</span><span class="punctuation">(</span>uids<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Fetch messages</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>uids<span class="punctuation">;</span> <span class="type">int</span> uid<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">mapping</span> msg <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">imap</span><span class="punctuation">-></span><span class="function-name">fetch</span><span class="punctuation">(</span>uid<span class="punctuation">,</span> <span class="string">"(BODY[])"</span><span class="punctuation">));</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Message UID %d: %s\n"</span><span class="punctuation">,</span> uid<span class="punctuation">,</span> msg<span class="punctuation">-&gt;</span>subject<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">imap</span><span class="punctuation">-></span><span class="function-name">logout</span><span class="punctuation">());</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN987"
>Reading and Posting Usenet News Messages</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.4: Usenet News with NNTP - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">NNTP</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> Connect to NNTP server and list groups</span>
<span class="keyword">async</span> <span class="type">void</span> nntp_list_groups<span class="punctuation">(</span><span class="type">string</span> server<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> nntp <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">NNTP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>server<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Get list of newsgroups</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> groups <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">list</span><span class="punctuation">());</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Available groups: %d\n"</span><span class="punctuation">,</span> <span class="keyword">sizeof</span><span class="punctuation">(</span>groups<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Show first 20</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>groups<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">..</span><span class="number">19</span><span class="punctuation">];</span> <span class="type">string</span> group<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  %s\n"</span><span class="punctuation">,</span> group<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">quit</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Read articles from a newsgroup</span>
<span class="keyword">async</span> <span class="type">void</span> nntp_read_articles<span class="punctuation">(</span><span class="type">string</span> server<span class="punctuation">,</span> <span class="type">string</span> groupname<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> nntp <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">NNTP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>server<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Select group</span>
    <span class="type">mapping</span> info <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">group</span><span class="punctuation">(</span>groupname<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Group %s: %d articles\n"</span><span class="punctuation">,</span> 
             groupname<span class="punctuation">,</span> info<span class="punctuation">-&gt;</span>count<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Get article headers</span>
    <span class="type">int</span> first <span class="punctuation">=</span> info<span class="punctuation">-&gt;</span>first<span class="punctuation">;</span>
    <span class="type">int</span> last <span class="punctuation">=</span> info<span class="punctuation">-&gt;</span>last<span class="punctuation">;</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Fetch overview of recent articles</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">mapping</span><span class="punctuation">)</span> articles <span class="punctuation">=</span> 
        <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">xover</span><span class="punctuation">(</span>last<span class="punctuation">-</span><span class="number">9</span><span class="punctuation">,</span> last<span class="punctuation">));</span>
    
    <span class="keyword">foreach</span><span class="punctuation">(</span>articles<span class="punctuation">;</span> <span class="type">mapping</span> article<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"[%d] %s\n"</span><span class="punctuation">,</span> 
                 article<span class="punctuation">-&gt;</span>number<span class="punctuation">,</span> article<span class="punctuation">-&gt;</span>subject<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">quit</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Post article to newsgroup</span>
<span class="keyword">async</span> <span class="type">void</span> nntp_post_article<span class="punctuation">(</span><span class="type">string</span> server<span class="punctuation">,</span> <span class="type">string</span> groupname<span class="punctuation">,</span>
                             <span class="type">string</span> subject<span class="punctuation">,</span> <span class="type">string</span> from<span class="punctuation">,</span>
                             <span class="type">string</span> body<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> nntp <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">NNTP</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>server<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Switch to posting mode</span>
    <span class="type">int</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">mode_reader</span><span class="punctuation">());</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Post article</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> headers <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"Newsgroups"</span><span class="punctuation">:</span> groupname<span class="punctuation">,</span>
        <span class="string">"From"</span><span class="punctuation">:</span> from<span class="punctuation">,</span>
        <span class="string">"Subject"</span><span class="punctuation">:</span> subject<span class="punctuation">,</span>
    <span class="punctuation">]);</span>
    
    result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">post</span><span class="punctuation">(</span>headers<span class="punctuation">,</span> body<span class="punctuation">));</span>
    <span class="keyword">if</span> <span class="punctuation">(</span>result <span class="punctuation">==</span> <span class="number">240</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Article posted successfully\n"</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">nntp</span><span class="punctuation">-></span><span class="function-name">quit</span><span class="punctuation">());</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN990"
>Reading Mail with POP3</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.5: POP3 Email Client - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="comment-delimiter">//</span><span class="comment"> (See Reading Mail with POP3 example in "Sending Mail" section)</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN993"
>Simulating Telnet from a Program</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.6: Telnet Client with Protocols.TELNET - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">TELNET</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> Basic telnet connection</span>
<span class="keyword">async</span> <span class="type">void</span> telnet_connect<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">int</span> port<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> telnet <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">TELNET</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">,</span> port<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Connected to %s:%d\n"</span><span class="punctuation">,</span> host<span class="punctuation">,</span> port<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send command and read response</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">write</span><span class="punctuation">(</span><span class="string">"help\n"</span><span class="punctuation">));</span>
    <span class="type">string</span> response <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">read</span><span class="punctuation">());</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Response:\n%s\n"</span><span class="punctuation">,</span> response<span class="punctuation">);</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Interactive telnet session</span>
<span class="keyword">async</span> <span class="type">void</span> telnet_interactive<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">int</span> port<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> telnet <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">TELNET</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">,</span> port<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Handle telnet negotiations</span>
    <span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">set_will</span><span class="punctuation">(</span><span class="function-name">TELOPT_ECHO</span><span class="punctuation">);</span>
    <span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">set_wont</span><span class="punctuation">(</span><span class="function-name">TELOPT_LINEMODE</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send authentication if needed</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">write</span><span class="punctuation">(</span><span class="string">"user admin\n"</span><span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">write</span><span class="punctuation">(</span><span class="string">"pass secret\n"</span><span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Read welcome banner</span>
    <span class="type">string</span> banner <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">expect</span><span class="punctuation">(</span><span class="string">"."</span><span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Banner:\n%s\n"</span><span class="punctuation">,</span> banner<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send commands</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">write</span><span class="punctuation">(</span><span class="string">"show version\n"</span><span class="punctuation">));</span>
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">expect</span><span class="punctuation">(</span><span class="string">"#"</span><span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Version info:\n%s\n"</span><span class="punctuation">,</span> output<span class="punctuation">);</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">write</span><span class="punctuation">(</span><span class="string">"exit\n"</span><span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Telnet with option negotiation</span>
<span class="keyword">async</span> <span class="type">void</span> telnet_with_options<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">int</span> port<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> telnet <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">TELNET</span><span class="punctuation">.</span><span class="function-name">client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">,</span> port<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Negotiate terminal type</span>
    <span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">set_will</span><span class="punctuation">(</span><span class="function-name">TELOPT_TTYPE</span><span class="punctuation">);</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">send_ttype</span><span class="punctuation">(</span><span class="string">"VT100"</span><span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Negotiate window size</span>
    <span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">set_will</span><span class="punctuation">(</span><span class="function-name">TELOPT_NAWS</span><span class="punctuation">);</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">send_naws</span><span class="punctuation">(</span><span class="number">80</span><span class="punctuation">,</span> <span class="number">24</span><span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Now interact with the server</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">telnet</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">());</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN996"
>Pinging a Machine</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.7: ICMP Ping - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="comment-delimiter">//</span><span class="comment"> Using system ping command (most common approach)</span>
<span class="keyword">async</span> <span class="type">void</span> ping_host<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> proc <span class="punctuation">=</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">create_process</span><span class="punctuation">(</span>
        <span class="punctuation">({</span><span class="string">"ping"</span><span class="punctuation">,</span> <span class="string">"-c"</span><span class="punctuation">,</span> <span class="string">"4"</span><span class="punctuation">,</span> host<span class="punctuation">})</span>
    <span class="punctuation">);</span>
    
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">proc</span><span class="punctuation">-></span><span class="function-name">wait</span><span class="punctuation">());</span>
    <span class="keyword">int</span> status <span class="punctuation">=</span> <span class="function-name">proc</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">();</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span>status <span class="punctuation">==</span> <span class="number">0</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"%s is reachable\n"</span><span class="punctuation">,</span> host<span class="punctuation">);</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="function-name">werror</span><span class="punctuation">(</span><span class="string">"%s is unreachable\n"</span><span class="punctuation">,</span> host<span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Parse ping statistics</span>
<span class="keyword">async</span> <span class="type">void</span> ping_stats<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> proc <span class="punctuation">=</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">create_process</span><span class="punctuation">(</span>
        <span class="punctuation">({</span><span class="string">"ping"</span><span class="punctuation">,</span> <span class="string">"-c"</span><span class="punctuation">,</span> <span class="string">"10"</span><span class="punctuation">,</span> host<span class="punctuation">})</span>
    <span class="punctuation">);</span>
    
    <span class="type">string</span> output <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">proc</span><span class="punctuation">-></span><span class="function-name">wait</span><span class="punctuation">());</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Extract statistics</span>
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sscanf</span><span class="punctuation">(</span>output<span class="punctuation">,</span> <span class="string">"%*smin/avg/max/mdev = %f/%f/%f/%f ms"</span><span class="punctuation">,</span>
               <span class="keyword">float</span> min_time<span class="punctuation">,</span> <span class="keyword">float</span> avg_time<span class="punctuation">,</span> 
               <span class="keyword">float</span> max_time<span class="punctuation">,</span> <span class="keyword">float</span> mdev<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">4</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Ping statistics for %s:\n"</span><span class="punctuation">,</span> host<span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  Min: %.2f ms\n"</span><span class="punctuation">,</span> min_time<span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  Avg: %.2f ms\n"</span><span class="punctuation">,</span> avg_time<span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  Max: %.2f ms\n"</span><span class="punctuation">,</span> max_time<span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  Mdev: %.2f ms\n"</span><span class="punctuation">,</span> mdev<span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> TCP ping (port check) - more reliable than ICMP</span>
<span class="keyword">async</span> <span class="type">void</span> tcp_ping<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">int</span> port<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> con <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">();</span>
    
    <span class="keyword">mixed</span> err <span class="punctuation">=</span> <span class="keyword">catch</span> <span class="punctuation">{</span>
        <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">con</span><span class="punctuation">-></span><span class="function-name">async_connect</span><span class="punctuation">(</span>host<span class="punctuation">,</span> port<span class="punctuation">));</span>
    <span class="punctuation">};</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span>err<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">werror</span><span class="punctuation">(</span><span class="string">"Port %d closed on %s\n"</span><span class="punctuation">,</span> port<span class="punctuation">,</span> host<span class="punctuation">);</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Port %d open on %s\n"</span><span class="punctuation">,</span> port<span class="punctuation">,</span> host<span class="punctuation">);</span>
        <span class="function-name">con</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Check multiple hosts concurrently</span>
<span class="keyword">async</span> <span class="type">void</span> ping_multiple<span class="punctuation">(</span><span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> hosts<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">Future</span><span class="punctuation">)</span> pings <span class="punctuation">=</span> <span class="function-name">map</span><span class="punctuation">(</span>hosts<span class="punctuation">,</span> <span class="keyword">lambda</span><span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">object</span> proc <span class="punctuation">=</span> <span class="function-name">Process</span><span class="punctuation">.</span><span class="function-name">create_process</span><span class="punctuation">(</span>
            <span class="punctuation">({</span><span class="string">"ping"</span><span class="punctuation">,</span> <span class="string">"-c"</span><span class="punctuation">,</span> <span class="string">"1"</span><span class="punctuation">,</span> <span class="string">"-W"</span><span class="punctuation">,</span> <span class="string">"1"</span><span class="punctuation">,</span> host<span class="punctuation">})</span>
        <span class="punctuation">);</span>
        <span class="keyword">return</span> <span class="function-name">proc</span><span class="punctuation">-></span><span class="function-name">wait</span><span class="punctuation">();</span>
    <span class="punctuation">});</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">Future</span><span class="punctuation">.</span><span class="function-name">all</span><span class="punctuation">(</span>pings<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"All pings completed\n"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN999"
>Using Whois to Retrieve Information from the InterNIC</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.8: Whois Queries - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="comment-delimiter">//</span><span class="comment"> Basic whois query</span>
<span class="keyword">async</span> <span class="type">void</span> whois_query<span class="punctuation">(</span><span class="type">string</span> domain<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> whois <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">async_connect</span><span class="punctuation">(</span><span class="string">"whois.iana.org"</span><span class="punctuation">,</span> <span class="number">43</span><span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">write</span><span class="punctuation">(</span>domain <span class="punctuation">+</span> <span class="string">"\r\n"</span><span class="punctuation">));</span>
    
    <span class="type">string</span> response <span class="punctuation">=</span> <span class="string">""</span><span class="punctuation">;</span>
    <span class="type">string</span> line<span class="punctuation">;</span>
    <span class="keyword">while</span> <span class="punctuation">(</span>line <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">readline</span><span class="punctuation">()))</span> <span class="punctuation">{</span>
        response <span class="punctuation">+=</span> line <span class="punctuation">+</span> <span class="string">"\n"</span><span class="punctuation">;</span>
    <span class="punctuation">}</span>
    
    <span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Whois info for %s:\n%s\n"</span><span class="punctuation">,</span> domain<span class="punctuation">,</span> response<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Query specific whois server</span>
<span class="keyword">async</span> <span class="type">void</span> whois_server<span class="punctuation">(</span><span class="type">string</span> server<span class="punctuation">,</span> <span class="type">string</span> query<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> whois <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">async_connect</span><span class="punctuation">(</span>server<span class="punctuation">,</span> <span class="number">43</span><span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">write</span><span class="punctuation">(</span>query <span class="punctuation">+</span> <span class="string">"\r\n"</span><span class="punctuation">));</span>
    
    <span class="type">string</span> response <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">read</span><span class="punctuation">());</span>
    <span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
    
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Response from %s:\n%s\n"</span><span class="punctuation">,</span> server<span class="punctuation">,</span> response<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Parse whois data for domain info</span>
<span class="keyword">async</span> <span class="type">void</span> whois_domain_info<span class="punctuation">(</span><span class="type">string</span> domain<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> whois <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">File</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">async_connect</span><span class="punctuation">(</span><span class="string">"whois.iana.org"</span><span class="punctuation">,</span> <span class="number">43</span><span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">write</span><span class="punctuation">(</span>domain <span class="punctuation">+</span> <span class="string">"\r\n"</span><span class="punctuation">));</span>
    
    <span class="type">string</span> response <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">read</span><span class="punctuation">());</span>
    <span class="function-name">whois</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Extract key information</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> info <span class="punctuation">=</span> <span class="punctuation">([]);</span>
    
    <span class="keyword">foreach</span><span class="punctuation">(</span><span class="function-name">response</span><span class="punctuation">/</span><span class="string">"\n"</span><span class="punctuation">;</span> <span class="type">string</span> line<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">sscanf</span><span class="punctuation">(</span>line<span class="punctuation">,</span> <span class="string">"%[A-Za-z]:%s"</span><span class="punctuation">,</span> <span class="type">string</span> key<span class="punctuation">,</span> <span class="type">string</span> value<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">2</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            info<span class="punctuation">[</span><span class="function-name">lower_case</span><span class="punctuation">(</span>key<span class="punctuation">)]</span> <span class="punctuation">=</span> <span class="function-name">trim_whites</span><span class="punctuation">(</span>value<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
    
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Domain: %s\n"</span><span class="punctuation">,</span> info<span class="punctuation">-&gt;</span>domain <span class="punctuation">||</span> <span class="string">"Unknown"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Registrar: %s\n"</span><span class="punctuation">,</span> info<span class="punctuation">-&gt;</span>registrar <span class="punctuation">||</span> <span class="string">"Unknown"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Created: %s\n"</span><span class="punctuation">,</span> info<span class="punctuation">-&gt;created <span class="punctuation">||</span> <span class="string">"Unknown"</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Expires: %s\n"</span><span class="punctuation">,</span> info<span class="punctuation">-&gt;expires <span class="punctuation">||</span> <span class="string">"Unknown"</span><span class="punctuation">);</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1002"
>HTTP Client Requests with Protocols.HTTP</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.9: HTTP Client with Protocols.HTTP - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">HTTP</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> Simple GET request</span>
<span class="keyword">async</span> <span class="type">void</span> http_get<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_method</span><span class="punctuation">(</span><span class="string">"GET"</span><span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">()</span> <span class="punctuation">==</span> <span class="number">200</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> body <span class="punctuation">=</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">get_response</span><span class="punctuation">();</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Response: %s\n"</span><span class="punctuation">,</span> body<span class="punctuation">[</span><span class="number">0</span><span class="punctuation">..</span><span class="number">99</span><span class="punctuation">]);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> GET with custom headers</span>
<span class="keyword">async</span> <span class="type">void</span> http_get_headers<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_method</span><span class="punctuation">(</span><span class="string">"GET"</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Add custom headers</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_http_headers</span><span class="punctuation">(([</span>
        <span class="string">"User-Agent"</span><span class="punctuation">:</span> <span class="string">"Pike/8.0 HTTP Client"</span><span class="punctuation">,</span>
        <span class="string">"Accept"</span><span class="punctuation">:</span> <span class="string">"application/json"</span><span class="punctuation">,</span>
        <span class="string">"Accept-Encoding"</span><span class="punctuation">:</span> <span class="string">"gzip, deflate"</span><span class="punctuation">,</span>
    <span class="punctuation">]));</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: %d\n"</span><span class="punctuation">,</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> POST request with JSON data</span>
<span class="keyword">async</span> <span class="type">void</span> http_post_json<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">,</span> <span class="type">mapping</span> data<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_method</span><span class="punctuation">(</span><span class="string">"POST"</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Convert mapping to JSON</span>
    <span class="type">string</span> json_body <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">encode</span><span class="punctuation">(</span>data<span class="punctuation">);</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_body</span><span class="punctuation">(</span>json_body<span class="punctuation">);</span>
    
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_http_headers</span><span class="punctuation">(([</span>
        <span class="string">"Content-Type"</span><span class="punctuation">:</span> <span class="string">"application/json"</span><span class="punctuation">,</span>
        <span class="string">"Accept"</span><span class="punctuation">:</span> <span class="string">"application/json"</span><span class="punctuation">,</span>
    <span class="punctuation">]));</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">()</span> <span class="punctuation">==</span> <span class="number">200</span> <span class="punctuation">||</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">()</span> <span class="punctuation">==</span> <span class="number">201</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> response <span class="punctuation">=</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">get_response</span><span class="punctuation">();</span>
        <span class="type">mapping</span> json_data <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">decode</span><span class="punctuation">(</span>response<span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Response: %O\n"</span><span class="punctuation">,</span> json_data<span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> POST form data</span>
<span class="keyword">async</span> <span class="type">void</span> http_post_form<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">,</span> <span class="type">mapping</span> form_data<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_method</span><span class="punctuation">(</span><span class="string">"POST"</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> URL-encode form data</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> pairs <span class="punctuation">=</span> <span class="punctuation">({});</span>
    <span class="keyword">foreach</span><span class="punctuation">(</span>form_data<span class="punctuation">;</span> <span class="type">string</span> key<span class="punctuation">;</span> <span class="type">string</span> value<span class="punctuation">)</span> <span class="punctuation">{</span>
        pairs <span class="punctuation">+=</span> <span class="punctuation">({</span><span class="function-name">http_encode_url</span><span class="punctuation">(</span>key<span class="punctuation">)</span> <span class="punctuation">+</span> <span class="string">"="</span> <span class="punctuation">+</span> 
                     <span class="function-name">http_encode_url</span><span class="punctuation">(</span>value<span class="punctuation">)</span><span class="punctuation">});</span>
    <span class="punctuation">}</span>
    <span class="type">string</span> body <span class="punctuation">=</span> pairs<span class="punctuation">*</span><span class="string">"&amp;"</span><span class="punctuation">;</span>
    
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_body</span><span class="punctuation">(</span>body<span class="punctuation">);</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_http_headers</span><span class="punctuation">(([</span>
        <span class="string">"Content-Type"</span><span class="punctuation">:</span> <span class="string">"application/x-www-form-urlencoded"</span><span class="punctuation">,</span>
    <span class="punctuation">]));</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: %d\n"</span><span class="punctuation">,</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Multipart file upload</span>
<span class="keyword">async</span> <span class="type">void</span> http_upload_file<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">,</span> <span class="type">string</span> filepath<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_method</span><span class="punctuation">(</span><span class="string">"POST"</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Create multipart body</span>
    <span class="type">string</span> boundary <span class="punctuation">=</span> <span class="string">"----PikeBoundary"</span> <span class="punctuation">+</span> <span class="function-name">String</span><span class="punctuation">.</span><span class="function-name">string2hex</span><span class="punctuation">(</span><span class="function-name">random_string</span><span class="punctuation">(</span><span class="number">16</span><span class="punctuation">));</span>
    <span class="type">string</span> filename <span class="punctuation">=</span> <span class="function-name">basename</span><span class="punctuation">(</span>filepath<span class="punctuation">);</span>
    <span class="type">string</span> data <span class="punctuation">=</span> <span class="function-name">Stdio</span><span class="punctuation">.</span><span class="function-name">read_file</span><span class="punctuation">(</span>filepath<span class="punctuation">);</span>
    
    <span class="type">string</span> body <span class="punctuation">=</span> <span class="function-name">sprintf</span><span class="punctuation">(</span>
        <span class="string">"--%s\r\n"</span>
        <span class="string">"Content-Disposition: form-data; name=\"file\"; filename=\"%s\"\r\n"</span>
        <span class="string">"Content-Type: application/octet-stream\r\n\r\n"</span>
        <span class="string">"%s\r\n"</span>
        <span class="string">"--%s--\r\n"</span><span class="punctuation">,</span>
        boundary<span class="punctuation">,</span> filename<span class="punctuation">,</span> data<span class="punctuation">,</span> boundary
    <span class="punctuation">);</span>
    
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_body</span><span class="punctuation">(</span>body<span class="punctuation">);</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_http_headers</span><span class="punctuation">(([</span>
        <span class="string">"Content-Type"</span><span class="punctuation">:</span> <span class="string">"multipart/form-data; boundary="</span> <span class="punctuation">+</span> boundary<span class="punctuation">,</span>
    <span class="punctuation">]));</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Upload status: %d\n"</span><span class="punctuation">,</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Handle redirects automatically</span>
<span class="keyword">async</span> <span class="type">void</span> http_follow_redirects<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_follow_redirects</span><span class="punctuation">(</span><span class="number">5</span><span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Final URL: %s\n"</span><span class="punctuation">,</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">final_url</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> HTTP Basic Authentication</span>
<span class="keyword">async</span> <span class="type">void</span> http_basic_auth<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">,</span> <span class="type">string</span> user<span class="punctuation">,</span> <span class="type">string</span> pass<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set basic auth header</span>
    <span class="type">string</span> credentials <span class="punctuation">=</span> user <span class="punctuation">+</span> <span class="string">":"</span> <span class="punctuation">+</span> pass<span class="punctuation">;</span>
    <span class="type">string</span> encoded <span class="punctuation">=</span> <span class="function-name">MIME</span><span class="punctuation">.</span><span class="function-name">encode_base64</span><span class="punctuation">(</span>credentials<span class="punctuation">);</span>
    
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_http_headers</span><span class="punctuation">(([</span>
        <span class="string">"Authorization"</span><span class="punctuation">:</span> <span class="string">"Basic "</span> <span class="punctuation">+</span> encoded<span class="punctuation">,</span>
    <span class="punctuation">]));</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Auth status: %d\n"</span><span class="punctuation">,</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">());</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1005"
>JSON and XML Processing</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.10: JSON and XML Processing - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Standards</span><span class="punctuation">.</span><span class="module">JSON</span><span class="punctuation">;</span>
<span class="keyword">import</span> <span class="module">Standards</span><span class="punctuation">.</span><span class="module">XML</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> JSON Encoding</span>
<span class="keyword">void</span> json_encode_example<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">//</span><span class="comment"> Encode mapping to JSON</span>
    <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">mixed</span><span class="punctuation">)</span> data <span class="punctuation">=</span> <span class="punctuation">(</span><span class="punctuation">[</span>
        <span class="string">"name"</span><span class="punctuation">:</span> <span class="string">"John Doe"</span><span class="punctuation">,</span>
        <span class="string">"age"</span><span class="punctuation">:</span> <span class="number">30</span><span class="punctuation">,</span>
        <span class="string">"email"</span><span class="punctuation">:</span> <span class="string">"john@example.com"</span><span class="punctuation">,</span>
        <span class="string">"active"</span><span class="punctuation">:</span> <span class="keyword">true</span><span class="punctuation">,</span>
        <span class="string">"tags"</span><span class="punctuation">:</span> <span class="punctuation">({</span><span class="string">"pike"</span><span class="punctuation">,</span> <span class="string">"programming"</span><span class="punctuation">,</span> <span class="string">"http"</span><span class="punctuation">}),</span>
    <span class="punctuation">]);</span>
    
    <span class="type">string</span> json <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">encode</span><span class="punctuation">(</span>data<span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"JSON output:\n%s\n"</span><span class="punctuation">,</span> json<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> JSON Decoding</span>
<span class="keyword">void</span> json_decode_example<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> json <span class="punctuation">=</span> <span class="string">'{"name":"Jane","age":25,"skills":["Pike","C"]}'</span><span class="punctuation">;</span>
    
    <span class="keyword">mixed</span> data <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">decode</span><span class="punctuation">(</span>json<span class="punctuation">);</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">mappingp</span><span class="punctuation">(</span>data<span class="punctuation">))</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Name: %s\n"</span><span class="punctuation">,</span> data<span class="punctuation">-&gt;</span>name<span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Age: %d\n"</span><span class="punctuation">,</span> data<span class="punctuation">-&gt;</span>age<span class="punctuation">);</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Skills: %s\n"</span><span class="punctuation">,</span> data<span class="punctuation">-&gt;</span>skills<span class="punctuation">*</span><span class="string">", "</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Pretty-print JSON</span>
<span class="keyword">void</span> json_pretty_print<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">mapping</span> data <span class="punctuation">=</span> <span class="punctuation">([</span><span class="string">"user"</span><span class="punctuation">:</span> <span class="string">"Alice"</span><span class="punctuation">,</span> <span class="string">"id"</span><span class="punctuation">:</span> <span class="number">123</span><span class="punctuation">]);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Encode with formatting</span>
    <span class="type">string</span> json <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">encode</span><span class="punctuation">(</span>data<span class="punctuation">,</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">PRETTY</span><span class="punctuation">);</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"%s\n"</span><span class="punctuation">,</span> json<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Handle JSON errors</span>
<span class="keyword">void</span> json_error_handling<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> invalid_json <span class="punctuation">=</span> <span class="string">'{"name": "Bob", "age":}'</span><span class="punctuation">;</span>
    
    <span class="keyword">mixed</span> err <span class="punctuation">=</span> <span class="keyword">catch</span> <span class="punctuation">{</span>
        <span class="keyword">mixed</span> data <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">decode</span><span class="punctuation">(</span>invalid_json<span class="punctuation">);</span>
    <span class="punctuation">};</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span>err<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">werror</span><span class="punctuation">(</span><span class="string">"JSON parse error: %s\n"</span><span class="punctuation">,</span> <span class="function-name">describe_error</span><span class="punctuation">(</span>err<span class="punctuation">));</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> XML Parsing (DOM)</span>
<span class="keyword">void</span> xml_parse_dom<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> xml <span class="punctuation">=</span> <span class="string">#"linet;people&gt;
        &lt;person id="1"&gt;
            &lt;name&gt;Alice&lt;/name&gt;
            &lt;age&gt;30&lt;/age&gt;
        &lt;/person&gt;
        &lt;person id="2"&gt;
            &lt;name&gt;Bob&lt;/name&gt;
            &lt;age&gt;25&lt;/age&gt;
        &lt;/person&gt;
    &lt;/people&gt;"</span><span class="punctuation">;</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Parse XML</span>
    <span class="type">object</span> parser <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">XML</span><span class="punctuation">.</span><span class="function-name">make_parser</span><span class="punctuation">();</span>
    <span class="type">object</span> tree <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">XML</span><span class="punctuation">.</span><span class="function-name">parse</span><span class="punctuation">(</span>xml<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Extract data</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">object</span><span class="punctuation">)</span> people <span class="punctuation">=</span> <span class="function-name"> Standards.XML.xpath</span><span class="punctuation">(</span>tree<span class="punctuation">,</span> <span class="string">"//person"</span><span class="punctuation">);</span>
    
    <span class="keyword">foreach</span><span class="punctuation">(</span>people<span class="punctuation">;</span> <span class="type">object</span> person<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> name <span class="punctuation">=</span> <span class="function-name"> Standards.XML.xpath</span><span class="punctuation">(</span>person<span class="punctuation">,</span> <span class="string">"name/text()"</span><span class="punctuation">)[</span><span class="number">0</span><span class="punctuation">];</span>
        <span class="type">string</span> age <span class="punctuation">=</span> <span class="function-name"> Standards.XML.xpath</span><span class="punctuation">(</span>person<span class="punctuation">,</span> <span class="string">"age/text()"</span><span class="punctuation">)[</span><span class="number">0</span><span class="punctuation">];</span>
        <span class="type">string</span> id <span class="punctuation">=</span> person<span class="punctuation">-></span><span class="function-name">get_attributes</span><span class="punctuation">()-></span>id<span class="punctuation">;</span>
        
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Person %s: %s, %s years old\n"</span><span class="punctuation">,</span> id<span class="punctuation">,</span> name<span class="punctuation">,</span> age<span class="punctuation">);</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> XML Generation</span>
<span class="keyword">void</span> xml_generate<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">//</span><span class="comment"> Create XML structure</span>
    <span class="type">object</span> root <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">XML</span><span class="punctuation">.</span><span class="function-name">parse</span><span class="punctuation">(</span><span class="string">"&lt;root/&gt;"</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Add child elements</span>
    <span class="type">object</span> item <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">XML</span><span class="punctuation">.</span><span class="function-name">parse</span><span class="punctuation">(</span><span class="string">"&lt;item&gt;data&lt;/item&gt;"</span><span class="punctuation">);</span>
    <span class="function-name">root</span><span class="punctuation">-></span><span class="function-name">add_child</span><span class="punctuation">(</span>item<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Output XML</span>
    <span class="type">string</span> xml <span class="punctuation">=</span> <span class="function-name">root</span><span class="punctuation">-></span><span class="function-name">render_xml</span><span class="punctuation">();</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Generated XML:\n%s\n"</span><span class="punctuation">,</span> xml<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> XML SAX Parser (streaming)</span>
<span class="keyword">void</span> xml_sax_parse<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> xml <span class="punctuation">=</span> <span class="string">'&lt;items&gt;&lt;item&gt;A&lt;/item&gt;&lt;item&gt;B&lt;/item&gt;&lt;/items&gt;'</span><span class="punctuation">;</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Create SAX parser</span>
    <span class="type">object</span> parser <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">XML</span><span class="punctuation">.</span><span class="function-name">Simple</span><span class="punctuation">.</span><span class="function-name">SAXParser</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set handlers</span>
    <span class="function-name">parser</span><span class="punctuation">-></span><span class="function-name">set_element_handler</span><span class="punctuation">(</span>
        <span class="keyword">lambda</span><span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">,</span> <span class="type">mapping</span> attrs<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Start element: %s\n"</span><span class="punctuation">,</span> name<span class="punctuation">);</span>
        <span class="punctuation">},</span>
        <span class="keyword">lambda</span><span class="punctuation">(</span><span class="type">string</span> name<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"End element: %s\n"</span><span class="punctuation">,</span> name<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">);</span>
    
    <span class="function-name">parser</span><span class="punctuation">-></span><span class="function-name">set_data_handler</span><span class="punctuation">(</span><span class="keyword">lambda</span><span class="punctuation">(</span><span class="type">string</span> data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">String.trim_whites</span><span class="punctuation">(</span>data<span class="punctuation">)</span> <span class="punctuation">!=</span> <span class="string">""</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Data: %s\n"</span><span class="punctuation">,</span> data<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">});</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Parse</span>
    <span class="function-name">parser</span><span class="punctuation">-></span><span class="function-name">parse</span><span class="punctuation">(</span>xml<span class="punctuation">);</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> XML Namespaces</span>
<span class="keyword">void</span> xml_namespaces<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">string</span> xml <span class="punctuation">=</span> <span class="string">#"linet;root xmlns:ns="http://example.com"&gt;
        &lt;ns:item&gt;data&lt;/ns:item&gt;
    &lt;/root&gt;"</span><span class="punctuation">;</span>
    
    <span class="type">object</span> tree <span class="punctuation">=</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">XML</span><span class="punctuation">.</span><span class="function-name">parse</span><span class="punctuation">(</span>xml<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Query with namespace</span>
    <span class="type">array</span> items <span class="punctuation">=</span> <span class="function-name"> Standards.XML.xpath</span><span class="punctuation">(</span>tree<span class="punctuation">,</span> 
        <span class="string">"//ns:item"</span><span class="punctuation">,</span>
        <span class="punctuation">([</span><span class="string">"ns"</span><span class="punctuation">:</span> <span class="string">"http://example.com"</span><span class="punctuation">])</span>
    <span class="punctuation">);</span>
    
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Found %d items\n"</span><span class="punctuation">,</span> <span class="keyword">sizeof</span><span class="punctuation">(</span>items<span class="punctuation">));</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1008"
>RESTful API Consumption</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.11: RESTful API Client - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">HTTP</span><span class="punctuation">;</span>
<span class="keyword">import</span> <span class="module">Standards</span><span class="punctuation">.</span><span class="module">JSON</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> REST API Client class</span>
<span class="keyword">class</span> <span class="function-name">RestClient</span> <span class="punctuation">{</span>
    <span class="keyword">private</span> <span class="type">string</span> base_url<span class="punctuation">;</span>
    <span class="keyword">private</span> <span class="type">mapping</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">:</span><span class="type">string</span><span class="punctuation">)</span> headers<span class="punctuation">;</span>
    <span class="keyword">private</span> <span class="type">string</span> api_key<span class="punctuation">;</span>
    
    <span class="keyword">void</span> create<span class="punctuation">(</span><span class="type">string</span> _base_url<span class="punctuation">,</span> <span class="type">void</span>|<span class="type">string</span> _api_key<span class="punctuation">)</span> <span class="punctuation">{</span>
        base_url <span class="punctuation">=</span> _base_url<span class="punctuation">;</span>
        api_key <span class="punctuation">=</span> _api_key<span class="punctuation">;</span>
        headers <span class="punctuation">=</span> <span class="punctuation">([</span>
            <span class="string">"Accept"</span><span class="punctuation">:</span> <span class="string">"application/json"</span><span class="punctuation">,</span>
            <span class="string">"User-Agent"</span><span class="punctuation">:</span> <span class="string">"Pike/8.0 REST Client"</span><span class="punctuation">,</span>
        <span class="punctuation">]);</span>
        
        <span class="keyword">if</span> <span class="punctuation">(</span>api_key<span class="punctuation">)</span> <span class="punctuation">{</span>
            headers<span class="punctuation">[</span><span class="string">"Authorization"</span><span class="punctuation">]</span> <span class="punctuation">=</span> <span class="string">"Bearer "</span> <span class="punctuation">+</span> api_key<span class="punctuation">;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Generic request method</span>
    <span class="keyword">async</span> <span class="keyword">private</span> <span class="type">mapping</span> request<span class="punctuation">(</span><span class="type">string</span> method<span class="punctuation">,</span> <span class="type">string</span> endpoint<span class="punctuation">,</span>
                                 <span class="type">void</span>|<span class="keyword">mixed</span> body<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">string</span> url <span class="punctuation">=</span> base_url <span class="punctuation">+</span> endpoint<span class="punctuation">;</span>
        
        <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
        <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_method</span><span class="punctuation">(</span>method<span class="punctuation">);</span>
        <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_http_headers</span><span class="punctuation">(</span>headers<span class="punctuation">);</span>
        <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_follow_redirects</span><span class="punctuation">(</span><span class="number">5</span><span class="punctuation">);</span>
        
        <span class="keyword">if</span> <span class="punctuation">(</span>body<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="keyword">if</span> <span class="punctuation">(</span><span class="function-name">mappingp</span><span class="punctuation">(</span>body<span class="punctuation">))</span> <span class="punctuation">{</span>
                <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_http_headers</span><span class="punctuation">(([</span>
                    <span class="string">"Content-Type"</span><span class="punctuation">:</span> <span class="string">"application/json"</span><span class="punctuation">,</span>
                <span class="punctuation">]));</span>
                <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_body</span><span class="punctuation">(</span><span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">encode</span><span class="punctuation">(</span>body<span class="punctuation">));</span>
            <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
                <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_body</span><span class="punctuation">(</span>body<span class="punctuation">);</span>
            <span class="punctuation">}</span>
        <span class="punctuation">}</span>
        
        <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
        <span class="type">int</span> status <span class="punctuation">=</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">();</span>
        
        <span class="keyword">if</span> <span class="punctuation">(</span>status <span class="punctuation">&gt;=</span> <span class="number">200</span> <span class="punctuation">&amp;&amp;</span> status <span class="punctuation">&lt;</span> <span class="number">300</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">string</span> response <span class="punctuation">=</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">get_response</span><span class="punctuation">();</span>
            <span class="keyword">return</span> <span class="punctuation">([</span>
                <span class="string">"status"</span><span class="punctuation">:</span> status<span class="punctuation">,</span>
                <span class="string">"data"</span><span class="punctuation">:</span> <span class="function-name">Standards</span><span class="punctuation">.</span><span class="function-name">JSON</span><span class="punctuation">.</span><span class="function-name">decode</span><span class="punctuation">(</span>response<span class="punctuation">),</span>
            <span class="punctuation">]);</span>
        <span class="punctuation">}</span>
        
        <span class="keyword">return</span> <span class="punctuation">([</span>
            <span class="string">"status"</span><span class="punctuation">:</span> status<span class="punctuation">,</span>
            <span class="string">"error"</span><span class="punctuation">:</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">get_response</span><span class="punctuation">(),</span>
        <span class="punctuation">]);</span>
    <span class="punctuation">}</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> GET request</span>
    <span class="keyword">async</span> <span class="type">mapping</span> get<span class="punctuation">(</span><span class="type">string</span> endpoint<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">request</span><span class="punctuation">(</span><span class="string">"GET"</span><span class="punctuation">,</span> endpoint<span class="punctuation">));</span>
    <span class="punctuation">}</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> POST request</span>
    <span class="keyword">async</span> <span class="type">mapping</span> post<span class="punctuation">(</span><span class="type">string</span> endpoint<span class="punctuation">,</span> <span class="type">mapping</span> data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">request</span><span class="punctuation">(</span><span class="string">"POST"</span><span class="punctuation">,</span> endpoint<span class="punctuation">,</span> data<span class="punctuation">));</span>
    <span class="punctuation">}</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> PUT request</span>
    <span class="keyword">async</span> <span class="type">mapping</span> put<span class="punctuation">(</span><type">string</span> endpoint<span class="punctuation">,</span> <span class="type">mapping</span> data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">request</span><span class="punctuation">(</span><span class="string">"PUT"</span><span class="punctuation">,</span> endpoint<span class="punctuation">,</span> data<span class="punctuation">));</span>
    <span class="punctuation">}</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> DELETE request</span>
    <span class="keyword">async</span> <span class="type">mapping</span> delete<span class="punctuation">(</span><span class="type">string</span> endpoint<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">request</span><span class="punctuation">(</span><span class="string">"DELETE"</span><span class="punctuation">,</span> endpoint<span class="punctuation">));</span>
    <span class="punctuation">}</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> PATCH request</span>
    <span class="keyword">async</span> <span class="type">mapping</span> patch<span class="punctuation">(</span><span class="type">string</span> endpoint<span class="punctuation">,</span> <span class="type">mapping</span> data<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">return</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">request</span><span class="punctuation">(</span><span class="string">"PATCH"</span><span class="punctuation">,</span> endpoint<span class="punctuation">,</span> data<span class="punctuation">));</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Usage examples</span>
<span class="keyword">async</span> <span class="type">void</span> rest_example<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="comment-delimiter">//</span><span class="comment"> Create client</span>
    <span class="type">object</span> api <span class="punctuation">=</span> <span class="function-name">RestClient</span><span class="punctuation">(</span><span class="string">"https://api.example.com"</span><span class="punctuation">,</span> <span class="string">"api-key"</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> GET request</span>
    <span class="type">mapping</span> users <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">api</span><span class="punctuation">-></span><span class="function-name">get</span><span class="punctuation">(</span><span class="string">"/users"</span><span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Users: %O\n"</span><span class="punctuation">,</span> users<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> POST request</span>
    <span class="type">mapping</span> new_user <span class="punctuation">=</span> <span class="punctuation">([</span>
        <span class="string">"name"</span><span class="punctuation">:</span> <span class="string">"Alice"</span><span class="punctuation">,</span>
        <span class="string">"email"</span><span class="punctuation">:</span> <span class="string">"alice@example.com"</span><span class="punctuation">,</span>
    <span class="punctuation">]);</span>
    <span class="type">mapping</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">api</span><span class="punctuation">-></span><span class="function-name">post</span><span class="punctuation">(</span><span class="string">"/users"</span><span class="punctuation">,</span> new_user<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Created: %O\n"</span><span class="punctuation">,</span> result<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> PUT request</span>
    <span class="type">mapping</span> updated <span class="punctuation">=</span> <span class="punctuation">([</span><span class="string">"name"</span><span class="punctuation">:</span> <span class="string">"Alice Smith"</span><span class="punctuation">]);</span>
    result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">api</span><span class="punctuation">-></span><span class="function-name">put</span><span class="punctuation">(</span><span class="string">"/users/1"</span><span class="punctuation">,</span> updated<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> DELETE request</span>
    result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><function-name">api</span><span class="punctuation">-></span><span class="function-name">delete</span><span class="punctuation">(</span><span class="string">"/users/1"</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Pagination handling</span>
<span class="keyword">async</span> <span class="type">void</span> rest_pagination<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> api <span class="punctuation">=</span> <span class="function-name">RestClient</span><span class="punctuation">(</span><span class="string">"https://api.example.com"</span><span class="punctuation">);</span>
    
    <span class="type">array</span><span class="punctuation">(</span><span class="type">mapping</span><span class="punctuation">)</span> all_items <span class="punctuation">=</span> <span class="punctuation">({});</span>
    <span class="type">int</span> page <span class="punctuation">=</span> <span class="number">1</span><span class="punctuation">;</span>
    <span class="type">int</span> per_page <span class="punctuation">=</span> <span class="number">100</span><span class="punctuation">;</span>
    
    <span class="keyword">while</span> <span class="punctuation">(</span><span class="number">1</span><span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="type">mapping</span> response <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">api</span><span class="punctuation">-></span><span class="function-name">get</span><span class="punctuation">(</span>
            <span class="string">"/items?page="</span> <span class="punctuation">+</span> page <span class="punctuation">+</span> <span class="string">"&amp;per_page="</span> <span class="punctuation">+</span> per_page
        <span class="punctuation">));</span>
        
        <span class="keyword">if</span> <span class="punctuation">(</span><span class="keyword">sizeof</span><span class="punctuation">(</span>response<span class="punctuation">-&gt;</span>data<span class="punctuation">)</span> <span class="punctuation">==</span> <span class="number">0</span><span class="punctuation">)</span> <span class="keyword">break</span><span class="punctuation">;</span>
        
        all_items <span class="punctuation">+=</span> response<span class="punctuation">-&gt;</span>data<span class="punctuation">;</span>
        page<span class="punctuation">++;</span>
    <span class="punctuation">}</span>
    
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Total items: %d\n"</span><span class="punctuation">,</span> <span class="keyword">sizeof</span><span class="punctuation">(</span>all_items<span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Error handling</span>
<span class="keyword">async</span> <span class="type">void</span> rest_with_retry<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> api <span class="punctuation">=</span> <span class="function-name">RestClient</span><span class="punctuation">(</span><span class="string">"https://api.example.com"</span><span class="punctuation">);</span>
    
    <span class="type">int</span> max_retries <span class="punctuation">=</span> <span class="number">3</span><span class="punctuation">;</span>
    <span class="type">mapping</span> response<span class="punctuation">;</span>
    
    <span class="keyword">for</span> <span class="punctuation">(</span><span class="type">int</span> i <span class="punctuation">=</span> <span class="number">0</span><span class="punctuation">;</span> i <span class="punctuation">&lt;</span> max_retries<span class="punctuation">;</span> i<span class="punctuation">++)</span> <span class="punctuation">{</span>
        response <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">api</span><span class="punctuation">-></span><span class="function-name">get</span><span class="punctuation">(</span><span class="string">"/data"</span><span class="punctuation">));</span>
        
        <span class="keyword">if</span> <span class="punctuation">(</span>response<span class="punctuation">-&gt;</span>status <span class="punctuation">&gt;=</span> <span class="number">200</span> <span class="punctuation">&amp;&amp;</span> response<span class="punctuation">-&gt;</span>status <span class="punctuation">&lt;</span> <span class="number">300</span><span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Success: %O\n"</span><span class="punctuation">,</span> response<span class="punctuation">-&gt;</span>data<span class="punctuation">);</span>
            <span class="keyword">return</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
        
        <span class="keyword">if</span> <span class="punctuation">(</span>response<span class="punctuation">-&gt;</span>status <span class="punctuation">==</span> <span class="number">429</span><span class="punctuation">)</span> <span class="punctuation">{</span>  <span class="comment-delimiter">//</span><span class="comment"> Rate limited</span>
            <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Rate limited, retrying...\n"</span><span class="punctuation">);</span>
            <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">Concurrent</span><span class="punctuation">.</span><span class="function-name">Future</span><span class="punctuation">.</span><span class="function-name">sleep</span><span class="punctuation">(</span><span class="number">2</span><span class="punctuation">));</span>
        <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
            <span class="function-name">werror</span><span class="punctuation">(</span><span class="string">"Error: %d %s\n"</span><span class="punctuation">,</span> 
                     response<span class="punctuation">-&gt;</span>status<span class="punctuation">,</span> response<span class="punctuation">-&gt;</span>error<span class="punctuation">);</span>
            <span class="keyword">break</span><span class="punctuation">;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1011"
>WebSocket Support</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.12: WebSocket Client and Server - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">WebSocket</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> WebSocket Server</span>
<span class="keyword">class</span> <span class="function-name">WebSocketServer</span> <span class="punctuation">{</span>
    <span class="keyword">private</span> <span class="type">object</span> server<span class="punctuation">;</span>
    <span class="keyword">private</span> <span class="type">array</span><span class="punctuation">(</span><span class="type">object</span><span class="punctuation">)</span> clients <span class="punctuation">=</span> <span class="punctuation">({});</span>
    
    <span class="keyword">void</span> create<span class="punctuation">(</span><span class="type">int</span> port<span class="punctuation">)</span> <span class="punctuation">{</span>
        server <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">WebSocket</span><span class="punctuation">.</span><span class="function-name">Server</span><span class="punctuation">();</span>
        <span class="function-name">server</span><span class="punctuation">-></span><span class="function-name">bind</span><span class="punctuation">(</span>port<span class="punctuation">);</span>
        <span class="function-name">server</span><span class="punctuation">-></span><span class="function-name">set_accept_callback</span><span class="punctuation">(</span>on_connect<span class="punctuation">);</span>
        <span class="function-name">server</span><span class="punctuation">-></span><span class="function-name">set_message_callback</span><span class="punctuation">(</span>on_message<span class="punctuation">);</span>
        <span class="function-name">server</span><span class="punctuation">-></span><span class="function-name">set_close_callback</span><span class="punctuation">(</span>on_close<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">void</span> on_connect<span class="punctuation">(</span><span class="type">object</span> client<span class="punctuation">)</span> <span class="punctuation">{</span>
        clients <span class="punctuation">+=</span> <span class="punctuation">({</span>client<span class="punctuation">});</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Client connected: %s\n"</span><span class="punctuation">,</span> client<span class="punctuation">-></span><span class="function-name">get_address</span><span class="punctuation">());</span>
        <span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">send</span><span class="punctuation">(</span><span class="string">"Welcome to WebSocket server!\n"</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">void</span> on_message<span class="punctuation">(</span><span class="type">object</span> client<span class="punctuation">,</span> <span class="type">string</span> message<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Message: %s\n"</span><span class="punctuation">,</span> message<span class="punctuation">);</span>
        
        <span class="comment-delimiter">//</span><span class="comment"> Echo back to all clients</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>clients<span class="punctuation">;</span> <span class="type">object</span> c<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">c</span><span class="punctuation">-></span><span class="function-name">send</span><span class="punctuation">(</span>message<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">void</span> on_close<span class="punctuation">(</span><span class="type">object</span> client<span class="punctuation">)</span> <span class="punctuation">{</span>
        clients <span class="punctuation">-=</span> <span class="punctuation">({</span>client<span class="punctuation">});</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Client disconnected\n"</span><span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">void</span> broadcast<span class="punctuation">(</span><span class="type">string</span> message<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>clients<span class="punctuation">;</span> <span class="type">object</span> client<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">send</span><span class="punctuation">(</span>message<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">void</span> start<span class="punctuation">()</span> <span class="punctuation">{</span>
        <span class="function-name">server</span><span class="punctuation">-></span><span class="function-name">run</span><span class="punctuation">();</span>
    <span class="punctuation">}</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> WebSocket Client</span>
<span class="keyword">async</span> <span class="type">void</span> websocket_client<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> ws <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">WebSocket</span><span class="punctuation">.</span><span class="function-name">Client</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Connect to server</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Connected to %s\n"</span><span class="punctuation">,</span> url<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send message</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">send</span><span class="punctuation">(</span><span class="string">"Hello, WebSocket!"</span><span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Receive message</span>
    <span class="type">string</span> response <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">receive</span><span class="punctuation">());</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Received: %s\n"</span><span class="punctuation">,</span> response<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Close connection</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> WebSocket with different frame types</span>
<span class="keyword">async</span> <span class="type">void</span> websocket_frames<span class="punctuation">(</span><span class="type">string</span> url<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="type">object</span> ws <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">WebSocket</span><span class="punctuation">.</span><span class="function-name">Client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>url<span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send text frame</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">send_text</span><span class="punctuation">(</span><span class="string">"Text message"</span><span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send binary frame</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">send_binary</span><span class="punctuation">(</span><span class="string">"binary data"</span><span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send ping</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">ping</span><span class="punctuation">());</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Receive with frame type info</span>
    <span class="type">mapping</span> frame <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">receive_frame</span><span class="punctuation">());</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Frame type: %s, Data: %s\n"</span><span class="punctuation">,</span> 
             frame<span class="punctuation">-&gt;</span>type<span class="punctuation">,</span> frame<span class="punctuation">-&gt;</span>data<span class="punctuation">);</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">ws</span><span class="punctuation">-></span><span class="function-name">close</span><span class="punctuation">());</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1014"
>HTTPS Certificate Handling and Proxy Configuration</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.13: HTTPS and SSL/TLS - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">HTTP</span><span class="punctuation">;</span>
<span class="keyword">import</span> <span class="module">SSL</span><span class="punctuation">;</span>

<span class="comment-delimiter">//</span><span class="comment"> HTTPS with default certificate validation</span>
<span class="keyword">async</span> <span class="type">void</span> https_basic<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_method</span><span class="punctuation">(</span><span class="string">"GET"</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> SSL context with default verification</span>
    <span class="type">object</span> ctx <span class="punctuation">=</span> <span class="function-name">SSL</span><span class="punctuation">.</span><span class="function-name">Context</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_ssl_context</span><span class="punctuation">(</span>ctx<span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"https://example.com"</span><span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Status: %d\n"</span><span class="punctuation">,</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Custom CA bundle</span>
<span class="keyword">async</span> <span class="type">void</span> https_custom_ca<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> ctx <span class="punctuation">=</span> <span class="function-name">SSL</span><span class="punctuation">.</span><span class="function-name">Context</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Load custom CA certificates</span>
    <span class="type">string</span> ca_file <span class="punctuation">=</span> <span class="string">"/etc/ssl/certs/ca-certificates.crt"</span><span class="punctuation">;</span>
    <span class="function-name">ctx</span><span class="punctuation">-></span><span class="function-name">load_verify_locations</span><span class="punctuation">(</span>ca_file<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Enable certificate verification</span>
    <span class="function-name">ctx</span><span class="punctuation">-></span><span class="function-name">set_verify</span><span class="punctuation">([</span><span class="string">"peer"</span><span class="punctuation">]);</span>
    
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_ssl_context</span><span class="punctuation">(</span>ctx<span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"https://example.com"</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Client certificate authentication</span>
<span class="keyword">async</span> <span class="type">void</span> https_client_cert<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> ctx <span class="punctuation">=</span> <span class="function-name">SSL</span><span class="punctuation">.</span><span class="function-name">Context</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Load client certificate and key</span>
    <span class="function-name">ctx</span><span class="punctuation">-></span><span class="function-name">load_certificate</span><span class="punctuation">(</span><span class="string">"client.crt"</span><span class="punctuation">,</span> <span class="string">"client.key"</span><span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set verification mode</span>
    <span class="function-name">ctx</span><span class="punctuation">-></span><span class="function-name">set_verify</span><span class="punctuation">([</span><span class="string">"peer"</span><span class="punctuation">,</span> <span class="string">"fail_if_no_peer_cert"</span><span class="punctuation">]);</span>
    
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_ssl_context</span><span class="punctuation">(</span>ctx<span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"https://secure.example.com"</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Disable certificate verification (NOT for production!)</span>
<span class="keyword">async</span> <span class="type">void</span> https_no_verify<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> ctx <span class="punctuation">=</span> <span class="function-name">SSL</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="function-name">Context</span><span class="punctuation">();</span>
    <span class="function-name">ctx</span><span class="punctuation">-></span><span class="function-name">set_verify</span><span class="punctuation">([]);</span>
    
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_ssl_context</span><span class="punctuation">(</span>ctx<span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"https://self-signed.example.com"</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> HTTP Proxy configuration</span>
<span class="keyword">async</span> <span class="type">void</span> http_proxy<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set HTTP proxy</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_proxy</span><span class="punctuation">(</span><span class="string">"proxy.example.com"</span><span class="punctuation">,</span> <span class="number">3128</span><span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"http://example.com"</span><span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Via proxy: %d\n"</span><span class="punctuation">,</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> HTTPS Proxy with CONNECT tunnel</span>
<span class="keyword">async</span> <span class="type">void</span> https_proxy<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="type">object</span> ctx <span class="punctuation">=</span> <span class="function-name">SSL</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="function-name">Context</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set HTTPS proxy</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_proxy</span><span class="punctuation">(</span><span class="string">"proxy.example.com"</span><span class="punctuation">,</span> <span class="number">3128</span><span class="punctuation">);</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_ssl_context</span><span class="punctuation">(</span>ctx<span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"https://example.com"</span><span class="punctuation">));</span>
    <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"HTTPS via proxy: %d\n"</span><span class="punctuation">,</span> <span class="function-name">result</span><span class="punctuation">-></span><span class="function-name">status</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Proxy with authentication</span>
<span class="keyword">async</span> <span class="type">void</span> proxy_auth<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set proxy with authentication</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_proxy</span><span class="punctuation">(</span><span class="string">"proxy.example.com"</span><span class="punctuation">,</span> <span class="number">3128</span><span class="punctuation">,</span> 
                     <span class="string">"proxyuser"</span><span class="punctuation">,</span> <span class="string">"proxypass"</span><span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"http://example.com"</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> SOCKS proxy</span>
<span class="keyword">async</span> <span class="type">void</span> socks_proxy<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set SOCKS5 proxy</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_socks_proxy</span><span class="punctuation">(</span><span class="string">"socks5://proxy.example.com:1080"</span><span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"http://example.com"</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> SSL/TLS session resumption (session tickets)</span>
<span class="keyword">async</span> <span class="type">void</span> tls_session_resumption<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> ctx <span class="punctuation">=</span> <span class="punctuation">.</span><span class="function-name">SSL</span><span class="punctuation">.</span><span class="function-name">Context</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Enable session tickets for faster TLS handshake</span>
    <span class="function-name">ctx</span><span class="punctuation">-></span><span class="function-name">enable_session_tickets</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Configure session cache</span>
    <span class="function-name">ctx</span><span class="punctuation">-></span><span class="function-name">set_session_cache</span><span class="punctuation">([</span><span class="string">"client"</span><span class="punctuation">,</span> <span class="string">"no_internal_store"</span><span class="punctuation">]);</span>
    
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_ssl_context</span><span class="punctuation">(</span>ctx<span class="punctuation">);</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> First request - full handshake</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"https://example.com"</span><span class="punctuation">));</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Subsequent requests - resumed session</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"https://example.com/data"</span><span class="punctuation">));</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> Certificate pinning</span>
<span class="keyword">async</span> <span class="type">void</span> certificate_pinning<span class="punctuation">()</span> <span class="punctuation">{</span>
    <span class="type">object</span> ctx <span class="punctuation">=</span> <span class="function-name">SSL</span><span class="punctuation">.</span><span class="punctuation">.</span><span class="function-name">Context</span><span class="punctuation">();</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Set expected certificate fingerprint</span>
    <span class="type">string</span> expected_fingerprint <span class="punctuation">=</span> 
        <span class="string">"AA:BB:CC:DD:..."</span><span class="punctuation">;</span>
    
    <span class="function-name">ctx</span><span class="punctuation">-></span><span class="function-name">set_verify_callback</span><span class="punctuation">(</span>
        <span class="keyword">lambda</span><span class="punctuation">(</span><span class="type">object</span> cert<span class="punctuation">,</span> <span class="type">int</span> err<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="type">string</span> fingerprint <span class="punctuation">=</span> <span class="function-name">cert</span><span class="punctuation">-></span><span class="function-name">get_fingerprint</span><span class="punctuation">();</span>
            <span class="keyword">return</span> fingerprint <span class="punctuation">==</span> expected_fingerprint<span class="punctuation">;</span>
        <span class="punctuation">}</span>
    <span class="punctuation">);</span>
    
    <span class="type">object</span> req <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">HTTP</span><span class="punctuation">.</span><span class="function-name">Request</span><span class="punctuation">();</span>
    <span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">set_ssl_context</span><span class="punctuation">(</span>ctx<span class="punctuation">);</span>
    
    <span class="type">object</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">req</span><span class="punctuation">-></span><span class="function-name">async_request</span><span class="punctuation">(</span><span class="string">"https://example.com"</span><span class="punctuation">));</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
><DIV
CLASS="SECT2"
><H2
CLASS="SECT2"
><A
NAME="AEN1017"
>Program: expn and vrfy</A
></H2
><TABLE
BORDER="0"
BGCOLOR="#2F4F4F"
WIDTH="100%"
><TR
><TD
><PRE
CLASS="SCREEN"
><font color="#f5deb3" size="+1"><span class="comment-delimiter"></span><span class="comment"></span><span class="comment-delimiter">// </span><span class="comment">Recipe 18.14: SMTP EXPN and VRFY Utilities - Pike 8</span>
<span class="comment-delimiter">//</span><span class="comment">----------------------------------------------------------</span>

<span class="comment-delimiter">//</span><span class="comment"> EXPN - Expand mailing list alias</span>
<span class="keyword">async</span> <span class="type">void</span> smtp_expn<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> alias<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">SMTP</span><span class="punctuation">;</span>
    
    <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">SMTP</span><span class="punctuation">.</span><span class="function-name">Client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">,</span> <span class="number">25</span><span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">ehlo</span><span class="punctuation">());</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send EXPN command</span>
    <span class="type">array</span><span class="punctuation">(</span><span class="type">string</span><span class="punctuation">)</span> members <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">expn</span><span class="punctuation">(</span>alias<span class="punctuation">));</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span>members<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Members of %s:\n"</span><span class="punctuation">,</span> alias<span class="punctuation">);</span>
        <span class="keyword">foreach</span><span class="punctuation">(</span>members<span class="punctuation">;</span> <span class="type">string</span> member<span class="punctuation">)</span> <span class="punctuation">{</span>
            <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"  %s\n"</span><span class="punctuation">,</span> member<span class="punctuation">);</span>
        <span class="punctuation">}</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="function-name">werror</span><span class="punctuation">(</span><span class="string">"EXPN failed for %s\n"</span><span class="punctuation">,</span> alias<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">quit</span><span class="punctuation">());</span>
<span class="punctuation">}</span>

<span class="comment-delimiter">//</span><span class="comment"> VRFY - Verify email address</span>
<span class="keyword">async</span> <span class="type">void</span> smtp_vrfy<span class="punctuation">(</span><span class="type">string</span> host<span class="punctuation">,</span> <span class="type">string</span> address<span class="punctuation">)</span> <span class="punctuation">{</span>
    <span class="keyword">import</span> <span class="module">Protocols</span><span class="punctuation">.</span><span class="module">SMTP</span><span class="punctuation">;</span>
    
    <span class="type">object</span> client <span class="punctuation">=</span> <span class="function-name">Protocols</span><span class="punctuation">.</span><span class="function-name">SMTP</span><span class="punctuation">.</span><span class="function-name">Client</span><span class="punctuation">();</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">connect</span><span class="punctuation">(</span>host<span class="punctuation">,</span> <span class="number">25</span><span class="punctuation">));</span>
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">ehlo</span><span class="punctuation">());</span>
    
    <span class="comment-delimiter">//</span><span class="comment"> Send VRFY command</span>
    <span class="type">string</span> result <span class="punctuation">=</span> <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">vrfy</span><span class="punctuation">(</span>address<span class="punctuation">));</span>
    
    <span class="keyword">if</span> <span class="punctuation">(</span>result<span class="punctuation">)</span> <span class="punctuation">{</span>
        <span class="function-name">write</span><span class="punctuation">(</span><span class="string">"Verified: %s -&gt; %s\n"</span><span class="punctuation">,</span> address<span class="punctuation">,</span> result<span class="punctuation">);</span>
    <span class="punctuation">}</span> <span class="keyword">else</span> <span class="punctuation">{</span>
        <span class="function-name">werror</span><span class="punctuation">(</span><span class="string">"VRFY failed for %s\n"</span><span class="punctuation">,</span> address<span class="punctuation">);</span>
    <span class="punctuation">}</span>
    
    <span class="keyword">await</span><span class="punctuation">(</span><span class="function-name">client</span><span class="punctuation">-></span><span class="function-name">quit</span><span class="punctuation">());</span>
<span class="punctuation">}</span>
</font></PRE
></TD
></TR
></TABLE
></DIV
></DIV
><DIV
CLASS="NAVFOOTER"
><HR
ALIGN="LEFT"
WIDTH="100%"><TABLE
SUMMARY="Footer navigation table"
WIDTH="100%"
BORDER="0"
CELLPADDING="0"
CELLSPACING="0"
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
><A
HREF="sockets.html"
ACCESSKEY="P"
>Prev</A
></TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
><A
HREF="index.html"
ACCESSKEY="H"
>Home</A
></TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
><A
HREF="cgiprogramming.html"
ACCESSKEY="N"
>Next</A
></TD
></TR
><TR
><TD
WIDTH="33%"
ALIGN="left"
VALIGN="top"
>Sockets</TD
><TD
WIDTH="34%"
ALIGN="center"
VALIGN="top"
>&nbsp;</TD
><TD
WIDTH="33%"
ALIGN="right"
VALIGN="top"
>CGI Programming</TD
></TR
></TABLE
></DIV
></BODY
></HTML>
